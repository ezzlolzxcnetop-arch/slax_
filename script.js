import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, addDoc, setDoc, doc, query, onSnapshot, serverTimestamp, getDocs, where, limit, deleteDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
const firebaseConfig = {
    apiKey: "AIzaSyC5IfNWuv-8lR5PGvM-5zXxLap3EVa6rDk",
    authDomain: "myconsolechat.firebaseapp.com",
    projectId: "myconsolechat",
    storageBucket: "myconsolechat.firebasestorage.app",
    messagingSenderId: "686599654568",
    appId: "1:686599654568:web:2c190df85c4f7780ca069d",
    measurementId: "G-7B38TF6NH7"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = 'slax-console-v1'; 

// WebRTC Config: –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–µ–¥–æ—Å—Ç—É–ø–Ω—ã–µ Google STUN-—Å–µ—Ä–≤–µ—Ä—ã
const iceServers = {
    iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
    ]
};

// --- –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Å–µ—Å—Å–∏–∏ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ ---
let localSessionId = sessionStorage.getItem('slax_session_id');
if (!localSessionId) {
    localSessionId = crypto.randomUUID();
    sessionStorage.setItem('slax_session_id', localSessionId);
}

// --- –°–û–°–¢–û–Ø–ù–ò–ï ---
let currentUser = null; 
let currentUsername = "GUEST"; 
let authMode = 'login'; 
let currentChannel = "main";
let messagesUnsubscribe = null; 

let localStream = null;         // –ü–æ—Ç–æ–∫ –¥–ª—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
let screenStream = null;        // –ü–æ—Ç–æ–∫ –¥–ª—è —ç–∫—Ä–∞–Ω–∞
let isSharingScreen = false;
let screenSenders = {};         // { targetSessionId: RTCRtpSender –¥–ª—è –≤–∏–¥–µ–æ-—Ç—Ä–µ–∫–∞ —ç–∫—Ä–∞–Ω–∞ }

let currentVoiceChannel = null;

// WebRTC –°–æ—Å—Ç–æ—è–Ω–∏–µ
const peerConnections = {}; // { targetSessionId: RTCPeerConnection }
let voiceSessionUnsubscribe = null;
let signalUnsubscribes = {}; // { targetSessionId: unsubscribeFunction }
let isMicMuted = false;

let isSidebarOpen = false;

// –ê–¥–º–∏–Ω —Å–æ—Å—Ç–æ—è–Ω–∏–µ
let isAdminPanelOpen = false;
let adminEventsUnsubscribe = null;
let adminBroadcastsUnsubscribe = null;
let isRainbowEventActive = false;
let isSilentEventActive = false;
let isMusicEventActive = false;
let currentMusicName = null;
let lastProcessedBroadcastId = null;

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
let userSettings = {
    theme: 'green', // green, white, red
    voiceMessagesEnabled: true,
    notifications: true
};

// –°–æ—Å—Ç–æ—è–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
let mediaRecorder = null;
let audioChunks = [];
let isRecording = false;
let recordingStartTime = 0;
let recordingTimer = null;
let audioContext = null;
let analyser = null;
let dataArray = null;
let animationFrame = null;

// –°–∏—Å—Ç–µ–º–∞ –ø–ª–∞–≥–∏–Ω–æ–≤
let userPlugins = {};
let activePlugins = {};
const availablePlugins = {
    'font-jetbrains': {
        name: 'JetBrains Mono Font',
        type: 'font',
        css: `
            body, .font-mono { 
                font-family: 'JetBrains Mono', monospace !important; 
                font-size: 0.95rem;
            }
        `,
        description: '–ß–∏—Å—Ç—ã–π –º–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–π —à—Ä–∏—Ñ—Ç JetBrains Mono'
    },
    'font-orbitron': {
        name: 'Orbitron Font',
        type: 'font',
        css: `
            body, .font-mono { 
                font-family: 'Orbitron', sans-serif !important; 
                letter-spacing: 0.5px;
                font-weight: 400;
            }
            input, button { font-family: 'Orbitron', sans-serif !important; }
        `,
        description: '–§—É—Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π —à—Ä–∏—Ñ—Ç Orbitron'
    },
    'theme-matrix': {
        name: 'Matrix Theme',
        type: 'theme',
        css: `
            :root { 
                --terminal-color: #00ff00 !important; 
                --terminal-glow: #00ff00 !important;
                --terminal-bg: #001100 !important;
                --scanline: rgba(0, 255, 0, 0.08) !important;
            }
            body { text-shadow: 0 0 8px #00ff00 !important; }
            .border-green-800 { border-color: #003300 !important; }
            .bg-green-900\\/10 { background-color: rgba(0, 30, 0, 0.2) !important; }
        `,
        description: '–°—Ç–∏–ª—å Matrix (–∑–µ–ª—ë–Ω—ã–π –Ω–∞ —á—ë—Ä–Ω–æ–º)'
    },
    'theme-cyberpunk': {
        name: 'Cyberpunk Theme',
        type: 'theme',
        css: `
            :root { 
                --terminal-color: #ff00ff !important; 
                --terminal-glow: #ff00ff !important;
                --terminal-bg: #0a001a !important;
                --scanline: rgba(255, 0, 255, 0.06) !important;
            }
            body { text-shadow: 0 0 8px #ff00ff !important; }
            .border-green-800 { border-color: #660066 !important; }
            .bg-green-900\\/10 { background-color: rgba(80, 0, 80, 0.2) !important; }
            .text-green-500 { color: #ff00ff !important; }
            .text-green-400 { color: #ff66ff !important; }
            .text-green-300 { color: #ff99ff !important; }
        `,
        description: '–ö–∏–±–µ—Ä–ø–∞–Ω–∫ —Å—Ç–∏–ª—å (—Ä–æ–∑–æ–≤—ã–π –Ω–∞ —Ç—ë–º–Ω–æ–º)'
    }
};

// --- DOM –≠–õ–ï–ú–ï–ù–¢–´ ---
const loginScreen = document.getElementById('login-screen');
const mainInterface = document.getElementById('main-interface');
const usernameInput = document.getElementById('username-input');
const pinInput = document.getElementById('pin-input');
const authMainBtn = document.getElementById('auth-main-btn');
const authSwitchBtn = document.getElementById('auth-switch-btn');
const authModeTitle = document.getElementById('auth-mode-title');
const loginError = document.getElementById('login-error');
const chatContainer = document.getElementById('chat-messages');
const messageInput = document.getElementById('message-input');
const displayUsername = document.getElementById('display-username');
const displayUid = document.getElementById('display-uid');
const voiceStatusPanel = document.getElementById('voice-status-panel');
const currentVoiceName = document.getElementById('current-voice-name');
const micToggleButton = document.getElementById('mic-toggle-btn');
const screenToggleButton = document.getElementById('screen-toggle-btn');
const notificationArea = document.getElementById('notification-area'); 
const sidebar = document.getElementById('sidebar'); 
const sidebarBackdrop = document.getElementById('sidebar-backdrop'); 
const floatingVideosContainer = document.getElementById('floating-videos-container');

// --- –ù–û–í–´–ï –≠–õ–ï–ú–ï–ù–¢–´ ---
let adminButton = null;
let adminPanel = null;
let settingsButton = null;
let settingsPanel = null;
let voiceMessageButton = null;
let voiceRecordingPanel = null;
let voiceVisualizer = null;
let backgroundMusic = null;
let pluginsButton = null;
let pluginsPanel = null;

// --- –õ–û–ì–ò–ö–ê –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–ò ---
window.toggleSidebar = function() {
    isSidebarOpen = !isSidebarOpen;
    if (isSidebarOpen) {
        sidebar.classList.remove('-translate-x-full');
        sidebar.classList.add('translate-x-0');
        sidebarBackdrop.classList.remove('hidden');
    } else {
        sidebar.classList.remove('translate-x-0');
        sidebar.classList.add('-translate-x-full');
        sidebarBackdrop.classList.add('hidden');
    }
}

// --- –ß–ê–°–¢–¨ 1: –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ---
async function initAuth() {
    try {
        await signInAnonymously(auth);
    } catch (e) {
        console.error("SLAX AUTH ERROR:", e);
        loginError.textContent = "–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –°–ë–û–ô –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò FIREBASE.";
    }
}
initAuth();

onAuthStateChanged(auth, (user) => {
    if (user) {
        currentUser = user;
        displayUid.textContent = `SID: ${localSessionId.slice(0, 8).toUpperCase()}`; 
        loginError.textContent = "–°–û–ï–î–ò–ù–ï–ù–ò–ï –£–°–¢–ê–ù–û–í–õ–ï–ù–û. –í–í–ï–î–ò–¢–ï –î–ê–ù–ù–´–ï.";
    }
});

authMainBtn.addEventListener('click', handleAuthAction);
authSwitchBtn.addEventListener('click', toggleAuthMode);
pinInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') handleAuthAction();
});

function toggleAuthMode() {
    authMode = authMode === 'login' ? 'register' : 'login';
    if (authMode === 'login') {
        authModeTitle.textContent = ">> LOG IN REQUIRED";
        authMainBtn.textContent = "[ CONNECT ]";
        authSwitchBtn.textContent = "[ SWITCH TO REGISTER ]";
        pinInput.placeholder = "enter_password_6_16_chars";
    } else {
        authModeTitle.textContent = ">> REGISTER NEW USER";
        authMainBtn.textContent = "[ CREATE USER ]";
        authSwitchBtn.textContent = "[ SWITCH TO LOG IN ]";
        pinInput.placeholder = "create_password_6_16_chars";
    }
    loginError.textContent = "–í–í–ï–î–ò–¢–ï –î–ê–ù–ù–´–ï.";
    playTone(1500, 0.05);
}

function handleAuthAction() {
    if (authMode === 'login') {
        attemptLogin();
    } else {
        attemptRegistration();
    }
}

async function validateInput(name, password) {
    if (!currentUser) {
        loginError.textContent = "–û–®–ò–ë–ö–ê: –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø FIREBASE –û–ñ–ò–î–ê–ï–¢–°–Ø.";
        return false;
    }
    if (!name || name.length < 3 || name.length > 12) {
        loginError.textContent = "–û–®–ò–ë–ö–ê: –ù–ò–ö–ù–ï–ô–ú –î–û–õ–ñ–ï–ù –ë–´–¢–¨ 3-12 –°–ò–ú–í–û–õ–û–í.";
        return false;
    }
    if (!password || password.length < 6 || password.length > 16) {
        loginError.textContent = "–û–®–ò–ë–ö–ê: –ü–ê–†–û–õ–¨ –î–û–õ–ñ–ï–ù –ë–´–¢–¨ 6-16 –°–ò–ú–í–û–õ–û–í.";
        return false;
    }
    return true;
}

async function attemptLogin() {
    const name = usernameInput.value.trim().toUpperCase();
    const password = pinInput.value.trim();
    
    if (!await validateInput(name, password)) return;

    loginError.textContent = "–ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø...";
    const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'app_users');
    const q = query(usersRef, where('username', '==', name), limit(1));
    
    try {
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
            loginError.textContent = "–û–®–ò–ë–ö–ê: –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –ù–ï –ù–ê–ô–î–ï–ù. –ó–ê–†–ï–ì–ò–°–¢–†–ò–†–£–ô–¢–ï–°–¨.";
            playTone(200, 0.3);
            return;
        }
        
        const userData = snapshot.docs[0].data();
        if (userData.password === password) {
            currentUsername = name;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –µ—Å—Ç—å
            if (userData.settings) {
                userSettings = { ...userSettings, ...userData.settings };
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–ª–∞–≥–∏–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –µ—Å—Ç—å
            if (userData.plugins) {
                userPlugins = userData.plugins;
                applyUserPlugins();
            }
            
            grantAccess();
        } else {
            loginError.textContent = "–û–®–ò–ë–ö–ê: –ü–ê–†–û–õ–¨ –ù–ï–í–ï–†–ï–ù.";
            playTone(200, 0.3);
        }

    } catch (err) {
        console.error("DB Login Error:", err);
        loginError.textContent = "–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ë–î: –°–ú. –ö–û–ù–°–û–õ–¨.";
    }
}

async function attemptRegistration() {
    const name = usernameInput.value.trim().toUpperCase();
    const password = pinInput.value.trim();
    
    if (!await validateInput(name, password)) return;

    loginError.textContent = "–ü–û–ü–´–¢–ö–ê –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò...";
    const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'app_users');
    const q = query(usersRef, where('username', '==', name), limit(1));

    try {
        const snapshot = await getDocs(q);

        if (!snapshot.empty) {
            loginError.textContent = "–û–®–ò–ë–ö–ê: –ù–ò–ö–ù–ï–ô–ú –ó–ê–ù–Ø–¢.";
            playTone(200, 0.3);
            return;
        }

        await setDoc(doc(usersRef, name), {
            username: name,
            password: password,
            settings: userSettings,
            plugins: userPlugins,
            createdAt: serverTimestamp()
        });
        
        currentUsername = name;
        loginError.textContent = `–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ ${name} –£–°–ü–ï–®–ù–û –°–û–ó–î–ê–ù.`;
        grantAccess();

    } catch (err) {
        console.error("DB Registration Error:", err);
        loginError.textContent = "–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ë–î –ü–†–ò –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò.";
    }
}

function grantAccess() {
    displayUsername.textContent = currentUsername;
    loginScreen.classList.add('hidden');
    mainInterface.classList.remove('hidden');
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω —Å–∏—Å—Ç–µ–º—ã –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞
    initializeAdminSystem();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –Ω–∞—Å—Ç—Ä–æ–µ–∫
    initializeSettingsSystem();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    initializeVoiceMessagesSystem();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –ø–ª–∞–≥–∏–Ω–æ–≤
    initializePluginsSystem();
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Ç–µ–º—É
    applyTheme(userSettings.theme);
    
    switchChannel(currentChannel); // –ò–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –æ–±–Ω–æ–≤–∏—Ç—å UI
    messageInput.focus();
    playTone(800, 0.1); 
}

// --- –°–ò–°–¢–ï–ú–ê –ü–õ–ê–ì–ò–ù–û–í ---
function initializePluginsSystem() {
    createPluginsButton();
    createPluginsPanel();
    applyUserPlugins();
}

function createPluginsButton() {
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ø–ª–∞–≥–∏–Ω–æ–≤ –≤ —Å–∞–π–¥–±–∞—Ä
    const userInfo = document.querySelector('.p-3.border-t-2.border-green-900');
    if (!userInfo) return;
    
    pluginsButton = document.createElement('button');
    pluginsButton.id = 'plugins-button';
    pluginsButton.className = 'mr-2 text-purple-500 hover:text-purple-300 transition-colors text-sm';
    pluginsButton.innerHTML = 'üß©';
    pluginsButton.title = '–ü–ª–∞–≥–∏–Ω—ã';
    pluginsButton.onclick = togglePluginsPanel;
    
    // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ –∫–Ω–æ–ø–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
    if (settingsButton) {
        settingsButton.after(pluginsButton);
    } else {
        const userContainer = userInfo.querySelector('.flex.items-center');
        if (userContainer) {
            userContainer.insertBefore(pluginsButton, userContainer.firstChild);
        }
    }
}

function createPluginsPanel() {
    // –°–æ–∑–¥–∞–µ–º –ø–∞–Ω–µ–ª—å –ø–ª–∞–≥–∏–Ω–æ–≤
    pluginsPanel = document.createElement('div');
    pluginsPanel.id = 'plugins-panel';
    pluginsPanel.className = 'fixed inset-0 z-50 hidden flex items-center justify-center bg-black/90';
    pluginsPanel.innerHTML = `
        <div class="w-11/12 max-w-3xl max-h-[90vh] overflow-y-auto border-2 border-purple-600 bg-black/95 p-6 shadow-[0_0_30px_rgba(128,0,255,0.5)]">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-purple-400">
                    >> –°–ò–°–¢–ï–ú–ê –ü–õ–ê–ì–ò–ù–û–í
                </h2>
                <button onclick="togglePluginsPanel()" class="text-purple-500 hover:text-purple-300 text-lg">[ X ]</button>
            </div>
            
            <div class="h-px w-full bg-purple-900 mb-6"></div>
            
            <!-- –î–û–°–¢–£–ü–ù–´–ï –ü–õ–ê–ì–ò–ù–´ -->
            <div class="mb-8">
                <h3 class="text-lg font-bold text-purple-300 mb-4 border-b border-purple-800 pb-2">
                    –î–û–°–¢–£–ü–ù–´–ï –ü–õ–ê–ì–ò–ù–´
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-4 border-2 border-purple-800 rounded-lg">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-bold text-purple-300">JetBrains Mono Font</h4>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="plugin-font-jetbrains" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                            </label>
                        </div>
                        <p class="text-sm text-purple-600 mb-3">–ß–∏—Å—Ç—ã–π –º–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–π —à—Ä–∏—Ñ—Ç JetBrains Mono</p>
                        <div class="text-xs text-purple-700">–¢–∏–ø: –®—Ä–∏—Ñ—Ç</div>
                    </div>
                    
                    <div class="p-4 border-2 border-purple-800 rounded-lg">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-bold text-purple-300">Orbitron Font</h4>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="plugin-font-orbitron" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                            </label>
                        </div>
                        <p class="text-sm text-purple-600 mb-3">–§—É—Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π —à—Ä–∏—Ñ—Ç Orbitron</p>
                        <div class="text-xs text-purple-700">–¢–∏–ø: –®—Ä–∏—Ñ—Ç</div>
                    </div>
                    
                    <div class="p-4 border-2 border-purple-800 rounded-lg">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-bold text-purple-300">Matrix Theme</h4>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="plugin-theme-matrix" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                            </label>
                        </div>
                        <p class="text-sm text-purple-600 mb-3">–°—Ç–∏–ª—å Matrix (–∑–µ–ª—ë–Ω—ã–π –Ω–∞ —á—ë—Ä–Ω–æ–º)</p>
                        <div class="text-xs text-purple-700">–¢–∏–ø: –¢–µ–º–∞</div>
                    </div>
                    
                    <div class="p-4 border-2 border-purple-800 rounded-lg">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-bold text-purple-300">Cyberpunk Theme</h4>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="plugin-theme-cyberpunk" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                            </label>
                        </div>
                        <p class="text-sm text-purple-600 mb-3">–ö–∏–±–µ—Ä–ø–∞–Ω–∫ —Å—Ç–∏–ª—å (—Ä–æ–∑–æ–≤—ã–π –Ω–∞ —Ç—ë–º–Ω–æ–º)</p>
                        <div class="text-xs text-purple-700">–¢–∏–ø: –¢–µ–º–∞</div>
                    </div>
                </div>
            </div>
            
            <!-- –ó–ê–ì–†–£–ó–ö–ê –°–í–û–ï–ì–û –ü–õ–ê–ì–ò–ù–ê -->
            <div class="mb-8">
                <h3 class="text-lg font-bold text-purple-300 mb-4 border-b border-purple-800 pb-2">
                    –ó–ê–ì–†–£–ó–ö–ê –°–í–û–ï–ì–û –ü–õ–ê–ì–ò–ù–ê
                </h3>
                
                <div class="p-4 border-2 border-purple-800 rounded-lg">
                    <div class="mb-4">
                        <label class="block text-purple-400 mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª–∞–≥–∏–Ω–∞:</label>
                        <input type="text" id="plugin-name" class="w-full bg-black border border-purple-700 text-purple-300 p-2 rounded" placeholder="–ú–æ–π –∫—Ä—É—Ç–æ–π –ø–ª–∞–≥–∏–Ω">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-purple-400 mb-2">CSS –∫–æ–¥:</label>
                        <textarea id="plugin-css" class="w-full h-40 bg-black border border-purple-700 text-purple-300 p-2 rounded font-mono text-sm" placeholder="/* –í–∞—à CSS –∫–æ–¥ –∑–¥–µ—Å—å */
body { 
    font-family: 'Arial', sans-serif;
    color: #00ff00;
}"></textarea>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <div>
                            <label class="text-sm text-purple-600">
                                <input type="checkbox" id="plugin-keep-after-logout" class="mr-2">
                                –°–æ—Ö—Ä–∞–Ω—è—Ç—å –ø–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞
                            </label>
                        </div>
                        
                        <div class="space-x-2">
                            <button onclick="testPlugin()" class="px-4 py-2 border border-purple-600 bg-purple-900/30 hover:bg-purple-700 transition-colors text-sm">
                                –¢–ï–°–¢
                            </button>
                            <button onclick="saveCustomPlugin()" class="px-4 py-2 border border-purple-600 bg-purple-900/30 hover:bg-purple-700 transition-colors text-sm">
                                –°–û–•–†–ê–ù–ò–¢–¨
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="h-px w-full bg-purple-900 mt-6 mb-4"></div>
            
            <div class="flex justify-between">
                <button onclick="savePluginSettings()" 
                    class="px-6 py-2 border border-purple-600 bg-purple-900/30 hover:bg-purple-700 hover:text-black transition-colors font-bold">
                    –°–û–•–†–ê–ù–ò–¢–¨ –ù–ê–°–¢–†–û–ô–ö–ò
                </button>
                <button onclick="togglePluginsPanel()" 
                    class="px-6 py-2 border border-gray-600 hover:bg-gray-800 transition-colors">
                    –û–¢–ú–ï–ù–ê
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(pluginsPanel);
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–µ–π –ø–ª–∞–≥–∏–Ω–æ–≤
    updatePluginSwitches();
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–µ–π
    document.querySelectorAll('#plugins-panel input[type="checkbox"][id^="plugin-"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const pluginId = this.id.replace('plugin-', '');
            if (availablePlugins[pluginId]) {
                if (this.checked) {
                    activatePlugin(pluginId);
                } else {
                    deactivatePlugin(pluginId);
                }
            }
        });
    });
}

window.togglePluginsPanel = function() {
    if (!pluginsPanel) return;
    
    const isOpen = pluginsPanel.classList.contains('hidden');
    if (isOpen) {
        pluginsPanel.classList.remove('hidden');
        pluginsPanel.classList.add('flex');
        updatePluginSwitches();
        playTone(1200, 0.1);
    } else {
        pluginsPanel.classList.remove('flex');
        pluginsPanel.classList.add('hidden');
        playTone(800, 0.1);
    }
}

function updatePluginSwitches() {
    for (const pluginId in availablePlugins) {
        const checkbox = document.getElementById(`plugin-${pluginId}`);
        if (checkbox) {
            checkbox.checked = userPlugins[pluginId] === true;
        }
    }
}

function applyUserPlugins() {
    // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å—Ç–∞—Ä—ã–µ –ø–ª–∞–≥–∏–Ω—ã
    document.querySelectorAll('.plugin-style').forEach(el => el.remove());
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–ª–∞–≥–∏–Ω—ã
    for (const pluginId in userPlugins) {
        if (userPlugins[pluginId] && availablePlugins[pluginId]) {
            activatePlugin(pluginId, true);
        }
    }
}

function activatePlugin(pluginId, skipSave = false) {
    if (!availablePlugins[pluginId]) return;
    
    const plugin = availablePlugins[pluginId];
    
    // –°–æ–∑–¥–∞–µ–º —Å—Ç–∏–ª—å –¥–ª—è –ø–ª–∞–≥–∏–Ω–∞
    const style = document.createElement('style');
    style.className = 'plugin-style';
    style.id = `plugin-${pluginId}`;
    style.textContent = plugin.css;
    document.head.appendChild(style);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–ª–∞–≥–∏–Ω—ã
    activePlugins[pluginId] = true;
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if (!skipSave) {
        userPlugins[pluginId] = true;
        savePluginSettings();
    }
    
    addSystemMessage(`–ü–õ–ê–ì–ò–ù "${plugin.name}" –ê–ö–¢–ò–í–ò–†–û–í–ê–ù`, false);
}

function deactivatePlugin(pluginId) {
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∏–ª—å –ø–ª–∞–≥–∏–Ω–∞
    const style = document.getElementById(`plugin-${pluginId}`);
    if (style) style.remove();
    
    // –£–¥–∞–ª—è–µ–º –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–ª–∞–≥–∏–Ω–æ–≤
    delete activePlugins[pluginId];
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    userPlugins[pluginId] = false;
    savePluginSettings();
    
    addSystemMessage(`–ü–õ–ê–ì–ò–ù "${availablePlugins[pluginId]?.name}" –û–¢–ö–õ–Æ–ß–ï–ù`, false);
}

window.testPlugin = function() {
    const css = document.getElementById('plugin-css').value;
    if (!css.trim()) {
        addSystemMessage("–í–í–ï–î–ò–¢–ï CSS –ö–û–î", true);
        return;
    }
    
    // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å –¥–ª—è —Ç–µ—Å—Ç–∞
    const tempStyle = document.createElement('style');
    tempStyle.id = 'plugin-test';
    tempStyle.textContent = css;
    document.head.appendChild(tempStyle);
    
    addSystemMessage("–ü–õ–ê–ì–ò–ù –ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–ù (–±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥)", false);
    
    setTimeout(() => {
        const style = document.getElementById('plugin-test');
        if (style) style.remove();
        addSystemMessage("–¢–ï–°–¢–û–í–´–ô –ü–õ–ê–ì–ò–ù –£–î–ê–õ–ï–ù", false);
    }, 10000);
}

window.saveCustomPlugin = async function() {
    const name = document.getElementById('plugin-name').value.trim();
    const css = document.getElementById('plugin-css').value.trim();
    const keepAfterLogout = document.getElementById('plugin-keep-after-logout').checked;
    
    if (!name || !css) {
        addSystemMessage("–ó–ê–ü–û–õ–ù–ò–¢–ï –í–°–ï –ü–û–õ–Ø", true);
        return;
    }
    
    const pluginId = 'custom-' + Date.now();
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
    const customPlugins = JSON.parse(localStorage.getItem('slax_custom_plugins') || '{}');
    customPlugins[pluginId] = {
        name: name,
        css: css,
        keepAfterLogout: keepAfterLogout
    };
    localStorage.setItem('slax_custom_plugins', JSON.stringify(customPlugins));
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–ª–∞–≥–∏–Ω
    const style = document.createElement('style');
    style.className = 'plugin-style';
    style.id = `plugin-${pluginId}`;
    style.textContent = css;
    document.head.appendChild(style);
    
    addSystemMessage(`–°–û–ë–°–¢–í–ï–ù–ù–´–ô –ü–õ–ê–ì–ò–ù "${name}" –°–û–•–†–ê–ù–ï–ù`, false);
    
    // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
    document.getElementById('plugin-name').value = '';
    document.getElementById('plugin-css').value = '';
}

window.savePluginSettings = async function() {
    try {
        const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'app_users');
        const userDocRef = doc(usersRef, currentUsername);
        
        await updateDoc(userDocRef, {
            plugins: userPlugins
        });
        
        addSystemMessage("–ù–ê–°–¢–†–û–ô–ö–ò –ü–õ–ê–ì–ò–ù–û–í –°–û–•–†–ê–ù–ï–ù–´", false);
        playTone(1000, 0.1);
        
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–ª–∞–≥–∏–Ω–æ–≤:", error);
        addSystemMessage("–û–®–ò–ë–ö–ê –°–û–•–†–ê–ù–ï–ù–ò–Ø –ü–õ–ê–ì–ò–ù–û–í", true);
    }
}

// --- –ß–ê–°–¢–¨ 2: –ù–ê–°–¢–†–û–ô–ö–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ---
function initializeSettingsSystem() {
    createSettingsButton();
    createSettingsPanel();
}

function createSettingsButton() {
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ —Å–∞–π–¥–±–∞—Ä (—Å–ª–µ–≤–∞ –æ—Ç –Ω–∏–∫–Ω–µ–π–º–∞)
    const userInfo = document.querySelector('.p-3.border-t-2.border-green-900');
    if (!userInfo) return;
    
    settingsButton = document.createElement('button');
    settingsButton.id = 'settings-button';
    settingsButton.className = 'mr-2 text-yellow-500 hover:text-yellow-300 transition-colors text-sm';
    settingsButton.innerHTML = '‚öô';
    settingsButton.title = '–ù–∞—Å—Ç—Ä–æ–π–∫–∏';
    settingsButton.onclick = toggleSettingsPanel;
    
    // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–¥ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    const userContainer = userInfo.querySelector('.flex.items-center');
    if (userContainer) {
        userContainer.insertBefore(settingsButton, userContainer.firstChild);
    }
}

function createSettingsPanel() {
    // –°–æ–∑–¥–∞–µ–º –ø–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫
    settingsPanel = document.createElement('div');
    settingsPanel.id = 'settings-panel';
    settingsPanel.className = 'fixed inset-0 z-50 hidden flex items-center justify-center bg-black/90';
    settingsPanel.innerHTML = `
        <div class="w-11/12 max-w-md max-h-[90vh] overflow-y-auto border-2 border-blue-600 bg-black/95 p-6 shadow-[0_0_30px_rgba(0,100,255,0.5)]">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-blue-400">
                    >> –ù–ê–°–¢–†–û–ô–ö–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
                </h2>
                <button onclick="toggleSettingsPanel()" class="text-blue-500 hover:text-blue-300 text-lg">[ X ]</button>
            </div>
            
            <div class="h-px w-full bg-blue-900 mb-6"></div>
            
            <!-- –¶–í–ï–¢–û–í–ê–Ø –¢–ï–ú–ê -->
            <div class="mb-8">
                <h3 class="text-lg font-bold text-blue-300 mb-4 border-b border-blue-800 pb-2">
                    –¶–í–ï–¢–û–í–ê–Ø –¢–ï–ú–ê
                </h3>
                
                <div class="grid grid-cols-3 gap-3">
                    <button id="theme-green" onclick="changeTheme('green')" 
                        class="p-3 border-2 border-green-600 bg-green-900/20 hover:bg-green-800 transition-colors text-center">
                        <div class="text-green-400 font-bold">–ó–ï–õ–ï–ù–ê–Ø</div>
                        <div class="text-xs text-green-600 mt-1">–ö–õ–ê–°–°–ò–ß–ï–°–ö–ê–Ø</div>
                    </button>
                    
                    <button id="theme-white" onclick="changeTheme('white')" 
                        class="p-3 border-2 border-gray-600 bg-gray-900/20 hover:bg-gray-800 transition-colors text-center">
                        <div class="text-gray-300 font-bold">–ë–ï–õ–ê–Ø</div>
                        <div class="text-xs text-gray-600 mt-1">–ú–û–ù–û–•–†–û–ú</div>
                    </button>
                    
                    <button id="theme-red" onclick="changeTheme('red')" 
                        class="p-3 border-2 border-red-600 bg-red-900/20 hover:bg-red-800 transition-colors text-center">
                        <div class="text-red-400 font-bold">–ö–†–ê–°–ù–ê–Ø</div>
                        <div class="text-xs text-red-600 mt-1">–ê–í–ê–†–ò–ô–ù–ê–Ø</div>
                    </button>
                </div>
            </div>
            
            <!-- –î–†–£–ì–ò–ï –ù–ê–°–¢–†–û–ô–ö–ò -->
            <div class="mb-8">
                <h3 class="text-lg font-bold text-blue-300 mb-4 border-b border-blue-800 pb-2">
                    –î–†–£–ì–ò–ï –ù–ê–°–¢–†–û–ô–ö–ò
                </h3>
                
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-bold text-blue-400">–ì–û–õ–û–°–û–í–´–ï –°–û–û–ë–©–ï–ù–ò–Ø</div>
                            <div class="text-xs text-blue-600">–†–∞–∑—Ä–µ—à–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π</div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="voice-messages-toggle" class="sr-only peer" ${userSettings.voiceMessagesEnabled ? 'checked' : ''}>
                            <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-bold text-blue-400">–£–í–ï–î–û–ú–õ–ï–ù–ò–Ø</div>
                            <div class="text-xs text-blue-600">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="notifications-toggle" class="sr-only peer" ${userSettings.notifications ? 'checked' : ''}>
                            <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="h-px w-full bg-blue-900 mt-6 mb-4"></div>
            
            <div class="flex justify-between">
                <button onclick="saveSettings()" 
                    class="px-6 py-2 border border-blue-600 bg-blue-900/30 hover:bg-blue-700 hover:text-black transition-colors font-bold">
                    –°–û–•–†–ê–ù–ò–¢–¨
                </button>
                <button onclick="toggleSettingsPanel()" 
                    class="px-6 py-2 border border-gray-600 hover:bg-gray-800 transition-colors">
                    –û–¢–ú–ï–ù–ê
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(settingsPanel);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–µ–π
    const voiceToggle = document.getElementById('voice-messages-toggle');
    const notificationsToggle = document.getElementById('notifications-toggle');
    
    if (voiceToggle) {
        voiceToggle.addEventListener('change', function() {
            userSettings.voiceMessagesEnabled = this.checked;
        });
    }
    
    if (notificationsToggle) {
        notificationsToggle.addEventListener('change', function() {
            userSettings.notifications = this.checked;
        });
    }
}

window.toggleSettingsPanel = function() {
    if (!settingsPanel) return;
    
    const isOpen = settingsPanel.classList.contains('hidden');
    if (isOpen) {
        settingsPanel.classList.remove('hidden');
        settingsPanel.classList.add('flex');
        playTone(1200, 0.1);
    } else {
        settingsPanel.classList.remove('flex');
        settingsPanel.classList.add('hidden');
        playTone(800, 0.1);
    }
}

window.changeTheme = function(theme) {
    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ —Ç–µ–º
    document.querySelectorAll('[id^="theme-"]').forEach(btn => {
        btn.classList.remove('border-4', 'bg-opacity-40');
        btn.classList.add('border-2', 'bg-opacity-20');
    });
    
    const themeBtn = document.getElementById(`theme-${theme}`);
    if (themeBtn) {
        themeBtn.classList.remove('border-2', 'bg-opacity-20');
        themeBtn.classList.add('border-4', 'bg-opacity-40');
    }
    
    // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ç–µ–º—ã
    applyTheme(theme);
}

function applyTheme(theme) {
    // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∫–ª–∞—Å—Å—ã —Ç–µ–º
    document.body.classList.remove('theme-green', 'theme-white', 'theme-red');
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —Ç–µ–º—É
    document.body.classList.add(`theme-${theme}`);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ CSS –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–º—ã
    updateCSSVariables(theme);
}

function updateCSSVariables(theme) {
    const root = document.documentElement;
    
    switch(theme) {
        case 'white':
            root.style.setProperty('--terminal-color', '#ffffff');
            root.style.setProperty('--terminal-glow', '#ffffff');
            root.style.setProperty('--terminal-bg', '#000000');
            root.style.setProperty('--scanline', 'rgba(255, 255, 255, 0.04)');
            root.style.setProperty('--header-bg', '#222');
            break;
            
        case 'red':
            root.style.setProperty('--terminal-color', '#ff0000');
            root.style.setProperty('--terminal-glow', '#ff0000');
            root.style.setProperty('--terminal-bg', '#0a0000');
            root.style.setProperty('--scanline', 'rgba(255, 0, 0, 0.04)');
            root.style.setProperty('--header-bg', '#220000');
            break;
            
        case 'green':
        default:
            root.style.setProperty('--terminal-color', '#0f0');
            root.style.setProperty('--terminal-glow', '#0f0');
            root.style.setProperty('--terminal-bg', '#000500');
            root.style.setProperty('--scanline', 'rgba(0, 255, 0, 0.04)');
            root.style.setProperty('--header-bg', '#001100');
            break;
    }
}

window.saveSettings = async function() {
    try {
        const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'app_users');
        const userDocRef = doc(usersRef, currentUsername);
        
        await updateDoc(userDocRef, {
            settings: userSettings
        });
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ç–µ–º—É
        applyTheme(userSettings.theme);
        
        addSystemMessage("–ù–ê–°–¢–†–û–ô–ö–ò –°–û–•–†–ê–ù–ï–ù–´", false);
        playTone(1000, 0.1);
        toggleSettingsPanel();
        
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:", error);
        addSystemMessage("–û–®–ò–ë–ö–ê –°–û–•–†–ê–ù–ï–ù–ò–Ø –ù–ê–°–¢–†–û–ï–ö", true);
    }
}

// --- –ß–ê–°–¢–¨ 3: –ì–û–õ–û–°–û–í–´–ï –°–û–û–ë–©–ï–ù–ò–Ø ---
function initializeVoiceMessagesSystem() {
    if (!userSettings.voiceMessagesEnabled) return;
    
    createVoiceMessageButton();
    createVoiceRecordingPanel();
}

function createVoiceMessageButton() {
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –æ–±–ª–∞—Å—Ç—å –≤–≤–æ–¥–∞
    const inputArea = document.querySelector('.flex.items-center.bg-green-900\\/10');
    if (!inputArea) return;
    
    voiceMessageButton = document.createElement('button');
    voiceMessageButton.id = 'voice-message-button';
    voiceMessageButton.className = 'ml-3 text-red-400 hover:text-red-300 transition-colors text-lg';
    voiceMessageButton.innerHTML = 'üé§';
    voiceMessageButton.title = '–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (—É–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ –¥–ª—è –∑–∞–ø–∏—Å–∏)';
    voiceMessageButton.onmousedown = startVoiceRecording;
    voiceMessageButton.onmouseup = stopVoiceRecording;
    voiceMessageButton.onmouseleave = stopVoiceRecording;
    voiceMessageButton.ontouchstart = (e) => {
        e.preventDefault();
        startVoiceRecording();
    };
    voiceMessageButton.ontouchend = (e) => {
        e.preventDefault();
        stopVoiceRecording();
    };
    
    inputArea.appendChild(voiceMessageButton);
}

function createVoiceRecordingPanel() {
    // –°–æ–∑–¥–∞–µ–º –ø–∞–Ω–µ–ª—å –∑–∞–ø–∏—Å–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    voiceRecordingPanel = document.createElement('div');
    voiceRecordingPanel.id = 'voice-recording-panel';
    voiceRecordingPanel.className = 'fixed bottom-24 left-1/2 transform -translate-x-1/2 z-50 hidden bg-black/90 border-2 border-red-600 p-4 rounded-lg shadow-[0_0_20px_rgba(255,0,0,0.5)] max-w-[90vw]';
    voiceRecordingPanel.innerHTML = `
        <div class="text-center mb-3">
            <div class="text-red-400 font-bold text-lg">–ó–ê–ü–ò–°–¨ –ì–û–õ–û–°–û–í–û–ì–û –°–û–û–ë–©–ï–ù–ò–Ø</div>
            <div id="recording-timer" class="text-red-300 text-sm">0:00 / 0:30</div>
        </div>
        
        <div class="flex items-center justify-center mb-4">
            <div id="voice-visualizer" class="flex items-end h-16 space-x-1">
                <!-- –ë–∞—Ä—Å—ã –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
        
        <div class="flex justify-center space-x-4">
            <button id="cancel-recording" class="px-4 py-2 border border-gray-600 hover:bg-gray-800 transition-colors">
                –û–¢–ú–ï–ù–ê
            </button>
            <button id="send-recording" class="px-4 py-2 border border-red-600 bg-red-900/30 hover:bg-red-700 transition-colors hidden">
                –û–¢–ü–†–ê–í–ò–¢–¨
            </button>
        </div>
    `;
    
    document.body.appendChild(voiceRecordingPanel);
    
    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä–∞
    voiceVisualizer = document.getElementById('voice-visualizer');
    for (let i = 0; i < 40; i++) {
        const bar = document.createElement('div');
        bar.className = 'w-1 bg-red-500 transition-all duration-100';
        bar.style.height = '4px';
        voiceVisualizer.appendChild(bar);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
    document.getElementById('cancel-recording').addEventListener('click', cancelVoiceRecording);
    document.getElementById('send-recording').addEventListener('click', sendVoiceMessage);
}

async function startVoiceRecording() {
    if (!userSettings.voiceMessagesEnabled) {
        addSystemMessage("–ì–û–õ–û–°–û–í–´–ï –°–û–û–ë–©–ï–ù–ò–Ø –û–¢–ö–õ–Æ–ß–ï–ù–´ –í –ù–ê–°–¢–†–û–ô–ö–ê–•", true);
        return;
    }
    
    if (isRecording) return;
    
    try {
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
        const stream = await navigator.mediaDevices.getUserMedia({ 
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true
            }
        });
        
        // –°–æ–∑–¥–∞–µ–º MediaRecorder
        mediaRecorder = new MediaRecorder(stream, {
            mimeType: 'audio/webm;codecs=opus',
            audioBitsPerSecond: 128000
        });
        
        audioChunks = [];
        
        mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) {
                audioChunks.push(event.data);
            }
        };
        
        mediaRecorder.onstop = () => {
            // –°–æ–∑–¥–∞–µ–º Blob –∏–∑ –∑–∞–ø–∏—Å–∞–Ω–Ω—ã—Ö —á–∞–Ω–∫–æ–≤
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm;codecs=opus' });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
            document.getElementById('send-recording').classList.remove('hidden');
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ —Ç—Ä–µ–∫–∏
            stream.getTracks().forEach(track => track.stop());
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é
            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
            }
            if (audioContext) {
                audioContext.close();
            }
        };
        
        // –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–ø–∏—Å—å
        mediaRecorder.start(100); // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–∂–¥—ã–µ 100–º—Å
        isRecording = true;
        recordingStartTime = Date.now();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –∑–∞–ø–∏—Å–∏
        voiceRecordingPanel.classList.remove('hidden');
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
        startRecordingTimer();
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä
        startVoiceVisualizer(stream);
        
        playTone(800, 0.1);
        
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:", error);
        addSystemMessage("–û–®–ò–ë–ö–ê: –ù–ï –£–î–ê–õ–û–°–¨ –ü–û–õ–£–ß–ò–¢–¨ –î–û–°–¢–£–ü –ö –ú–ò–ö–†–û–§–û–ù–£", true);
    }
}

function startRecordingTimer() {
    const timerElement = document.getElementById('recording-timer');
    recordingTimer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
        const seconds = elapsed % 60;
        const minutes = Math.floor(elapsed / 60);
        
        timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')} / 0:30`;
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ø–∏—Å—å —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥
        if (elapsed >= 30) {
            stopVoiceRecording();
        }
    }, 1000);
}

function startVoiceVisualizer(stream) {
    // –°–æ–∑–¥–∞–µ–º AudioContext –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∑–≤—É–∫–∞
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioContext.createAnalyser();
    const source = audioContext.createMediaStreamSource(stream);
    
    source.connect(analyser);
    analyser.fftSize = 256;
    const bufferLength = analyser.frequencyBinCount;
    dataArray = new Uint8Array(bufferLength);
    
    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä–∞
    function updateVisualizer() {
        if (!isRecording) return;
        
        analyser.getByteFrequencyData(dataArray);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã—Å–æ—Ç—É –±–∞—Ä—Å–æ–≤
        const bars = voiceVisualizer.children;
        const barCount = bars.length;
        
        for (let i = 0; i < barCount; i++) {
            // –ë–µ—Ä–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–∞–∑–Ω—ã—Ö —á–∞—Å—Ç–æ—Ç –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –±–∞—Ä—Å–æ–≤
            const dataIndex = Math.floor(i * (bufferLength / barCount));
            const value = dataArray[dataIndex] || 0;
            
            // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –≤—ã—Å–æ—Ç—ã (–æ—Ç 4px –¥–æ 64px)
            const height = 4 + (value / 255) * 60;
            bars[i].style.height = `${height}px`;
            
            // –ò–∑–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏
            if (value > 200) {
                bars[i].style.backgroundColor = '#ff0000';
            } else if (value > 150) {
                bars[i].style.backgroundColor = '#ff5500';
            } else if (value > 100) {
                bars[i].style.backgroundColor = '#ffaa00';
            } else {
                bars[i].style.backgroundColor = '#ff5555';
            }
        }
        
        animationFrame = requestAnimationFrame(updateVisualizer);
    }
    
    updateVisualizer();
}

function stopVoiceRecording() {
    if (!isRecording) return;
    
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
    }
    
    isRecording = false;
    
    // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–µ—Ä
    if (recordingTimer) {
        clearInterval(recordingTimer);
        recordingTimer = null;
    }
    
    playTone(600, 0.1);
}

function cancelVoiceRecording() {
    stopVoiceRecording();
    
    // –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
    voiceRecordingPanel.classList.add('hidden');
    document.getElementById('send-recording').classList.add('hidden');
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä
    const bars = voiceVisualizer.children;
    for (let bar of bars) {
        bar.style.height = '4px';
        bar.style.backgroundColor = '#ff5555';
    }
    
    addSystemMessage("–ó–ê–ü–ò–°–¨ –û–¢–ú–ï–ù–ï–ù–ê", false);
}

async function sendVoiceMessage() {
    if (audioChunks.length === 0) {
        addSystemMessage("–ù–ï–¢ –ó–ê–ü–ò–°–ê–ù–ù–´–• –î–ê–ù–ù–´–•", true);
        return;
    }
    
    try {
        const audioBlob = new Blob(audioChunks, { type: 'audio/webm;codecs=opus' });
        
        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Blob –≤ base64 –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        const reader = new FileReader();
        
        reader.onloadend = async () => {
            const base64Audio = reader.result.split(',')[1];
            const duration = Math.floor((Date.now() - recordingStartTime) / 1000);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), {
                text: `[–ì–û–õ–û–°–û–í–û–ï –°–û–û–ë–©–ï–ù–ò–ï ${duration}—Å]`,
                user: currentUsername,
                uid: currentUser.uid,
                channel: currentChannel,
                type: 'voice',
                voiceData: base64Audio,
                duration: duration,
                timestamp: serverTimestamp()
            });
            
            // –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
            voiceRecordingPanel.classList.add('hidden');
            document.getElementById('send-recording').classList.add('hidden');
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä
            const bars = voiceVisualizer.children;
            for (let bar of bars) {
                bar.style.height = '4px';
                bar.style.backgroundColor = '#ff5555';
            }
            
            addSystemMessage("–ì–û–õ–û–°–û–í–û–ï –°–û–û–ë–©–ï–ù–ò–ï –û–¢–ü–†–ê–í–õ–ï–ù–û", false);
            playTone(1000, 0.1);
        };
        
        reader.readAsDataURL(audioBlob);
        
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:", error);
        addSystemMessage("–û–®–ò–ë–ö–ê –û–¢–ü–†–ê–í–ö–ò –ì–û–õ–û–°–û–í–û–ì–û –°–û–û–ë–©–ï–ù–ò–Ø", true);
    }
}

// --- –ß–ê–°–¢–¨ 4: –ê–î–ú–ò–ù –°–ò–°–¢–ï–ú–ê ---

function initializeAdminSystem() {
    createAdminButton();
    createAdminPanel();
    subscribeToAdminEvents();
    subscribeToAdminBroadcasts();
    subscribeToAdminMusic();
    updateAdminButtonVisibility();
    
    if (currentUsername === 'WINTER') {
        setTimeout(() => {
            initializeAdminDocuments();
            addSystemMessage("–ê–î–ú–ò–ù –°–ò–°–¢–ï–ú–ê –ò–ù–ò–¶–ò–ê–õ–ò–ó–ò–†–û–í–ê–ù–ê", false);
        }, 1000);
    }
}

async function initializeAdminDocuments() {
    try {
        console.log("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∞–¥–º–∏–Ω–∞...");
        
        const adminEventsRef = doc(db, 'artifacts', appId, 'public', 'data', 'admin_events', 'current');
        const adminEventsDoc = await getDoc(adminEventsRef);
        
        if (!adminEventsDoc.exists()) {
            console.log("–°–æ–∑–¥–∞—é –¥–æ–∫—É–º–µ–Ω—Ç admin_events/current");
            await setDoc(adminEventsRef, {
                rainbow: false,
                silent: false,
                music: false,
                createdAt: serverTimestamp(),
                createdBy: currentUsername,
                lastUpdated: serverTimestamp(),
                updatedBy: currentUsername,
                sessionId: localSessionId
            });
            addSystemMessage("–î–û–ö–£–ú–ï–ù–¢ –°–û–ë–´–¢–ò–ô –°–û–ó–î–ê–ù", false);
        } else {
            console.log("–î–æ–∫—É–º–µ–Ω—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç");
        }
        
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:", error);
        addSystemMessage(`–û–®–ò–ë–ö–ê FIRESTORE: ${error.message}`, true);
    }
}

function subscribeToAdminEvents() {
    console.log("–ü–æ–¥–ø–∏—Å—ã–≤–∞—é—Å—å –Ω–∞ admin_events...");
    
    const adminEventsRef = doc(db, 'artifacts', appId, 'public', 'data', 'admin_events', 'current');
    
    if (adminEventsUnsubscribe) {
        adminEventsUnsubscribe();
    }
    
    adminEventsUnsubscribe = onSnapshot(adminEventsRef, (docSnap) => {
        if (docSnap.exists()) {
            const data = docSnap.data();
            console.log("–ü–æ–ª—É—á–µ–Ω—ã —Å–æ–±—ã—Ç–∏—è:", data);
            
            const wasRainbowActive = isRainbowEventActive;
            const wasSilentActive = isSilentEventActive;
            const wasMusicActive = isMusicEventActive;
            
            isRainbowEventActive = data.rainbow === true;
            isSilentEventActive = data.silent === true;
            isMusicEventActive = data.music === true;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—É (WINTER) –∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–æ–±—ã—Ç–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
            // –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∏—à–ª–æ –∏–∑ –¥—Ä—É–≥–æ–π —Å–µ—Å—Å–∏–∏ (—á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥–≤–æ–π–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)
            if (currentUsername === 'WINTER' && data.sessionId !== localSessionId) {
                if (wasRainbowActive !== isRainbowEventActive) {
                    addSystemMessage(`RAINBOW MODE: ${isRainbowEventActive ? '–ê–ö–¢–ò–í–ò–†–û–í–ê–ù' : '–í–´–ö–õ–Æ–ß–ï–ù'}`, false);
                }
                if (wasSilentActive !== isSilentEventActive) {
                    addSystemMessage(`SILENT MODE: ${isSilentEventActive ? '–ê–ö–¢–ò–í–ò–†–û–í–ê–ù' : '–í–´–ö–õ–Æ–ß–ï–ù'}`, false);
                }
                if (wasMusicActive !== isMusicEventActive) {
                    addSystemMessage(`BACKGROUND MUSIC: ${isMusicEventActive ? '–ê–ö–¢–ò–í–ò–†–û–í–ê–ù' : '–í–´–ö–õ–Æ–ß–ï–ù'}`, false);
                }
            }
            
            applyRainbowEvent(isRainbowEventActive);
            applySilentEvent(isSilentEventActive);
            applyMusicEvent(isMusicEventActive);
            updateAdminEventButtons();
            updateAdminStatus();
            
            const statusEl = document.getElementById('admin-status');
            if (statusEl) {
                statusEl.innerHTML = `<span class="text-green-400">–°–ò–ù–•–†–û–ù–ò–ó–ò–†–û–í–ê–ù–û</span>`;
            }
            
        } else {
            console.warn("–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–±—ã—Ç–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω");
            if (currentUsername === 'WINTER') {
                initializeAdminDocuments();
            }
        }
    }, (error) => {
        console.error("–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å–æ–±—ã—Ç–∏—è:", error);
        addSystemMessage("–û–®–ò–ë–ö–ê –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò –°–û–ë–´–¢–ò–ô", true);
    });
}

function subscribeToAdminMusic() {
    const adminMusicRef = doc(db, 'artifacts', appId, 'public', 'data', 'admin_music', 'current');
    
    onSnapshot(adminMusicRef, (docSnap) => {
        if (docSnap.exists()) {
            const data = docSnap.data();
            if (data.audioBase64 && data.name) {
                currentMusicName = data.name;
                
                // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∞—É–¥–∏–æ
                if (!backgroundMusic) {
                    backgroundMusic = document.createElement('audio');
                    backgroundMusic.id = 'background-music';
                    backgroundMusic.loop = true;
                    backgroundMusic.style.display = 'none';
                    document.body.appendChild(backgroundMusic);
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫
                backgroundMusic.src = `data:${data.type};base64,${data.audioBase64}`;
                updateAdminMusicInfo();
                
                // –ï—Å–ª–∏ –º—É–∑—ã–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–µ–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º
                if (isMusicEventActive) {
                    applyMusicEvent(true);
                }
            }
        }
    });
}

function subscribeToAdminBroadcasts() {
    const adminBroadcastsRef = collection(db, 'artifacts', appId, 'public', 'data', 'admin_broadcasts');
    const q = query(adminBroadcastsRef, limit(50));
    
    if (adminBroadcastsUnsubscribe) {
        adminBroadcastsUnsubscribe();
    }
    
    adminBroadcastsUnsubscribe = onSnapshot(q, (snapshot) => {
        snapshot.docChanges().forEach((change) => {
            if (change.type === 'added') {
                const broadcast = change.doc.data();
                const broadcastId = change.doc.id;
                
                if (broadcastId === lastProcessedBroadcastId) return;
                lastProcessedBroadcastId = broadcastId;
                
                if (broadcast.text && broadcast.sender) {
                    // –ê–¥–º–∏–Ω—Å–∫–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏ –≤–∏–¥–Ω—ã –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
                    addSystemMessage(`–ê–î–ú–ò–ù [${broadcast.sender}]: ${broadcast.text}`, false);
                    
                    if (!isSilentEventActive) {
                        playTone(1000, 0.1);
                        setTimeout(() => playTone(800, 0.1), 100);
                    }
                    
                    // –£–î–ê–õ–ï–ù–ò–ï –ß–ï–†–ï–ó 6 –°–ï–ö–£–ù–î
                    setTimeout(async () => {
                        try {
                            await deleteDoc(doc(adminBroadcastsRef, broadcastId));
                            console.log(`–ê–¥–º–∏–Ω—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ${broadcastId} —É–¥–∞–ª–µ–Ω–æ —á–µ—Ä–µ–∑ 6 —Å–µ–∫—É–Ω–¥`);
                        } catch (error) {
                            console.error(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è ${broadcastId}:`, error);
                        }
                    }, 6000);
                }
            }
        });
    }, (error) => {
        console.error("Admin broadcasts subscription error:", error);
    });
}

async function updateAdminEvent(eventName, value) {
    if (currentUsername !== 'WINTER') {
        addSystemMessage("–¢–†–ï–ë–£–Æ–¢–°–Ø –ü–†–ê–í–ê –ê–î–ú–ò–ù–ê", true);
        return;
    }
    
    try {
        console.log(`–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ ${eventName} –Ω–∞ ${value}`);
        
        const adminEventsRef = doc(db, 'artifacts', appId, 'public', 'data', 'admin_events', 'current');
        
        const currentDoc = await getDoc(adminEventsRef);
        const currentData = currentDoc.exists() ? currentDoc.data() : {};
        
        await setDoc(adminEventsRef, {
            ...currentData,
            [eventName]: value,
            lastUpdated: serverTimestamp(),
            updatedBy: currentUsername,
            sessionId: localSessionId
        }, { merge: true });
        
        const eventNames = {
            rainbow: "RAINBOW MODE",
            silent: "SILENT MODE",
            music: "BACKGROUND MUSIC"
        };
        
        const action = value ? "–ê–ö–¢–ò–í–ò–†–û–í–ê–ù" : "–í–´–ö–õ–Æ–ß–ï–ù";
        addSystemMessage(`${eventNames[eventName]}: ${action}`, false);
        
        console.log(`${eventName} –æ–±–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ`);
        
    } catch (error) {
        console.error(`–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ${eventName}:`, error);
        addSystemMessage(`–û–®–ò–ë–ö–ê: ${error.message}`, true);
    }
}

window.enableRainbow = () => updateAdminEvent('rainbow', true);
window.disableRainbow = () => updateAdminEvent('rainbow', false);
window.enableSilent = () => updateAdminEvent('silent', true);
window.disableSilent = () => updateAdminEvent('silent', false);
window.enableMusic = () => updateAdminEvent('music', true);
window.disableMusic = () => updateAdminEvent('music', false);

// –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –†–ê–î–£–ñ–ù–û–ì–û –≠–§–§–ï–ö–¢–ê
function applyRainbowEvent(isActive) {
    console.log(`Rainbow: ${isActive ? 'ON' : 'OFF'}`);
    
    if (isActive) {
        document.body.classList.add('rainbow-mode');
    } else {
        document.body.classList.remove('rainbow-mode');
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–º—É
        applyTheme(userSettings.theme);
    }
}

function applySilentEvent(isActive) {
    console.log(`Silent: ${isActive ? 'ON' : 'OFF'}`);
}

// –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –§–û–ù–û–í–û–ô –ú–£–ó–´–ö–ò
function applyMusicEvent(isActive) {
    console.log(`Music: ${isActive ? 'ON' : 'OFF'}`);
    
    if (!backgroundMusic) return;
    
    if (isActive) {
        // –í–∫–ª—é—á–∞–µ–º –º—É–∑—ã–∫—É
        backgroundMusic.volume = 0.3;
        backgroundMusic.play().then(() => {
            console.log("–§–æ–Ω–æ–≤–∞—è –º—É–∑—ã–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞");
            if (userSettings.notifications) {
                addSystemMessage("–§–û–ù–û–í–ê–Ø –ú–£–ó–´–ö–ê –í–ö–õ–Æ–ß–ï–ù–ê", false);
            }
        }).catch(error => {
            console.error("–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –º—É–∑—ã–∫–∏:", error);
            if (error.name === 'NotAllowedError') {
                addSystemMessage("–†–ê–ó–†–ï–®–ò–¢–ï –ê–í–¢–û–í–û–°–ü–†–û–ò–ó–í–ï–î–ï–ù–ò–ï –ú–£–ó–´–ö–ò –í –ë–†–ê–£–ó–ï–†–ï", true);
            }
        });
    } else {
        // –í—ã–∫–ª—é—á–∞–µ–º –º—É–∑—ã–∫—É
        backgroundMusic.pause();
        backgroundMusic.currentTime = 0;
        console.log("–§–æ–Ω–æ–≤–∞—è –º—É–∑—ã–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞");
        if (userSettings.notifications) {
            addSystemMessage("–§–û–ù–û–í–ê–Ø –ú–£–ó–´–ö–ê –í–´–ö–õ–Æ–ß–ï–ù–ê", false);
        }
    }
}

window.uploadMusic = async function() {
    if (currentUsername !== 'WINTER') {
        addSystemMessage("–¢–†–ï–ë–£–Æ–¢–°–Ø –ü–†–ê–í–ê –ê–î–ú–ò–ù–ê", true);
        return;
    }
    
    const fileInput = document.getElementById('music-upload');
    const file = fileInput.files[0];
    
    if (!file) {
        addSystemMessage("–í–´–ë–ï–†–ò–¢–ï –§–ê–ô–õ", true);
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ (1 –ú–ë = 1024 * 1024 –±–∞–π—Ç)
    if (file.size > 1024 * 1024) {
        addSystemMessage("–§–ê–ô–õ –°–õ–ò–®–ö–û–ú –ë–û–õ–¨–®–û–ô (–ú–ê–ö–°–ò–ú–£–ú 1 –ú–ë)", true);
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞
    if (!file.type.startsWith('audio/')) {
        addSystemMessage("–§–ê–ô–õ –î–û–õ–ñ–ï–ù –ë–´–¢–¨ –ê–£–î–ò–û", true);
        return;
    }
    
    const reader = new FileReader();
    
    reader.onloadend = async () => {
        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ base64 (—É–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å data:...)
        const base64 = reader.result.split(',')[1];
        
        try {
            const adminMusicRef = doc(db, 'artifacts', appId, 'public', 'data', 'admin_music', 'current');
            
            await setDoc(adminMusicRef, {
                audioBase64: base64,
                name: file.name,
                size: file.size,
                type: file.type,
                uploadedBy: currentUsername,
                uploadedAt: serverTimestamp()
            });
            
            addSystemMessage(`–ú–£–ó–´–ö–ê –ó–ê–ì–†–£–ñ–ï–ù–ê: ${file.name}`, false);
            
            // –û—á–∏—â–∞–µ–º input
            fileInput.value = '';
            
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º—É–∑—ã–∫–∏:", error);
            addSystemMessage(`–û–®–ò–ë–ö–ê –ó–ê–ì–†–£–ó–ö–ò: ${error.message}`, true);
        }
    };
    
    reader.readAsDataURL(file);
};

function updateAdminMusicInfo() {
    const musicInfo = document.getElementById('current-music-info');
    if (musicInfo) {
        musicInfo.textContent = currentMusicName ? `–ó–∞–≥—Ä—É–∂–µ–Ω —Ñ–∞–π–ª: ${currentMusicName}` : '–ú—É–∑—ã–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞';
    }
}

window.sendAdminBroadcast = async function() {
    if (currentUsername !== 'WINTER') {
        addSystemMessage("–¢–†–ï–ë–£–Æ–¢–°–Ø –ü–†–ê–í–ê –ê–î–ú–ò–ù–ê", true);
        return;
    }
    
    const broadcastText = document.getElementById('admin-broadcast-text').value.trim();
    if (!broadcastText) {
        addSystemMessage("–í–í–ï–î–ò–¢–ï –¢–ï–ö–°–¢ –°–û–û–ë–©–ï–ù–ò–Ø", true);
        return;
    }
    
    try {
        const adminBroadcastsRef = collection(db, 'artifacts', appId, 'public', 'data', 'admin_broadcasts');
        
        const broadcastDoc = await addDoc(adminBroadcastsRef, {
            text: broadcastText,
            sender: currentUsername,
            timestamp: serverTimestamp(),
            type: 'admin_broadcast',
            sessionId: localSessionId
        });
        
        // –£–î–ê–õ–ï–ù–ò–ï –ß–ï–†–ï–ó 6 –°–ï–ö–£–ù–î
        setTimeout(async () => {
            try {
                await deleteDoc(doc(adminBroadcastsRef, broadcastDoc.id));
                console.log(`–ê–¥–º–∏–Ω—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ${broadcastDoc.id} —É–¥–∞–ª–µ–Ω–æ —á–µ—Ä–µ–∑ 6 —Å–µ–∫—É–Ω–¥`);
            } catch (error) {
                console.error(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è ${broadcastDoc.id}:`, error);
            }
        }, 6000);
        
        const sendBtn = document.querySelector('button[onclick="sendAdminBroadcast()"]');
        const originalText = sendBtn.textContent;
        sendBtn.textContent = '–û–¢–ü–†–ê–í–õ–ï–ù–û';
        sendBtn.classList.add('bg-green-700');
        
        setTimeout(() => {
            sendBtn.textContent = originalText;
            sendBtn.classList.remove('bg-green-700');
        }, 2000);
        
        document.getElementById('admin-broadcast-text').value = '';
        
        addSystemMessage(`–†–ê–°–°–´–õ–ö–ê –û–¢–ü–†–ê–í–õ–ï–ù–ê: "${broadcastText.substring(0, 50)}${broadcastText.length > 50 ? '...' : ''}"`, false);
        
        if (!isSilentEventActive) {
            playTone(1500, 0.1);
        }
        
        console.log("–†–∞—Å—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞:", broadcastText);
        
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–∞—Å—Å—ã–ª–∫–∏:", error);
        addSystemMessage(`–û–®–ò–ë–ö–ê –û–¢–ü–†–ê–í–ö–ò: ${error.message}`, true);
    }
};

window.testAdminSystem = function() {
    console.log("=== –¢–ï–°–¢ –ê–î–ú–ò–ù –°–ò–°–¢–ï–ú–´ ===");
    console.log("Username:", currentUsername);
    console.log("Is admin:", currentUsername === 'WINTER');
    console.log("Rainbow mode:", isRainbowEventActive);
    console.log("Silent mode:", isSilentEventActive);
    console.log("Music mode:", isMusicEventActive);
    console.log("Music name:", currentMusicName);
    console.log("Session ID:", localSessionId);
    console.log("Firestore path:", `artifacts/${appId}/public/data/admin_events/current`);
    console.log("========================");
    
    addSystemMessage("–¢–ï–°–¢ –ê–î–ú–ò–ù –°–ò–°–¢–ï–ú–´ –í–´–ü–û–õ–ù–ï–ù (—Å–º. –∫–æ–Ω—Å–æ–ª—å)", false);
};

function createAdminButton() {
    const header = document.querySelector('#main-content-area .flex.items-center.space-x-4.text-xs');
    if (!header) return;
    
    adminButton = document.createElement('button');
    adminButton.id = 'admin-button';
    adminButton.className = 'hidden border border-yellow-600 px-2 py-0.5 hover:bg-yellow-600 hover:text-black transition-colors text-xs';
    adminButton.innerHTML = 'ADMIN';
    adminButton.onclick = toggleAdminPanel;
    
    const recIndicator = header.querySelector('.border.border-green-700');
    if (recIndicator) {
        header.insertBefore(adminButton, recIndicator);
    } else {
        header.appendChild(adminButton);
    }
}

function createAdminPanel() {
    adminPanel = document.createElement('div');
    adminPanel.id = 'admin-panel';
    adminPanel.className = 'fixed inset-0 z-50 hidden flex items-center justify-center bg-black/90';
    adminPanel.innerHTML = `
        <div class="admin-panel-container w-11/12 max-w-2xl max-h-[90vh] overflow-y-auto border-2 border-yellow-600 bg-black/95 p-6 shadow-[0_0_30px_rgba(255,255,0,0.5)]">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-yellow-400">
                    >> ADMIN ABYSE v1.3
                    <span id="connection-status" class="text-xs ml-2 text-green-500">ONLINE</span>
                </h2>
                <div class="flex space-x-2">
                    <button onclick="testAdminSystem()" class="px-3 py-1 border border-gray-600 text-xs hover:bg-gray-700" title="–¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã">
                        –¢–ï–°–¢
                    </button>
                    <button onclick="toggleAdminPanel()" class="text-yellow-500 hover:text-yellow-300 text-lg">[ X ]</button>
                </div>
            </div>
            
            <div class="h-px w-full bg-yellow-900 mb-6"></div>
            
            <!-- –°–¢–ê–¢–£–° -->
            <div class="mb-6 p-3 bg-black/50 border border-yellow-800">
                <div class="text-sm text-yellow-300 mb-1">–°–¢–ê–¢–£–° –°–ò–°–¢–ï–ú–´:</div>
                <div class="font-mono text-xs">
                    <div class="flex justify-between mb-1">
                        <span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</span>
                        <span class="${currentUsername === 'WINTER' ? 'text-green-400' : 'text-red-400'}">${currentUsername}</span>
                    </div>
                    <div class="flex justify-between mb-1">
                        <span>Rainbow Mode:</span>
                        <span id="rainbow-status" class="${isRainbowEventActive ? 'text-green-400' : 'text-gray-400'}">
                            ${isRainbowEventActive ? '–ê–ö–¢–ò–í–ï–ù' : '–í–´–ö–õ'}
                        </span>
                    </div>
                    <div class="flex justify-between mb-1">
                        <span>Silent Mode:</span>
                        <span id="silent-status" class="${isSilentEventActive ? 'text-green-400' : 'text-gray-400'}">
                            ${isSilentEventActive ? '–ê–ö–¢–ò–í–ï–ù' : '–í–´–ö–õ'}
                        </span>
                    </div>
                    <div class="flex justify-between">
                        <span>Background Music:</span>
                        <span id="music-status" class="${isMusicEventActive ? 'text-green-400' : 'text-gray-400'}">
                            ${isMusicEventActive ? '–ê–ö–¢–ò–í–ï–ù' : '–í–´–ö–õ'}
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –°–û–ë–´–¢–ò–Ø -->
            <div class="mb-8">
                <h3 class="text-lg font-bold text-yellow-300 mb-4 border-b border-yellow-800 pb-2">
                    –ì–õ–û–ë–ê–õ–¨–ù–´–ï –°–û–ë–´–¢–ò–ò
                </h3>
                
                <div class="space-y-4">
                    <!-- Rainbow Event -->
                    <div class="flex items-center justify-between p-3 border border-yellow-800 hover:border-yellow-600 transition-colors">
                        <div>
                            <div class="font-bold text-yellow-400">RAINBOW MODE</div>
                            <div class="text-xs text-yellow-600">–†–∞–¥—É–∂–Ω—ã–π —Ä–µ–∂–∏–º —Ç–µ—Ä–º–∏–Ω–∞–ª–∞</div>
                        </div>
                        <div class="flex space-x-2">
                            <button id="enable-rainbow-btn" onclick="enableRainbow()" 
                                class="px-4 py-1 border border-green-700 hover:bg-green-700 transition-colors text-sm">
                                –í–ö–õ
                            </button>
                            <button id="disable-rainbow-btn" onclick="disableRainbow()" 
                                class="px-4 py-1 border border-red-700 hover:bg-red-700 transition-colors text-sm">
                                –í–´–ö–õ
                            </button>
                        </div>
                    </div>
                    
                    <!-- Silent Event -->
                    <div class="flex items-center justify-between p-3 border border-yellow-800 hover:border-yellow-600 transition-colors">
                        <div>
                            <div class="font-bold text-yellow-400">SILENT MODE</div>
                            <div class="text-xs text-yellow-600">–û—Ç–∫–ª—é—á–∞–µ—Ç –≤—Å–µ –∑–≤—É–∫–∏ —Å–∞–π—Ç–∞</div>
                        </div>
                        <div class="flex space-x-2">
                            <button id="enable-silent-btn" onclick="enableSilent()" 
                                class="px-4 py-1 border border-green-700 hover:bg-green-700 transition-colors text-sm">
                                –í–ö–õ
                            </button>
                            <button id="disable-silent-btn" onclick="disableSilent()" 
                                class="px-4 py-1 border border-red-700 hover:bg-red-700 transition-colors text-sm">
                                –í–´–ö–õ
                            </button>
                        </div>
                    </div>
                    
                    <!-- Music Event -->
                    <div class="flex items-center justify-between p-3 border border-yellow-800 hover:border-yellow-600 transition-colors">
                        <div>
                            <div class="font-bold text-yellow-400">BACKGROUND MUSIC</div>
                            <div class="text-xs text-yellow-600">–§–æ–Ω–æ–≤–∞—è –º—É–∑—ã–∫–∞ –Ω–∞ —Å–∞–π—Ç–µ</div>
                        </div>
                        <div class="flex space-x-2">
                            <button id="enable-music-btn" onclick="enableMusic()" 
                                class="px-4 py-1 border border-green-700 hover:bg-green-700 transition-colors text-sm">
                                –í–ö–õ
                            </button>
                            <button id="disable-music-btn" onclick="disableMusic()" 
                                class="px-4 py-1 border border-red-700 hover:bg-red-700 transition-colors text-sm">
                                –í–´–ö–õ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- –ó–ê–ì–†–£–ó–ö–ê –ú–£–ó–´–ö–ò -->
            <div class="mb-8">
                <h3 class="text-lg font-bold text-yellow-300 mb-4 border-b border-yellow-800 pb-2">
                    –§–û–ù–û–í–ê–Ø –ú–£–ó–´–ö–ê
                </h3>
                
                <div class="space-y-4">
                    <div class="p-3 border border-yellow-800 hover:border-yellow-600 transition-colors">
                        <div class="font-bold text-yellow-400 mb-2">–¢–ï–ö–£–©–ê–Ø –ú–£–ó–´–ö–ê</div>
                        <div id="current-music-info" class="text-xs text-yellow-600">
                            ${currentMusicName ? `–ó–∞–≥—Ä—É–∂–µ–Ω —Ñ–∞–π–ª: ${currentMusicName}` : '–ú—É–∑—ã–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞'}
                        </div>
                    </div>
                    
                    <div class="p-3 border border-yellow-800 hover:border-yellow-600 transition-colors">
                        <div class="font-bold text-yellow-400 mb-2">–ó–ê–ì–†–£–ó–ò–¢–¨ –ù–û–í–£–Æ –ú–£–ó–´–ö–£</div>
                        <div class="text-xs text-yellow-600 mb-2">–í—ã–±–µ—Ä–∏—Ç–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª (MP3, –¥–æ 1 –ú–ë)</div>
                        <input type="file" id="music-upload" accept="audio/mpeg,audio/*" class="w-full text-xs text-yellow-300 bg-black border border-yellow-800 p-2">
                        <div class="flex justify-end mt-3">
                            <button onclick="uploadMusic()" class="px-4 py-2 border border-yellow-600 bg-yellow-900/30 hover:bg-yellow-700 hover:text-black transition-colors text-sm">
                                –ó–ê–ì–†–£–ó–ò–¢–¨
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- –°–ò–°–¢–ï–ú–ù–´–ï –°–û–û–ë–©–ï–ù–ò–Ø -->
            <div>
                <h3 class="text-lg font-bold text-yellow-300 mb-4 border-b border-yellow-800 pb-2">
                    –°–ò–°–¢–ï–ú–ù–´–ï –°–û–û–ë–©–ï–ù–ò–ï
                </h3>
                
                <div class="mb-4">
                    <textarea id="admin-broadcast-text" 
                        class="w-full h-32 bg-black border border-yellow-800 text-yellow-300 p-3 font-mono text-sm focus:border-yellow-500 focus:outline-none resize-none"
                        placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π..."></textarea>
                    <div class="text-xs text-yellow-600 mt-1">–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—è–≤–∏—Ç—Å—è —É –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ 1-3 —Å–µ–∫—É–Ω–¥—ã</div>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button onclick="document.getElementById('admin-broadcast-text').value = ''" 
                        class="px-4 py-2 border border-gray-600 hover:bg-gray-800 transition-colors text-sm">
                        –û–ß–ò–°–¢–ò–¢–¨
                    </button>
                    <button onclick="sendAdminBroadcast()" 
                        class="px-6 py-2 border border-yellow-600 bg-yellow-900/30 hover:bg-yellow-700 hover:text-black transition-colors font-bold">
                        –û–¢–ü–†–ê–í–ò–¢–¨ –í–°–ï–ú
                    </button>
                </div>
            </div>
            
            <div class="h-px w-full bg-yellow-900 mt-6 mb-4"></div>
            
            <div class="text-xs text-yellow-700 text-center flex justify-between">
                <span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <span class="text-yellow-500">${currentUsername}</span></span>
                <span>–°—Ç–∞—Ç—É—Å: <span id="admin-status" class="text-yellow-500">–û–∂–∏–¥–∞–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏...</span></span>
                <span>–í–µ—Ä—Å–∏—è: <span class="text-yellow-500">1.3</span></span>
            </div>
        </div>
    `;
    
    document.body.appendChild(adminPanel);
}

function updateAdminStatus() {
    const rainbowStatus = document.getElementById('rainbow-status');
    const silentStatus = document.getElementById('silent-status');
    const musicStatus = document.getElementById('music-status');
    const adminStatus = document.getElementById('admin-status');
    
    if (rainbowStatus) {
        rainbowStatus.textContent = isRainbowEventActive ? '–ê–ö–¢–ò–í–ï–ù' : '–í–´–ö–õ';
        rainbowStatus.className = isRainbowEventActive ? 'text-green-400' : 'text-gray-400';
    }
    
    if (silentStatus) {
        silentStatus.textContent = isSilentEventActive ? '–ê–ö–¢–ò–í–ï–ù' : '–í–´–ö–õ';
        silentStatus.className = isSilentEventActive ? 'text-green-400' : 'text-gray-400';
    }
    
    if (musicStatus) {
        musicStatus.textContent = isMusicEventActive ? '–ê–ö–¢–ò–í–ï–ù' : '–í–´–ö–õ';
        musicStatus.className = isMusicEventActive ? 'text-green-400' : 'text-gray-400';
    }
    
    if (adminStatus) {
        if (currentUsername === 'WINTER') {
            adminStatus.innerHTML = `<span class="text-green-400">–ê–î–ú–ò–ù | ${isRainbowEventActive ? 'RAINBOW' : ''}${isSilentEventActive ? ' SILENT' : ''}${isMusicEventActive ? ' MUSIC' : ''}</span>`;
        } else {
            adminStatus.innerHTML = `<span class="text-yellow-400">–¢–û–õ–¨–ö–û –ü–†–û–°–ú–û–¢–†</span>`;
        }
    }
}

function updateAdminEventButtons() {
    const buttons = {
        'enable-rainbow-btn': isRainbowEventActive,
        'disable-rainbow-btn': !isRainbowEventActive,
        'enable-silent-btn': isSilentEventActive,
        'disable-silent-btn': !isSilentEventActive,
        'enable-music-btn': isMusicEventActive,
        'disable-music-btn': !isMusicEventActive
    };
    
    for (const [id, isActive] of Object.entries(buttons)) {
        const btn = document.getElementById(id);
        if (btn) {
            if (isActive) {
                btn.classList.add('bg-green-700', 'text-black');
                btn.classList.remove('border-green-700');
            } else {
                btn.classList.remove('bg-green-700', 'text-black');
                btn.classList.add('border-green-700');
            }
        }
    }
}

function updateAdminButtonVisibility() {
    if (!adminButton) return;
    
    if (currentUsername === 'WINTER') {
        adminButton.classList.remove('hidden');
    } else {
        adminButton.classList.add('hidden');
    }
}

window.toggleAdminPanel = function() {
    if (!adminPanel) return;
    
    isAdminPanelOpen = !isAdminPanelOpen;
    if (isAdminPanelOpen) {
        adminPanel.classList.remove('hidden');
        adminPanel.classList.add('flex');
        playTone(1200, 0.1);
    } else {
        adminPanel.classList.remove('flex');
        adminPanel.classList.add('hidden');
        playTone(800, 0.1);
    }
}

// --- –ß–ê–°–¢–¨ 5: –¢–ï–ö–°–¢–û–í–´–ô –ß–ê–¢ –ò –ì–û–õ–û–°–û–í–´–ï –°–û–û–ë–©–ï–ù–ò–Ø ---
window.switchChannel = function(channelName) {
    currentChannel = channelName;
    
    document.querySelectorAll('#text-channels li').forEach(li => {
        li.classList.remove('channel-active');
        if (li.dataset.channel === channelName) li.classList.add('channel-active');
    });
    document.getElementById('channel-title').textContent = `>> #${channelName.toUpperCase()}_HUB`;
    
    playTone(1200, 0.05);
    subscribeToMessages();
    
    if (isSidebarOpen && window.innerWidth < 768) {
        toggleSidebar();
    }
}

function subscribeToMessages() {
    if (messagesUnsubscribe) messagesUnsubscribe();

    const q = collection(db, 'artifacts', appId, 'public', 'data', 'messages');

    messagesUnsubscribe = onSnapshot(q, (snapshot) => {
        const allMessages = [];
        snapshot.forEach(doc => {
            allMessages.push({ id: doc.id, ...doc.data() });
        });

        const channelMessages = allMessages
            .filter(m => m.channel === currentChannel)
            .sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));

        renderMessages(channelMessages);
    }, (error) => {
        console.error("SLAX DATA ERROR:", error);
        if (error.code === 'permission-denied') {
            addSystemMessage("–û–®–ò–ë–ö–ê: –ù–ï–î–û–°–¢–ê–¢–û–ß–ù–û –ü–†–ê–í. –ü–†–û–í–ï–†–¨–¢–ï –ü–†–ê–í–ò–õ–ê FIRESTORE.", true);
        } else {
            addSystemMessage("–û–®–ò–ë–ö–ê: –°–û–ï–î–ò–ù–ï–ù–ò–ï –ü–†–ï–†–í–ê–ù–û.", true);
        }
    });
}

function renderMessages(messages) {
    const staticMessages = Array.from(chatContainer.querySelectorAll('.system-msg'));
    chatContainer.innerHTML = '';
    staticMessages.forEach(msg => chatContainer.appendChild(msg));
    
    messages.forEach(msg => {
        const div = document.createElement('div');
        const date = msg.timestamp ? new Date(msg.timestamp.seconds * 1000) : new Date();
        const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        const isMe = msg.user === currentUsername;
        
        // –ï—Å–ª–∏ —ç—Ç–æ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        if (msg.type === 'voice' && msg.voiceData) {
            div.className = 'voice-message my-2 p-3 border border-blue-800 rounded bg-blue-900/10 hover:bg-blue-900/20 transition-colors';
            div.setAttribute('data-message-id', msg.id);
            
            // –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –≤–∏–¥ –∫–∞–∫ –≤ Telegram
            div.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <button onclick="playVoiceMessage('${msg.voiceData}', ${msg.duration || 0}, '${msg.id}')" 
                            class="w-8 h-8 rounded-full bg-blue-600 hover:bg-blue-500 flex items-center justify-center transition-colors">
                            <span class="text-white text-sm">‚ñ∂</span>
                        </button>
                        
                        <div class="flex flex-col">
                            <span class="${isMe ? 'text-blue-300 font-bold' : 'text-blue-500'} text-xs">
                                ${msg.user}
                            </span>
                            <span class="text-xs text-blue-700">
                                ${timeStr}
                            </span>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-3">
                        <!-- –í–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä –∑–≤—É–∫–∞ -->
                        <div id="visualizer-${msg.id}" class="flex items-end h-6 space-x-0.5">
                            <!-- –ë–∞—Ä—Å—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        </div>
                        
                        <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –∏ –≤—Ä–µ–º—è -->
                        <div class="flex items-center space-x-2">
                            <div class="voice-progress-container w-24 h-1 bg-blue-900/30 rounded-full overflow-hidden">
                                <div id="progress-${msg.id}" class="voice-progress-fill h-full bg-blue-500 transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <span id="time-${msg.id}" class="text-xs text-blue-400 min-w-[40px]">0:${msg.duration || 0}</span>
                        </div>
                        
                        <!-- –ò–∫–æ–Ω–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è -->
                        <span class="text-blue-400 text-sm">üé§</span>
                    </div>
                </div>
            `;
            
            // –°–æ–∑–¥–∞–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä –¥–ª—è —ç—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
            createVoiceVisualizerForMessage(msg.id, msg.duration || 0);
            
        } else {
            // –û–±—ã—á–Ω–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            div.innerHTML = `
                <div class="hover:bg-green-900/10 p-1 -mx-1 rounded">
                    <span class="timestamp font-mono text-green-700">[${timeStr}]</span>
                    <span class="${isMe ? 'text-green-300 font-bold' : 'text-green-500'}">&lt;${msg.user}&gt;</span>
                    <span class="text-green-100 whitespace-pre-wrap ml-2">${msg.text}</span>
                </div>
            `;
        }
        
        chatContainer.appendChild(div);
    });
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä–∞ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π
function createVoiceVisualizerForMessage(messageId, duration) {
    const visualizer = document.getElementById(`visualizer-${messageId}`);
    if (!visualizer) return;
    
    // –°–æ–∑–¥–∞–µ–º 20 –±–∞—Ä—Å–æ–≤ –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ–≥–æ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä–∞
    for (let i = 0; i < 20; i++) {
        const bar = document.createElement('div');
        bar.className = 'voice-visualizer-bar w-1 bg-blue-500 transition-all duration-150';
        // –ù–∞—á–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ - —Å–ª—É—á–∞–π–Ω–∞—è –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ "–≤–æ–ª–Ω—ã"
        const randomHeight = 2 + Math.random() * 10;
        bar.style.height = `${randomHeight}px`;
        visualizer.appendChild(bar);
    }
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä–∞
function startVisualizerAnimation(visualizer, audio) {
    if (!visualizer) return;
    
    // –°–æ–∑–¥–∞–µ–º AudioContext –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const analyser = audioContext.createAnalyser();
    const source = audioContext.createMediaElementSource(audio);
    
    source.connect(analyser);
    analyser.connect(audioContext.destination);
    analyser.fftSize = 256;
    
    const bufferLength = analyser.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLength);
    
    function updateVisualizer() {
        if (audio.paused || audio.ended) return;
        
        analyser.getByteFrequencyData(dataArray);
        const bars = visualizer.children;
        
        for (let i = 0; i < bars.length; i++) {
            const value = dataArray[Math.floor(i * (bufferLength / bars.length))] || 0;
            const height = 2 + (value / 255) * 20; // –û—Ç 2px –¥–æ 22px
            
            // –ü–ª–∞–≤–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã
            bars[i].style.height = `${height}px`;
            
            // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏
            if (value > 180) {
                bars[i].style.backgroundColor = '#00ffff';
            } else if (value > 120) {
                bars[i].style.backgroundColor = '#0088ff';
            } else if (value > 60) {
                bars[i].style.backgroundColor = '#0066ff';
            } else {
                bars[i].style.backgroundColor = '#0044ff';
            }
        }
        
        requestAnimationFrame(updateVisualizer);
    }
    
    updateVisualizer();
}

function stopVisualizerAnimation(visualizer) {
    if (!visualizer) return;
    
    const bars = visualizer.children;
    for (let bar of bars) {
        bar.style.height = '2px';
        bar.style.backgroundColor = '#0044ff';
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è playVoiceMessage –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä–∞ –ø—Ä–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏
function playVoiceMessage(base64Audio, duration, messageId) {
    if (isSilentEventActive) return;
    
    const audio = new Audio(`data:audio/webm;base64,${base64Audio}`);
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
    const progressFill = document.getElementById(`progress-${messageId}`);
    const timeDisplay = document.getElementById(`time-${messageId}`);
    const visualizer = document.getElementById(`visualizer-${messageId}`);
    
    if (messageElement) {
        const playButton = messageElement.querySelector('button');
        if (playButton) {
            playButton.innerHTML = '<span class="text-white text-sm">‚è∏</span>';
            playButton.onclick = () => audio.pause();
            
            audio.addEventListener('pause', () => {
                playButton.innerHTML = '<span class="text-white text-sm">‚ñ∂</span>';
                playButton.onclick = () => playVoiceMessage(base64Audio, duration, messageId);
            });
            
            audio.addEventListener('ended', () => {
                playButton.innerHTML = '<span class="text-white text-sm">‚ñ∂</span>';
                playButton.onclick = () => playVoiceMessage(base64Audio, duration, messageId);
                if (progressFill) progressFill.style.width = '0%';
                if (timeDisplay) timeDisplay.textContent = `0:${duration}`;
                stopVisualizerAnimation(visualizer);
            });
        }
    }
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    audio.addEventListener('timeupdate', () => {
        const progress = (audio.currentTime / audio.duration) * 100;
        if (progressFill) {
            progressFill.style.width = `${progress}%`;
        }
        if (timeDisplay) {
            const currentTime = Math.floor(audio.currentTime);
            const totalTime = Math.floor(audio.duration || duration);
            const currentMin = Math.floor(currentTime / 60);
            const currentSec = currentTime % 60;
            const totalMin = Math.floor(totalTime / 60);
            const totalSec = totalTime % 60;
            timeDisplay.textContent = `${currentMin}:${currentSec.toString().padStart(2, '0')}/${totalMin}:${totalSec.toString().padStart(2, '0')}`;
        }
    });
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä–∞
    startVisualizerAnimation(visualizer, audio);
    
    audio.play().catch(e => {
        console.error("–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∞—É–¥–∏–æ:", e);
        addSystemMessage("–û–®–ò–ë–ö–ê –í–û–°–ü–†–û–ò–ó–í–ï–î–ï–ù–ò–Ø –ê–£–î–ò–û", true);
    });
}

function addSystemMessage(text, isError = false) {
    // –ï—Å–ª–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö, –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∏—á–µ–≥–æ
    if (!userSettings.notifications) return;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º –æ —Å–æ–±—ã—Ç–∏—è—Ö –∞–¥–º–∏–Ω–∞
    const isAdminEventNotification = 
        text.includes("RAINBOW MODE:") || 
        text.includes("SILENT MODE:") || 
        text.includes("BACKGROUND MUSIC:") ||
        text.includes("–§–û–ù–û–í–ê–Ø –ú–£–ó–´–ö–ê –í–ö–õ–Æ–ß–ï–ù–ê") ||
        text.includes("–§–û–ù–û–í–ê–Ø –ú–£–ó–´–ö–ê –í–´–ö–õ–Æ–ß–ï–ù–ê");
    
    // –ï—Å–ª–∏ —ç—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–æ–±—ã—Ç–∏–∏ –∞–¥–º–∏–Ω–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é WINTER
    if (isAdminEventNotification && currentUsername !== 'WINTER') {
        return;
    }
    
    const notification = document.createElement('div');
    notification.className = `notification-item text-sm border-l-4 pl-2 ${isError ? 'text-red-300 border-red-500' : 'text-green-300 border-green-500'}`;
    notification.textContent = `>> –°–ò–°–¢–ï–ú–ê: ${text}`;
    
    notificationArea.appendChild(notification);

    setTimeout(() => {
        notification.classList.add('fade-out');
        
        setTimeout(() => {
            notification.remove();
        }, 200); 
    }, 2500); 
}


messageInput.addEventListener('keypress', async (e) => {
    if (e.key === 'Enter') {
        const text = messageInput.value.trim();
        if (!text) return;
        
        if (!currentUsername || currentUsername === 'GUEST') {
            addSystemMessage("–û–®–ò–ë–ö–ê: –ù–ï –ê–í–¢–û–†–ò–ó–û–í–ê–ù. –¢–†–ï–ë–£–ï–¢–°–Ø –í–•–û–î.", true);
            return;
        }

        messageInput.value = '';
        
        try {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), {
                text: text,
                user: currentUsername,
                uid: currentUser.uid,
                channel: currentChannel,
                timestamp: serverTimestamp()
            });
            playTone(600, 0.03);
        } catch (err) {
            console.error("Send error", err);
            addSystemMessage("–û–®–ò–ë–ö–ê –û–¢–ü–†–ê–í–ö–ò.", true);
        }
    }
});


// --- –ß–ê–°–¢–¨ 6: WEB-RTC / –ì–û–õ–û–°–û–í–û–ô –ß–ê–¢ –ò –≠–ö–†–ê–ù ---

const voiceRef = (channel) => collection(db, 'artifacts', appId, 'public', 'data', 'voice_sessions', channel, 'users');

const signalingCollectionRef = (sessionId) => collection(db, 'artifacts', appId, 'public', 'data', 'voice_signals', sessionId, 'incoming_signals'); 

window.handleVoiceAction = function(voiceId) {
    if (currentVoiceChannel === voiceId) {
        leaveVoice();
    } else {
        joinVoice(voiceId);
    }
    if (isSidebarOpen && window.innerWidth < 768) {
        toggleSidebar();
    }
};

async function joinVoice(voiceId) {
    if (!currentUser) return;
    if (currentVoiceChannel) await leaveVoice();
    
    currentVoiceChannel = voiceId;
    voiceStatusPanel.classList.remove('hidden');
    currentVoiceName.textContent = voiceId.toUpperCase();

    addSystemMessage(`–ó–ê–•–í–ê–¢ –ú–ò–ö–†–û–§–û–ù–ê...`);
    try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: false, audio: true });
        micToggleButton.textContent = 'MIC: ON';
        isMicMuted = false;
        
        await setDoc(doc(voiceRef(voiceId), localSessionId), {
            username: currentUsername,
            sessionId: localSessionId,
            uid: currentUser.uid, 
            joinedAt: serverTimestamp(),
            isMicMuted: false
        });

        subscribeToVoiceSession(voiceId);
        subscribeToSignaling();
        
        addSystemMessage(`–ì–û–õ–û–°–û–í–û–ô –£–ó–ï–õ ${voiceId.toUpperCase()} –ê–ö–¢–ò–í–ï–ù.`);
        playTone(400, 0.1);
        setTimeout(() => playTone(600, 0.2), 150);

    } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ GS:", err);
        addSystemMessage("–û–®–ò–ë–ö–ê: –ù–ï –£–î–ê–õ–û–°–¨ –ó–ê–•–í–ê–¢–ò–¢–¨ –ú–ò–ö–†–û–§–û–ù. –ü–†–û–í–ï–†–¨–¢–ï –†–ê–ó–†–ï–®–ï–ù–ò–Ø.", true);
        leaveVoice(); 
    }
}

window.leaveVoice = async function() {
    if (!currentVoiceChannel) {
        addSystemMessage(`–û–®–ò–ë–ö–ê: –í–´ –ù–ï –ü–û–î–ö–õ–Æ–ß–ï–ù–´ –ö –ì–û–õ–û–°–û–í–û–ú–£ –ö–ê–ù–ê–õ–£.`, true);
        return;
    }
    
    if (isSharingScreen) {
        await stopScreenShare();
    }

    const channelToLeave = currentVoiceChannel; 
    
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
    }

    Object.keys(peerConnections).forEach(sessionId => {
        const pc = peerConnections[sessionId];
        if (pc) pc.close();
        removeMediaWindow(sessionId, true);
        delete peerConnections[sessionId];
        delete screenSenders[sessionId];
    });

    if (voiceSessionUnsubscribe) {
        voiceSessionUnsubscribe();
        voiceSessionUnsubscribe = null;
    }
    
    for (const key in signalUnsubscribes) {
        if(signalUnsubscribes[key]) signalUnsubscribes[key]();
        delete signalUnsubscribes[key];
    }
    signalUnsubscribes = {}; 

    if (channelToLeave) {
        await deleteDoc(doc(voiceRef(channelToLeave), localSessionId)).catch(e => {
            console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–µ—Å—Å–∏—é (–º–æ–∂–µ—Ç –±—ã—Ç—å —É–∂–µ —É–¥–∞–ª–µ–Ω–∞):", e);
        });
    }

    currentVoiceChannel = null;
    voiceStatusPanel.classList.add('hidden');
    addSystemMessage(`–ì–û–õ–û–°–û–í–û–ô –£–ó–ï–õ –û–¢–ö–õ–Æ–ß–ï–ù.`);
    playTone(300, 0.2);
}

window.addEventListener('beforeunload', async () => {
    if (currentVoiceChannel) {
        const voiceSessionDocRef = doc(voiceRef(currentVoiceChannel), localSessionId);
        try {
             fetch(voiceSessionDocRef.path, { method: 'DELETE', keepalive: true });
        } catch(e) { }
    }
});

function subscribeToVoiceSession(voiceId) {
    if (voiceSessionUnsubscribe) voiceSessionUnsubscribe();
    
    const q = voiceRef(voiceId);
    voiceSessionUnsubscribe = onSnapshot(q, (snapshot) => {
        const users = [];
        const currentPeers = new Set(Object.keys(peerConnections));
        const activePeers = new Set();
        
        snapshot.forEach(doc => {
            const userData = doc.data();
            if (userData.sessionId !== localSessionId) { 
                users.push({ username: userData.username, sessionId: userData.sessionId });
                activePeers.add(userData.sessionId);
                
                const pc = peerConnections[userData.sessionId];

                if (!pc || pc.connectionState === 'closed' || pc.connectionState === 'failed') {
                    const isInitiator = localSessionId < userData.sessionId;
                    createPeerConnection(userData.sessionId, isInitiator); 
                    addSystemMessage(`–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ ${userData.username} –ü–†–ò–°–û–ï–î–ò–ù–ò–õ–°–Ø. (Initiator: ${isInitiator ? 'Yes' : 'No'})`);
                }
            }
        });

        currentPeers.forEach(sessionId => {
            if (!activePeers.has(sessionId)) {
                const pc = peerConnections[sessionId];
                if (pc) {
                    pc.close();
                }
                delete peerConnections[sessionId];
                delete screenSenders[sessionId];
                if (signalUnsubscribes[sessionId]) signalUnsubscribes[sessionId]();
                delete signalUnsubscribes[sessionId];
                removeMediaWindow(sessionId, true);
                addSystemMessage(`–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ ${sessionId.slice(0, 8).toUpperCase()} –í–´–®–ï–õ.`);
            }
        });
        
        const usersHtml = users.map(u => `<div class="text-green-300" data-session-id="${u.sessionId}">>> ${u.username}</div>`).join('');
        const voiceLi = document.querySelector(`li[data-voice="${voiceId}"]`);
        if (voiceLi) {
            voiceLi.querySelector('.voice-users').innerHTML = usersHtml;
            voiceLi.querySelector('.voice-count').textContent = users.length + 1; 
        }
        
    }, (err) => console.error("–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å–µ—Å—Å–∏—é:", err));
}

function subscribeToSignaling() {
    const q = signalingCollectionRef(localSessionId);
    
    if (signalUnsubscribes['local']) signalUnsubscribes['local']();

    signalUnsubscribes['local'] = onSnapshot(q, (snapshot) => {
        snapshot.docChanges().forEach(async (change) => {
            if (change.type !== 'added') return; 

            const signalDoc = change.doc;
            const data = signalDoc.data();
            
            if (data.senderSessionId === localSessionId) {
                try { await deleteDoc(signalDoc.ref); } catch(e) { }
                return;
            }

            if (data.offer) {
                addSystemMessage(`–ü–†–ò–ù–Ø–¢–û –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï –û–¢ ${data.senderUsername} - –û–ë–†–ê–ë–û–¢–ö–ê...`);
                await handleOffer(data.senderSessionId, data.offer, data.senderUsername);
                
            } else if (data.answer) {
                addSystemMessage(`–ü–†–ò–ù–Ø–¢ –û–¢–í–ï–¢ –û–¢ ${data.senderUsername} - –û–ë–†–ê–ë–û–¢–ö–ê...`);
                await handleAnswer(data.senderSessionId, data.answer);
                
            } else if (data.candidate) {
                await handleCandidate(data.senderSessionId, data.candidate);
            }
            
            try {
                await deleteDoc(signalDoc.ref);
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞ (–≤–æ–∑–º–æ–∂–Ω–æ, —É–∂–µ —É–¥–∞–ª–µ–Ω):", e);
            }
        });
    }, (err) => console.error("–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å–∏–≥–Ω–∞–ª—ã:", err));
}

async function createPeerConnection(targetSessionId, isInitiator) {
    const pc = new RTCPeerConnection(iceServers);
    peerConnections[targetSessionId] = pc;
    
    if (localStream) {
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
    }

    if (screenStream && isSharingScreen) {
        const videoTrack = screenStream.getVideoTracks()[0];
        if (videoTrack) {
            const sender = pc.addTrack(videoTrack, screenStream);
            screenSenders[targetSessionId] = sender;
        }
        screenStream.getAudioTracks().forEach(track => pc.addTrack(track, screenStream));
    }
    
    pc.ontrack = (event) => {
        const stream = event.streams[0];
        const track = event.track;

        const voiceLi = document.querySelector(`li[data-voice="${currentVoiceChannel}"]`);
        const userDiv = voiceLi ? voiceLi.querySelector(`.voice-users div[data-session-id="${targetSessionId}"]`) : null;
        const targetUsername = userDiv ? userDiv.textContent.replace('>> ', '').trim() : targetSessionId.slice(0, 8).toUpperCase(); 

        if (track.kind === 'audio') {
            ensureMediaWindow(targetSessionId, targetUsername, stream, 'audio');
        } else if (track.kind === 'video') {
            ensureMediaWindow(targetSessionId, targetUsername, stream, 'video');
        }
    };

    pc.onnegotiationneeded = async () => {
        if (isInitiator) {
            try {
                addSystemMessage(`–ò–ù–ò–¶–ò–ê–¶–ò–Ø –ü–ï–†–ï–°–û–ì–õ–ê–°–û–í–ê–ù–ò–Ø...`);
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                await sendSignal({
                    offer: pc.localDescription.toJSON(),
                    senderSessionId: localSessionId,
                    senderUsername: currentUsername,
                    type: 'offer'
                }, targetSessionId);
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è/–æ—Ç–ø—Ä–∞–≤–∫–∏ OFFER –≤ onnegotiationneeded:", e);
            }
        }
    };
    
    pc.onicecandidate = async (event) => {
        if (event.candidate) {
            await sendSignal({
                candidate: event.candidate.toJSON(),
                senderSessionId: localSessionId,
                senderUsername: currentUsername,
                type: 'candidate'
            }, targetSessionId);
        }
    };
    
    pc.oniceconnectionstatechange = () => {
        if (pc.iceConnectionState === 'disconnected' || pc.iceConnectionState === 'failed') {
            console.log(`ICE State for ${targetSessionId.slice(0, 4)}: ${pc.iceConnectionState}. –ü–æ–ø—ã—Ç–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è...`);
        }
    };
    
    if (isInitiator) {
        try {
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            await sendSignal({
                offer: pc.localDescription.toJSON(),
                senderSessionId: localSessionId,
                senderUsername: currentUsername,
                type: 'offer'
            }, targetSessionId);
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è/–æ—Ç–ø—Ä–∞–≤–∫–∏ OFFER:", e);
        }
    }
}

async function handleOffer(senderSessionId, offer, senderUsername) {
    let pc = peerConnections[senderSessionId];
    
    if (!pc) {
        createPeerConnection(senderSessionId, false);
        pc = peerConnections[senderSessionId];
    }

    if (!pc) return; 

    try {
        if (pc.signalingState !== 'stable') {
            if (pc.signalingState === 'have-local-offer') {
                 await pc.setLocalDescription({ type: "rollback" });
            } else if (pc.signalingState !== 'stable' && pc.signalingState !== 'have-remote-offer') {
                console.warn("–ü–æ–ª—É—á–µ–Ω OFFER –≤ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏, –æ–∂–∏–¥–∞–Ω–∏–µ:", pc.signalingState);
                return;
            }
        }
        
        await pc.setRemoteDescription(new RTCSessionDescription(offer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        
        await sendSignal({
            answer: pc.localDescription.toJSON(),
            senderSessionId: localSessionId,
            senderUsername: currentUsername,
            type: 'answer'
        }, senderSessionId);
        addSystemMessage(`–û–¢–ü–†–ê–í–õ–ï–ù –û–¢–í–ï–¢ ${senderUsername}.`);
    } catch (e) {
        console.error("–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –û–ë–†–ê–ë–û–¢–ö–ò OFFER:", e);
        addSystemMessage(`–û–®–ò–ë–ö–ê: –°–ë–û–ô –û–ë–†–ê–ë–û–¢–ö–ò –ü–†–ï–î–õ–û–ñ–ï–ù–ò–Ø –û–¢ ${senderUsername}.`, true);
    }
}

async function handleAnswer(senderSessionId, answer) {
    const pc = peerConnections[senderSessionId];
    if (!pc) {
        console.warn(`–ü–æ–ª—É—á–µ–Ω ANSWER, –Ω–æ PC –¥–ª—è ${senderSessionId} –Ω–µ –Ω–∞–π–¥–µ–Ω.`);
        return;
    }
    
    if (pc.signalingState === 'have-local-offer') {
        try {
            await pc.setRemoteDescription(new RTCSessionDescription(answer));
        } catch (e) {
            console.error("–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –û–ë–†–ê–ë–û–¢–ö–ò ANSWER:", e);
            addSystemMessage(`–û–®–ò–ë–ö–ê: –°–ë–û–ô –û–ë–†–ê–ë–û–¢–ö–ò –û–¢–í–ï–¢–ê.`, true);
        }
    } else {
        console.warn(`–ü–æ–ª—É—á–µ–Ω ANSWER –≤ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏: ${pc.signalingState}. –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º.`);
    }
}

async function handleCandidate(senderSessionId, candidate) {
    const pc = peerConnections[senderSessionId];
    if (pc && pc.remoteDescription) {
        try {
            await pc.addIceCandidate(new RTCIceCandidate(candidate));
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ICE-–∫–∞–Ω–¥–∏–¥–∞—Ç–∞ (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è):', e);
        }
    }
}

async function sendSignal(signalData, targetSessionId) {
    if (!targetSessionId || typeof targetSessionId !== 'string') {
        console.warn("Signal Warning: Invalid targetSessionId provided, skipping signal.", targetSessionId);
        return;
    }

    const recipientCollection = signalingCollectionRef(targetSessionId); 
    try {
        await addDoc(recipientCollection, signalData); 
    } catch (e) {
        console.error(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–∏–≥–Ω–∞–ª–∞ –∫ ${targetSessionId}:`, e);
    }
}

// –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ü–ï–†–ï–¢–ê–°–ö–ò–í–ê–ù–ò–Ø –ù–ê –¢–ï–õ–ï–§–û–ù–ï
function makeDraggable(element) {
    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
    const dragHeader = element.querySelector('.drag-handle');
    
    function dragMouseDown(e) {
        e = e || window.event;
        e.preventDefault();
        pos3 = e.clientX || e.touches[0].clientX;
        pos4 = e.clientY || e.touches[0].clientY;
        document.onmouseup = closeDragElement;
        document.onmousemove = elementDrag;
        document.ontouchend = closeDragElement;
        document.ontouchmove = elementDrag;
        element.classList.add('dragging');
    }

    function elementDrag(e) {
        e = e || window.event;
        e.preventDefault();
        const clientX = e.clientX || (e.touches && e.touches[0].clientX);
        const clientY = e.clientY || (e.touches && e.touches[0].clientY);
        
        if (!clientX || !clientY) return;
        
        pos1 = pos3 - clientX;
        pos2 = pos4 - clientY;
        pos3 = clientX;
        pos4 = clientY;
        
        element.style.top = (element.offsetTop - pos2) + "px";
        element.style.left = (element.offsetLeft - pos1) + "px";
    }

    function closeDragElement() {
        document.onmouseup = null;
        document.onmousemove = null;
        document.ontouchend = null;
        document.ontouchmove = null;
        element.classList.remove('dragging');
    }

    if (dragHeader) {
        dragHeader.onmousedown = dragMouseDown;
        dragHeader.ontouchstart = dragMouseDown;
    } else {
        element.onmousedown = dragMouseDown;
        element.ontouchstart = dragMouseDown;
    }
}

// –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ò–ó–ú–ï–ù–ï–ù–ò–Ø –†–ê–ó–ú–ï–†–ê –û–ö–ù–ê
function makeResizable(element) {
    const resizeHandle = document.createElement('div');
    resizeHandle.className = 'resize-handle absolute bottom-0 right-0 w-6 h-6 cursor-se-resize text-green-500 text-xs flex items-center justify-center';
    resizeHandle.innerHTML = '‚Üò';
    resizeHandle.title = '–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ (–∑–∞–∂–º–∏—Ç–µ –∏ —Ç—è–Ω–∏—Ç–µ)';
    element.appendChild(resizeHandle);

    let startX, startY, startWidth, startHeight;

    function startResize(e) {
        e.preventDefault();
        e.stopPropagation();
        
        startX = e.clientX || e.touches[0].clientX;
        startY = e.clientY || e.touches[0].clientY;
        startWidth = parseInt(document.defaultView.getComputedStyle(element).width, 10);
        startHeight = parseInt(document.defaultView.getComputedStyle(element).height, 10);
        
        document.documentElement.addEventListener('mousemove', resize);
        document.documentElement.addEventListener('mouseup', stopResize);
        document.documentElement.addEventListener('touchmove', resize);
        document.documentElement.addEventListener('touchend', stopResize);
        
        element.classList.add('resizing');
    }

    function resize(e) {
        e.preventDefault();
        
        const clientX = e.clientX || (e.touches && e.touches[0].clientX);
        const clientY = e.clientY || (e.touches && e.touches[0].clientY);
        
        if (!clientX || !clientY) return;
        
        const dx = clientX - startX;
        const dy = clientY - startY;
        
        const newWidth = Math.max(200, Math.min(window.innerWidth - 50, startWidth + dx));
        const newHeight = Math.max(150, Math.min(window.innerHeight - 100, startHeight + dy));
        
        element.style.width = newWidth + 'px';
        element.style.height = newHeight + 'px';
    }

    function stopResize() {
        document.documentElement.removeEventListener('mousemove', resize);
        document.documentElement.removeEventListener('mouseup', stopResize);
        document.documentElement.removeEventListener('touchmove', resize);
        document.documentElement.removeEventListener('touchend', stopResize);
        
        element.classList.remove('resizing');
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–∞–∑–º–µ—Ä –≤ localStorage
        const sessionId = element.id.replace('window-', '');
        const sizes = JSON.parse(localStorage.getItem('window_sizes') || '{}');
        sizes[sessionId] = {
            width: element.style.width,
            height: element.style.height
        };
        localStorage.setItem('window_sizes', JSON.stringify(sizes));
    }

    resizeHandle.addEventListener('mousedown', startResize);
    resizeHandle.addEventListener('touchstart', startResize);
}

function ensureMediaWindow(sessionId, username, stream, type, isLocal = false) {
    const windowId = `window-${sessionId}`;
    const mediaId = `${sessionId}-${type}`;
    let windowElement = document.getElementById(windowId);
    
    if (type === 'audio') {
        let audioElement = document.getElementById(mediaId);
        if (!audioElement) {
            audioElement = document.createElement('audio'); 
            audioElement.id = mediaId;
            audioElement.autoplay = true;
            audioElement.style.display = 'none';
            document.body.appendChild(audioElement);
            if (!isLocal) addSystemMessage(`–ü–û–õ–£–ß–ï–ù –ê–£–î–ò–û –ü–û–¢–û–ö –û–¢ ${username}.`);
        }
        audioElement.srcObject = stream;
        return;
    }

    if (!windowElement) {
        windowElement = document.createElement('div');
        windowElement.id = windowId;
        windowElement.className = "floating-window fixed border-2 border-green-700 bg-black/95 shadow-[0_0_15px_rgba(0,255,0,0.5)] z-50 transition-transform duration-300 ease-in-out";
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä –æ–∫–Ω–∞
        const sizes = JSON.parse(localStorage.getItem('window_sizes') || '{}');
        if (sizes[sessionId]) {
            windowElement.style.width = sizes[sessionId].width;
            windowElement.style.height = sizes[sessionId].height;
        } else {
            windowElement.style.width = '400px';
            windowElement.style.height = '300px';
        }
        
        // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –æ–∫–Ω–∞ —Å –Ω–µ–±–æ–ª—å—à–∏–º —Å–º–µ—â–µ–Ω–∏–µ–º
        const numWindows = document.querySelectorAll('.floating-window').length;
        const offsetX = (numWindows % 4) * 30;
        const offsetY = (numWindows % 3) * 30;
        windowElement.style.top = `${100 + offsetY}px`;
        windowElement.style.left = `${50 + offsetX}px`;

        const displayUsername = isLocal ? 'YOUR SCREEN' : `${username}'s SCREEN`;
        windowElement.innerHTML = `
            <div class="drag-handle p-1.5 cursor-move bg-green-900/50 flex justify-between items-center text-xs font-bold border-b border-green-700">
                <span class="text-green-300">${isLocal ? '>> ' : '<< '}${displayUsername}</span>
                <button onclick="removeMediaWindow('${sessionId}', true)" class="text-red-500 hover:text-red-300 transition-colors">[ X ]</button>
            </div>
            <div class="video-content w-full h-full" style="height: calc(100% - 30px);">
                <video id="${mediaId}" autoplay playsinline class="w-full h-full object-contain"></video>
            </div>
        `;
        
        floatingVideosContainer.appendChild(windowElement);
        makeDraggable(windowElement);
        makeResizable(windowElement);
        
        if (!isLocal) addSystemMessage(`–ü–û–õ–£–ß–ï–ù –í–ò–î–ï–û –ü–û–¢–û–ö (–≠–ö–†–ê–ù) –û–¢ ${username}.`);
    }

    const videoElement = windowElement.querySelector('video');
    if (videoElement) {
        videoElement.srcObject = stream;
        
        stream.getVideoTracks()[0].onended = () => {
            if (!isLocal) removeMediaWindow(sessionId, true);
        };
    }
}

window.removeMediaWindow = function(sessionId, isManualClose = false) {
    const audioId = `${sessionId}-audio`;
    const audioElement = document.getElementById(audioId);
    if (audioElement) {
        audioElement.remove();
    }
    
    const windowId = `window-${sessionId}`;
    const windowElement = document.getElementById(windowId);
    if (windowElement) {
        windowElement.remove();
    }

    if (sessionId === localSessionId && isSharingScreen && isManualClose) {
        stopScreenShare(); 
    }
}

window.toggleMic = function() {
    if (!localStream) return;
    isMicMuted = !isMicMuted;
    
    localStream.getAudioTracks().forEach(track => {
        track.enabled = !isMicMuted;
    });

    micToggleButton.textContent = isMicMuted ? 'MIC: OFF' : 'MIC: ON';
    addSystemMessage(isMicMuted ? '–ú–ò–ö–†–û–§–û–ù –í–´–ö–õ–Æ–ß–ï–ù.' : '–ú–ò–ö–†–û–§–û–ù –í–ö–õ–Æ–ß–ï–ù.');
    playTone(1000, 0.05);

    if (currentVoiceChannel) {
        updateDoc(doc(voiceRef(currentVoiceChannel), localSessionId), {
            isMicMuted: isMicMuted
        });
    }
}

window.toggleScreenShare = function() {
    if (isSharingScreen) {
        stopScreenShare();
    } else {
        startScreenShare();
    }
}

async function startScreenShare() {
    if (!currentVoiceChannel) {
        addSystemMessage("–û–®–ò–ë–ö–ê: –°–ù–ê–ß–ê–õ–ê –ü–û–î–ö–õ–Æ–ß–ò–¢–ï–°–¨ –ö –ì–û–õ–°–û–í–û–ú–£ –ö–ê–ù–ê–õ–£.", true);
        return;
    }
    if (isSharingScreen) return;

    addSystemMessage("–ó–ê–•–í–ê–¢ –≠–ö–†–ê–ù–ê...");
    try {
        const stream = await navigator.mediaDevices.getDisplayMedia({ 
            video: true, 
            audio: true 
        });
        
        screenStream = stream;
        isSharingScreen = true;
        screenToggleButton.textContent = 'SCREEN: ON';
        screenToggleButton.classList.add('bg-green-600', 'hover:bg-green-700');
        screenToggleButton.classList.remove('bg-green-900/20', 'hover:bg-green-800');

        const videoTrack = screenStream.getVideoTracks()[0];
        const audioTrack = screenStream.getAudioTracks()[0];
        
        ensureMediaWindow(localSessionId, currentUsername, stream, 'video', true);
        
        Object.keys(peerConnections).forEach(targetSessionId => {
            const pc = peerConnections[targetSessionId];
            if (videoTrack) {
                const sender = pc.addTrack(videoTrack, screenStream);
                screenSenders[targetSessionId] = sender;
            }
            if (audioTrack) {
                 pc.addTrack(audioTrack, screenStream);
            }
        });
        
        videoTrack.onended = stopScreenShare;

        addSystemMessage("–î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –≠–ö–†–ê–ù–ê –ù–ê–ß–ê–¢–ê.");
        playTone(1500, 0.1);

    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞—Ö–≤–∞—Ç–∞ —ç–∫—Ä–∞–Ω–∞:", e);
        addSystemMessage("–û–®–ò–ë–ö–ê: –ù–ï –£–î–ê–õ–û–°–¨ –ó–ê–•–í–ê–¢–ò–¢–¨ –≠–ö–†–ê–ù.", true);
        isSharingScreen = false;
        screenToggleButton.textContent = 'SCREEN: OFF';
        screenToggleButton.classList.remove('bg-green-600', 'hover:bg-green-700');
        screenToggleButton.classList.add('bg-green-900/20', 'hover:bg-green-800');
    }
}

async function stopScreenShare() {
    if (!isSharingScreen || !screenStream) return;

    addSystemMessage("–û–°–¢–ê–ù–û–í–ö–ê –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–ò –≠–ö–†–ê–ù–ê...");
    
    Object.keys(peerConnections).forEach(targetSessionId => {
        const pc = peerConnections[targetSessionId];
        const videoSender = screenSenders[targetSessionId];
        
        if (videoSender) {
            pc.removeTrack(videoSender);
            delete screenSenders[targetSessionId];
        }
        
        pc.getSenders().forEach(sender => {
            if (sender.track && screenStream.getAudioTracks().includes(sender.track)) {
                 pc.removeTrack(sender);
            }
        });
    });

    screenStream.getTracks().forEach(track => track.stop());
    screenStream = null;
    removeMediaWindow(localSessionId, false);
    isSharingScreen = false;

    screenToggleButton.textContent = 'SCREEN: OFF';
    screenToggleButton.classList.remove('bg-green-600', 'hover:bg-green-700');
    screenToggleButton.classList.add('bg-green-900/20', 'hover:bg-green-800');
    addSystemMessage("–î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –≠–ö–†–ê–ù–ê –û–°–¢–ê–ù–û–í–õ–ï–ù–ê.");
    playTone(300, 0.1);
}

// --- UTILS (–ó–≤—É–∫) ---
const AudioContext = window.AudioContext || window.webkitAudioContext;
const ctx = new AudioContext();

function playTone(freq, dur) {
    if (isSilentEventActive) {
        return;
    }
    
    try {
        if(ctx.state === 'suspended') ctx.resume();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.type = 'square';
        osc.frequency.value = freq;
        gain.gain.value = 0.03;
        osc.start();
        osc.stop(ctx.currentTime + dur);
    } catch(e) {}
}

// –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏
window.playVoiceMessage = playVoiceMessage;
