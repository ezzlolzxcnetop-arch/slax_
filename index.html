<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[SLAX-TERMINAL]</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    
    <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º CDN –≤–µ—Ä—Å–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ –±—Ä–∞—É–∑–µ—Ä–µ –±–µ–∑ —Å–±–æ—Ä—â–∏–∫–∞ -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>

    <style>
        :root {
            --terminal-green: #0f0;
            --terminal-glow: #0f0;
            --terminal-bg: #050505;
            --scanline: rgba(0, 255, 0, 0.04);
            --header-bg: #111;
        }

        body {
            background-color: var(--terminal-bg);
            color: var(--terminal-green);
            font-family: 'VT323', monospace;
            overflow: hidden;
            text-shadow: 0 0 3px var(--terminal-glow);
            font-size: 1.25rem;
        }

        .scanlines {
            position: fixed;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            background: linear-gradient(
                to bottom,
                var(--scanline) 50%,
                rgba(0, 0, 0, 0) 50%
            );
            background-size: 100% 4px;
            z-index: 50;
        }

        .crt-flicker {
            animation: flicker 0.15s infinite;
            opacity: 0.95;
        }

        @keyframes flicker {
            0% { opacity: 0.97; }
            50% { opacity: 0.94; }
            100% { opacity: 0.97; }
        }

        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track { background: #001100; }
        ::-webkit-scrollbar-thumb { background: #003300; border: 1px solid #0f0; }
        ::-webkit-scrollbar-thumb:hover { background: #0f0; }

        .channel-active {
            background-color: rgba(0, 255, 0, 0.2);
            border-left: 4px solid #0f0;
            padding-left: 8px !important;
        }
        
        input {
            background: transparent;
            border: none;
            color: inherit;
            outline: none;
            font-family: inherit;
            width: 100%;
        }

        /* –°—Ç–∏–ª—å –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ */
        .system-msg { color: #88aa88; font-style: italic; font-size: 0.9em; }
        .timestamp { opacity: 0.5; margin-right: 10px; font-size: 0.8em; }
        
        /* –°—Ç–∏–ª—å –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
        #notification-area {
            position: absolute;
            bottom: 6rem; /* –ù–∞–¥ –ø–æ–ª–µ–º –≤–≤–æ–¥–∞ */
            left: 24px;
            right: 24px;
            z-index: 900;
            pointer-events: none; /* –ß—Ç–æ–±—ã –Ω–µ –º–µ—à–∞—Ç—å –∫–ª–∏–∫–∞–º */
        }
        .notification-item {
            background-color: rgba(0, 50, 0, 0.8);
            border: 1px solid var(--terminal-green);
            padding: 5px 10px;
            margin-bottom: 5px;
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
        }
        .notification-item.fade-out {
            opacity: 0;
            transform: translateY(-10px);
        }

        .slax-loader::before {
            content: '';
            animation: slaxLoad 2s infinite;
        }
        @keyframes slaxLoad {
            0% { content: 'SLAX_KERNEL...'; }
            25% { content: 'LOADING_MODULES...'; }
            50% { content: 'MOUNTING_DRIVES...'; }
            75% { content: 'ESTABLISHING_UPLINK...'; }
        }

        /* –°—Ç–∏–ª—å –¥–ª—è –ø–µ—Ä–µ–º–µ—â–∞–µ–º–æ–≥–æ –æ–∫–Ω–∞ (Screen Share) */
        .draggable-window {
            position: absolute;
            width: 300px;
            height: 200px;
            min-width: 150px;
            min-height: 100px;
            resize: both;
            overflow: hidden;
            border: 2px solid var(--terminal-green);
            background-color: var(--terminal-bg);
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
            z-index: 1000;
        }
        .draggable-header {
            cursor: move;
            background-color: #003300;
            padding: 4px;
            font-size: 0.8rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .draggable-video {
            width: 100%;
            height: calc(100% - 24px); /* –£—á–∏—Ç—ã–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
            display: block;
            object-fit: contain;
            background: black;
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col crt-flicker">
    <div class="scanlines"></div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="absolute inset-0 flex flex-col items-center justify-center bg-black z-40">
        <pre class="text-xs sm:text-base leading-none mb-8 text-center text-green-500 font-bold">
  ____  _        _    __  __ 
 / ___|| |      / \   \ \/ / 
 \___ \| |     / _ \   \  /  
  ___) | |___ / ___ \  /  \  
 |____/|_____/_/   \_\/_/\_\ 
      OPERATING SYSTEM v3.0
        </pre>
        
        <div class="w-full max-w-md p-6 border-2 border-green-800 bg-black/90 shadow-[0_0_20px_rgba(0,255,0,0.2)]">
            <p id="auth-mode-title" class="mb-2 text-green-400 font-bold text-center">>> LOG IN REQUIRED</p>
            <div class="h-px w-full bg-green-900 mb-4"></div>
            
            <div class="flex items-center mb-4">
                <span class="mr-3 whitespace-nowrap">USER:</span>
                <input type="text" id="username-input" class="flex-1 border-b border-green-800 focus:border-green-500" placeholder="enter_callsign" autocomplete="off" maxlength="12">
            </div>
            
            <div class="flex items-center mb-4">
                <span class="mr-3 whitespace-nowrap">PIN:</span>
                <input type="password" id="pin-input" class="flex-1 border-b border-green-800 focus:border-green-500" placeholder="enter_4_digit_pin" autocomplete="off" maxlength="4" pattern="\d*">
            </div>
            
            <p id="login-error" class="text-red-500 mt-2 text-sm text-center">>> –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –°–ò–°–¢–ï–ú–´...</p>
            
            <button id="auth-main-btn" class="mt-6 border border-green-600 px-4 py-2 hover:bg-green-600 hover:text-black transition-all w-full text-center font-bold tracking-widest">
                [ CONNECT ]
            </button>
            
            <button id="auth-switch-btn" class="mt-3 text-xs opacity-70 hover:opacity-100 transition-opacity w-full text-center">
                [ SWITCH TO REGISTER ]
            </button>

            <div class="mt-4 text-xs text-center opacity-50">
                SECURE CONNECTION: <span class="text-green-300">ENCRYPTED</span>
            </div>
        </div>
    </div>

    <!-- MAIN INTERFACE -->
    <div id="main-interface" class="hidden flex-1 flex flex-col md:flex-row h-full">
        
        <!-- SIDEBAR -->
        <div class="w-full md:w-72 border-r-2 border-green-900 flex flex-col bg-black/95 z-10">
            <div class="p-3 border-b-2 border-green-900 bg-[#051105]">
                <div class="font-bold text-xl tracking-wider">SLAX_OS</div>
                <div class="text-xs opacity-70 flex justify-between mt-1">
                    <span>NET: ONLINE</span>
                    <span>PING: 24ms</span>
                </div>
            </div>
            
            <!-- TEXT CHANNELS -->
            <div class="p-4 flex-1 overflow-y-auto">
                <div class="mb-8">
                    <h3 class="text-xs font-bold opacity-60 mb-3 tracking-widest border-b border-green-900/50 pb-1">TEXT_PROTOCOLS</h3>
                    <ul id="text-channels" class="space-y-1">
                        <li onclick="switchChannel('main', 'text')" class="cursor-pointer p-2 hover:bg-green-900/20 transition-all channel-active" data-channel="main"># MAIN_HUB</li>
                        <li onclick="switchChannel('offtopic', 'text')" class="cursor-pointer p-2 hover:bg-green-900/20 transition-all" data-channel="offtopic"># OFFTOPIC</li>
                        <li onclick="switchChannel('dev', 'text')" class="cursor-pointer p-2 hover:bg-green-900/20 transition-all" data-channel="dev"># DEV_LOGS</li>
                    </ul>
                </div>

                <!-- VOICE CHANNELS -->
                <div>
                    <h3 class="text-xs font-bold opacity-60 mb-3 tracking-widest border-b border-green-900/50 pb-1">VOICE_UPLINKS</h3>
                    <ul id="voice-channels" class="space-y-2">
                        <li onclick="handleVoiceAction('lobby')" class="cursor-pointer border border-green-900/50 p-2 hover:border-green-500 transition-all group" data-voice="lobby">
                            <div class="flex justify-between items-center">
                                <span>üîä LOBBY</span>
                                <span class="voice-count text-[10px] bg-green-900 px-1 text-black group-hover:bg-green-500">READY</span>
                            </div>
                            <div class="voice-users mt-1 pl-2 text-xs opacity-80 border-l border-green-800 ml-1"></div>
                        </li>
                    </ul>
                    
                    <div id="voice-status-panel" class="hidden mt-6 bg-green-900/10 border border-green-500 p-3">
                        <div class="text-[10px] uppercase tracking-widest mb-1 opacity-70">–¢–µ–∫—É—â–∞—è –ß–∞—Å—Ç–æ—Ç–∞</div>
                        <div id="current-voice-name" class="font-bold text-lg mb-2"></div>
                        
                        <!-- –ú–∏–∫—Ä–æ—Ñ–æ–Ω –∏ –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –≠–∫—Ä–∞–Ω–∞ -->
                        <div class="flex space-x-2 mb-3">
                            <button id="mic-toggle-btn" onclick="toggleMic()" class="flex-1 bg-green-900/20 border border-green-800 text-green-400 hover:bg-green-800 hover:text-white transition-colors py-1 text-sm uppercase">
                                üé§ MIC: ON
                            </button>
                            <button id="screen-share-btn" onclick="toggleScreenShare()" class="flex-1 bg-blue-900/20 border border-blue-800 text-blue-400 hover:bg-blue-800 hover:text-white transition-colors py-1 text-sm uppercase">
                                üñ•Ô∏è DEMO SCREEN
                            </button>
                        </div>

                        <button onclick="leaveVoice()" class="w-full bg-red-900/20 border border-red-800 text-red-500 hover:bg-red-900 hover:text-white transition-colors py-1 text-sm uppercase">
                            [ –û–¢–ö–õ–Æ–ß–ò–¢–¨ ]
                        </button>
                    </div>
                    
                    <!-- –õ–æ–∫–∞–ª—å–Ω—ã–π –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫ (–¥–ª—è —Å–∞–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—è, —Å–∫—Ä—ã—Ç) -->
                    <video id="local-video" muted style="display:none;"></video>
                </div>
            </div>

            <!-- USER INFO -->
            <div class="p-3 border-t-2 border-green-900 text-sm bg-black">
                <div class="flex items-center">
                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse mr-2"></div>
                    <div>
                        <div id="display-username" class="font-bold tracking-wider">UNKNOWN</div>
                        <div class="text-[10px] opacity-50 font-mono" id="display-uid">ID: ----</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MAIN CHAT AREA -->
        <div id="main-content-area" class="flex-1 flex flex-col relative bg-black">
            <!-- HEADER -->
            <div class="h-14 border-b border-green-900 flex items-center px-6 justify-between bg-[#050905]">
                <span id="channel-title" class="text-xl font-bold tracking-widest">>> #MAIN_HUB</span>
                <div class="flex items-center space-x-4 text-xs">
                    <span class="hidden md:inline slax-loader opacity-50"></span>
                    <span class="border border-green-700 px-2 py-0.5">REC ‚óè</span>
                </div>
            </div>

            <!-- MESSAGES -->
            <div id="chat-messages" class="flex-1 overflow-y-auto p-6 font-mono space-y-2">
                <!-- –ù–∞—á–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ -->
                <div class="system-msg border-l-2 border-green-800 pl-2 my-1">>> –°–ò–°–¢–ï–ú–ê: SLAX KERNEL INITIALIZED...</div>
                <div class="system-msg border-l-2 border-green-800 pl-2 my-1">>> –°–ò–°–¢–ï–ú–ê: CONNECTING TO FIREBASE NODE [myconsolechat]...</div>
                <div class="system-msg border-l-2 border-green-800 pl-2 my-1">>> –°–ò–°–¢–ï–ú–ê: WAITING FOR INPUT...</div>
            </div>
            
            <!-- –í–†–ï–ú–ï–ù–ù–´–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø -->
            <div id="notification-area">
                <!-- –°—é–¥–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∏ —É–¥–∞–ª—è—Ç—å—Å—è —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è -->
            </div>

            <!-- INPUT AREA -->
            <div class="p-4 bg-black border-t border-green-900">
                <div class="flex items-center bg-green-900/10 border border-green-800 p-2 focus-within:border-green-500 transition-colors">
                    <span class="mr-3 text-green-500 font-bold whitespace-nowrap">root@slax:~#</span>
                    <input type="text" id="message-input" placeholder="execute_command..." autocomplete="off">
                </div>
                <div class="text-[10px] opacity-30 mt-1 text-right">SLAX_MESSENGER v3.0 // DO NOT DISTRIBUTE</div>
            </div>
        </div>
    </div>

    <script type="module">
        // –ò–º–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, setDoc, doc, query, onSnapshot, serverTimestamp, getDocs, where, limit, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
        // –ó–∞–º–µ–Ω–∏—Ç–µ —ç—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ –≤–∞—à–∏ —Ä–µ–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏, –µ—Å–ª–∏ –≤—ã –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ —Ö–æ—Å—Ç–∏—Ç—å —ç—Ç–æ.
        // –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–µ—Å—Ç–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è.
        const firebaseConfig = {
            apiKey: "AIzaSyC5IfNWuv-8lR5PGvM-5zXxLap3EVa6rDk",
            authDomain: "myconsolechat.firebaseapp.com",
            projectId: "myconsolechat",
            storageBucket: "myconsolechat.firebasestorage.app",
            messagingSenderId: "686599654568",
            appId: "1:686599654568:web:2c190df85c4f7780ca069d",
            measurementId: "G-7B38TF6NH7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'slax-console-v1'; 

        // WebRTC Config: –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–µ–¥–æ—Å—Ç—É–ø–Ω—ã–µ Google STUN-—Å–µ—Ä–≤–µ—Ä—ã
        const iceServers = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
            ]
        };

        // --- –°–û–°–¢–û–Ø–ù–ò–ï ---
        let currentUser = null; 
        let currentUsername = "GUEST"; 
        let authMode = 'login'; 
        let currentChannel = "main";
        let messagesUnsubscribe = null; // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –æ—Ç–º–µ–Ω—ã –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        
        let localStream = null; // –õ–æ–∫–∞–ª—å–Ω—ã–π –∞—É–¥–∏–æ/–≤–∏–¥–µ–æ –ø–æ—Ç–æ–∫
        let screenShareStream = null; // –ü–æ—Ç–æ–∫ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞
        let currentVoiceChannel = null;

        // WebRTC –°–æ—Å—Ç–æ—è–Ω–∏–µ
        const peerConnections = {}; // { targetUID: RTCPeerConnection }
        let voiceSessionUnsubscribe = null;
        let signalUnsubscribes = {}; // { targetUID: unsubscribeFunction }
        let isMicMuted = false;

        // --- DOM –≠–õ–ï–ú–ï–ù–¢–´ ---
        const loginScreen = document.getElementById('login-screen');
        const mainInterface = document.getElementById('main-interface');
        const usernameInput = document.getElementById('username-input');
        const pinInput = document.getElementById('pin-input');
        const authMainBtn = document.getElementById('auth-main-btn');
        const authSwitchBtn = document.getElementById('auth-switch-btn');
        const authModeTitle = document.getElementById('auth-mode-title');
        const loginError = document.getElementById('login-error');
        const chatContainer = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const displayUsername = document.getElementById('display-username');
        const displayUid = document.getElementById('display-uid');
        const voiceStatusPanel = document.getElementById('voice-status-panel');
        const currentVoiceName = document.getElementById('current-voice-name');
        const micToggleButton = document.getElementById('mic-toggle-btn');
        const screenShareButton = document.getElementById('screen-share-btn');
        const mainContentArea = document.getElementById('main-content-area'); // –î–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –æ–∫–æ–Ω
        const notificationArea = document.getElementById('notification-area'); // –ù–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π


        // --- –ß–ê–°–¢–¨ 1: –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ---
        async function initAuth() {
            try {
                // –ê–Ω–æ–Ω–∏–º–Ω—ã–π –≤—Ö–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è UID (–∫–ª—é—á –∫ Firestore)
                await signInAnonymously(auth);
            } catch (e) {
                console.error("SLAX AUTH ERROR:", e);
                loginError.textContent = "–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –°–ë–û–ô –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò FIREBASE.";
            }
        }
        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                displayUid.textContent = `UID: ${user.uid.slice(0, 8).toUpperCase()}`;
                loginError.textContent = "–°–û–ï–î–ò–ù–ï–ù–ò–ï –£–°–¢–ê–ù–û–í–õ–ï–ù–û. –í–í–ï–î–ò–¢–ï –î–ê–ù–ù–´–ï.";
            }
        });

        authMainBtn.addEventListener('click', handleAuthAction);
        authSwitchBtn.addEventListener('click', toggleAuthMode);
        pinInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleAuthAction();
        });
        
        function toggleAuthMode() {
            authMode = authMode === 'login' ? 'register' : 'login';
            if (authMode === 'login') {
                authModeTitle.textContent = ">> LOG IN REQUIRED";
                authMainBtn.textContent = "[ CONNECT ]";
                authSwitchBtn.textContent = "[ SWITCH TO REGISTER ]";
            } else {
                authModeTitle.textContent = ">> REGISTER NEW USER";
                authMainBtn.textContent = "[ CREATE USER ]";
                authSwitchBtn.textContent = "[ SWITCH TO LOG IN ]";
            }
            loginError.textContent = "–í–í–ï–î–ò–¢–ï –î–ê–ù–ù–´–ï.";
            playTone(1500, 0.05);
        }

        function handleAuthAction() {
            if (authMode === 'login') {
                attemptLogin();
            } else {
                attemptRegistration();
            }
        }

        async function validateInput(name, pin) {
            if (!currentUser) {
                loginError.textContent = "–û–®–ò–ë–ö–ê: –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø FIREBASE –û–ñ–ò–î–ê–ï–¢–°–Ø.";
                return false;
            }
            if (!name || name.length < 3 || name.length > 12) {
                loginError.textContent = "–û–®–ò–ë–ö–ê: –ù–ò–ö–ù–ï–ô–ú –î–û–õ–ñ–ï–ù –ë–´–¢–¨ 3-12 –°–ò–ú–í–û–õ–û–í.";
                return false;
            }
            if (!pin || pin.length !== 4 || isNaN(pin)) {
                loginError.textContent = "–û–®–ò–ë–ö–ê: –ü–ò–ù –î–û–õ–ñ–ï–ù –ë–´–¢–¨ 4 –¶–ò–§–†–´.";
                return false;
            }
            return true;
        }

        async function attemptLogin() {
            const name = usernameInput.value.trim().toUpperCase();
            const pin = pinInput.value.trim();
            
            if (!await validateInput(name, pin)) return;

            loginError.textContent = "–ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø...";
            const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'app_users');
            const q = query(usersRef, where('username', '==', name), limit(1));
            
            try {
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    loginError.textContent = "–û–®–ò–ë–ö–ê: –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –ù–ï –ù–ê–ô–î–ï–ù. –ó–ê–†–ï–ì–ò–°–¢–†–ò–†–£–ô–¢–ï–°–¨.";
                    playTone(200, 0.3);
                    return;
                }
                
                const userData = snapshot.docs[0].data();
                if (userData.pin === pin) {
                    currentUsername = name;
                    grantAccess();
                } else {
                    loginError.textContent = "–û–®–ò–ë–ö–ê: –ü–ò–ù-–ö–û–î –ù–ï–í–ï–†–ï–ù.";
                    playTone(200, 0.3);
                }

            } catch (err) {
                console.error("DB Login Error:", err);
                loginError.textContent = "–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ë–î: –°–ú. –ö–û–ù–°–û–õ–¨.";
            }
        }

        async function attemptRegistration() {
            const name = usernameInput.value.trim().toUpperCase();
            const pin = pinInput.value.trim();
            
            if (!await validateInput(name, pin)) return;

            loginError.textContent = "–ü–û–ü–´–¢–ö–ê –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò...";
            const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'app_users');
            const q = query(usersRef, where('username', '==', name), limit(1));

            try {
                const snapshot = await getDocs(q);

                if (!snapshot.empty) {
                    loginError.textContent = "–û–®–ò–ë–ö–ê: –ù–ò–ö–ù–ï–ô–ú –ó–ê–ù–Ø–¢.";
                    playTone(200, 0.3);
                    return;
                }

                await setDoc(doc(usersRef, name), {
                    username: name,
                    pin: pin,
                    createdAt: serverTimestamp()
                });
                
                currentUsername = name;
                loginError.textContent = `–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ ${name} –£–°–ü–ï–®–ù–û –°–û–ó–î–ê–ù.`;
                grantAccess();

            } catch (err) {
                console.error("DB Registration Error:", err);
                loginError.textContent = "–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ë–î –ü–†–ò –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò.";
            }
        }

        function grantAccess() {
            displayUsername.textContent = currentUsername;
            loginScreen.classList.add('hidden');
            mainInterface.classList.remove('hidden');
            subscribeToMessages();
            messageInput.focus();
            playTone(800, 0.1); 
        }

        // --- –ß–ê–°–¢–¨ 2: –¢–ï–ö–°–¢–û–í–´–ô –ß–ê–¢ –ò –ù–û–í–´–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ---
        window.switchChannel = function(channelName) {
            currentChannel = channelName;
            
            document.querySelectorAll('#text-channels li').forEach(li => {
                li.classList.remove('channel-active');
                if (li.dataset.channel === channelName) li.classList.add('channel-active');
            });
            document.getElementById('channel-title').textContent = `>> #${channelName.toUpperCase()}_HUB`;
            
            playTone(1200, 0.05);
            subscribeToMessages();
        }

        function subscribeToMessages() {
            if (messagesUnsubscribe) messagesUnsubscribe();

            // –û—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è, –∞ –Ω–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            const q = collection(db, 'artifacts', appId, 'public', 'data', 'messages');

            messagesUnsubscribe = onSnapshot(q, (snapshot) => {
                const allMessages = [];
                snapshot.forEach(doc => {
                    allMessages.push({ id: doc.id, ...doc.data() });
                });

                const channelMessages = allMessages
                    .filter(m => m.channel === currentChannel)
                    .sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));

                renderMessages(channelMessages);
            }, (error) => {
                console.error("SLAX DATA ERROR:", error);
                if (error.code === 'permission-denied') {
                    addSystemMessage("–û–®–ò–ë–ö–ê: –ù–ï–î–û–°–¢–ê–¢–û–ß–ù–û –ü–†–ê–í. –ü–†–û–í–ï–†–¨–¢–ï –ü–†–ê–í–ò–õ–ê FIRESTORE.", true);
                } else {
                    addSystemMessage("–û–®–ò–ë–ö–ê: –°–û–ï–î–ò–ù–ï–ù–ò–ï –ü–†–ï–†–í–ê–ù–û.", true);
                }
            });
        }

        function renderMessages(messages) {
            // –û—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            // NOTE: –û—Å—Ç–∞–≤–ª—è–µ–º 3 —Å—Ç–∞—Ä—Ç–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è, –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏ –≤ HTML,
            // —á—Ç–æ–±—ã –Ω–µ —É–¥–∞–ª—è—Ç—å –∏—Ö –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–µ.
            const staticMessages = Array.from(chatContainer.querySelectorAll('.system-msg'));
            chatContainer.innerHTML = '';
            staticMessages.forEach(msg => chatContainer.appendChild(msg));
            
            messages.forEach(msg => {
                const div = document.createElement('div');
                const date = msg.timestamp ? new Date(msg.timestamp.seconds * 1000) : new Date();
                const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                const isMe = msg.user === currentUsername;
                
                div.innerHTML = `
                    <div class="hover:bg-green-900/10 p-1 -mx-1 rounded">
                        <span class="timestamp font-mono text-green-700">[${timeStr}]</span>
                        <span class="${isMe ? 'text-green-300 font-bold' : 'text-green-500'}">&lt;${msg.user}&gt;</span>
                        <span class="text-green-100 whitespace-pre-wrap ml-2">${msg.text}</span>
                    </div>
                `;
                chatContainer.appendChild(div);
            });
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        /**
         * –î–æ–±–∞–≤–ª—è–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–∏—Å—Ç–µ–º–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.
         * @param {string} text - –¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.
         * @param {boolean} [isError=false] - –ï—Å–ª–∏ true, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç.
         */
        function addSystemMessage(text, isError = false) {
            const notification = document.createElement('div');
            notification.className = `notification-item text-sm border-l-4 pl-2 ${isError ? 'text-red-300 border-red-500' : 'text-green-300 border-green-500'}`;
            notification.textContent = `>> –°–ò–°–¢–ï–ú–ê: ${text}`;
            
            // –î–æ–±–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            notificationArea.appendChild(notification);

            // –¢–∞–π–º–µ—Ä –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ
            setTimeout(() => {
                // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è
                notification.classList.add('fade-out');
                
                // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
                setTimeout(() => {
                    notification.remove();
                }, 200); // –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ transition –≤ CSS
            }, 2500); // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤–∏—Å–∏—Ç 2.5 —Å–µ–∫—É–Ω–¥—ã
        }


        messageInput.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
                const text = messageInput.value.trim();
                if (!text) return;
                
                if (!currentUsername || currentUsername === 'GUEST') {
                    addSystemMessage("–û–®–ò–ë–ö–ê: –ù–ï –ê–í–¢–û–†–ò–ó–û–í–ê–ù. –¢–†–ï–ë–£–ï–¢–°–Ø –í–•–û–î.", true);
                    return;
                }

                messageInput.value = '';
                
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), {
                        text: text,
                        user: currentUsername,
                        uid: currentUser.uid,
                        channel: currentChannel,
                        timestamp: serverTimestamp()
                    });
                    playTone(600, 0.03);
                } catch (err) {
                    console.error("Send error", err);
                    addSystemMessage("–û–®–ò–ë–ö–ê –û–¢–ü–†–ê–í–ö–ò.", true);
                }
            }
        });


        // --- –ß–ê–°–¢–¨ 3: WEB-RTC / –ì–û–õ–û–°–û–í–û–ô –ß–ê–¢ / –°–ò–ì–ù–ê–õ–ò–ó–ê–¶–ò–Ø (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ leaveVoice) ---

        const voiceRef = (channel) => collection(db, 'artifacts', appId, 'public', 'data', 'voice_sessions', channel, 'users');
        const userSignalRef = (uid) => doc(db, 'artifacts', appId, 'public', 'data', 'voice_signals', uid);

        window.handleVoiceAction = function(voiceId) {
            if (currentVoiceChannel === voiceId) {
                leaveVoice();
            } else {
                joinVoice(voiceId);
            }
        };

        async function joinVoice(voiceId) {
            if (!currentUser) return;
            if (currentVoiceChannel) await leaveVoice();
            
            currentVoiceChannel = voiceId;
            voiceStatusPanel.classList.remove('hidden');
            currentVoiceName.textContent = voiceId.toUpperCase();

            addSystemMessage(`–ó–ê–•–í–ê–¢ –ú–ò–ö–†–û–§–û–ù–ê...`);
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: false, audio: true });
                document.getElementById('local-video').srcObject = localStream;
                micToggleButton.textContent = 'üé§ MIC: ON';
                isMicMuted = false;

                // –ï—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞, –¥–æ–±–∞–≤–ª—è–µ–º –µ–µ —Ç—Ä–µ–∫–∏ –≤ PeerConnections
                if (screenShareStream) {
                    screenShareStream.getTracks().forEach(track => localStream.addTrack(track));
                }

                await setDoc(doc(voiceRef(voiceId), currentUser.uid), {
                    username: currentUsername,
                    uid: currentUser.uid,
                    joinedAt: serverTimestamp(),
                    isScreenSharing: !!screenShareStream,
                    isMicMuted: false
                });

                subscribeToVoiceSession(voiceId);
                subscribeToSignaling();

                addSystemMessage(`–ì–û–õ–û–°–û–í–û–ô –£–ó–ï–õ ${voiceId.toUpperCase()} –ê–ö–¢–ò–í–ï–ù.`);
                playTone(400, 0.1);
                setTimeout(() => playTone(600, 0.2), 150);

            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ GS:", err);
                addSystemMessage("–û–®–ò–ë–ö–ê: –ù–ï –£–î–ê–õ–û–°–¨ –ó–ê–•–í–ê–¢–ò–¢–¨ –ú–ò–ö–†–û–§–û–ù. –ü–†–û–í–ï–†–¨–¢–ï –†–ê–ó–†–ï–®–ï–ù–ò–Ø.", true);
                leaveVoice(); // –í—ã–∑—ã–≤–∞–µ–º leaveVoice –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            }
        }
        
        // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø LEAVE VOICE
        window.leaveVoice = async function() {
            if (!currentVoiceChannel) {
                addSystemMessage(`–û–®–ò–ë–ö–ê: –í–´ –ù–ï –ü–û–î–ö–õ–Æ–ß–ï–ù–´ –ö –ì–û–õ–û–°–û–í–û–ú–£ –ö–ê–ù–ê–õ–£.`, true);
                return;
            }

            const channelToLeave = currentVoiceChannel; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–Ω–∞–ª –ø–µ—Ä–µ–¥ –æ—á–∏—Å—Ç–∫–æ–π
            
            // 1. –û–°–¢–ê–ù–û–í–ö–ê –õ–û–ö–ê–õ–¨–ù–´–• –ü–û–¢–û–ö–û–í
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            if (screenShareStream) {
                screenShareStream.getTracks().forEach(track => track.stop());
                screenShareStream = null;
                screenShareButton.textContent = 'üñ•Ô∏è DEMO SCREEN';
            }

            // 2. –ó–ê–ö–†–´–¢–ò–ï PEER CONNECTIONS
            Object.keys(peerConnections).forEach(uid => {
                const pc = peerConnections[uid];
                pc.close();
                removeRemoteVideo(uid, 'audio');
                removeRemoteVideo(uid, 'screen');
                delete peerConnections[uid];
            });

            // 3. –û–¢–ü–ò–°–ö–ê –û–¢ –í–°–ï–• LISTENER'–û–í
            if (voiceSessionUnsubscribe) {
                voiceSessionUnsubscribe();
                voiceSessionUnsubscribe = null;
            }
            for (const uid in signalUnsubscribes) {
                signalUnsubscribes[uid]();
                delete signalUnsubscribes[uid];
            }
            signalUnsubscribes = {}; // –û—á–∏—Å—Ç–∫–∞ –æ–±—ä–µ–∫—Ç–∞

            // 4. –£–î–ê–õ–ï–ù–ò–ï –°–ï–°–°–ò–ò –ò–ó FIRESTORE
            if (currentUser && channelToLeave) {
                 // –û—á–∏—â–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã
                await setDoc(userSignalRef(currentUser.uid), { cleanup: true, timestamp: serverTimestamp() }).catch(e => console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å —Å–∏–≥–Ω–∞–ª—ã:", e));
                
                // –£–¥–∞–ª—è–µ–º —Å–µ—Å—Å–∏—é
                await deleteDoc(doc(voiceRef(channelToLeave), currentUser.uid)).catch(e => {
                    console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–µ—Å—Å–∏—é:", e);
                    addSystemMessage("–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –û–®–ò–ë–ö–ê –£–î–ê–õ–ï–ù–ò–Ø –°–ï–°–°–ò–ò –ò–ó –ë–î. –ú–û–ñ–ï–¢ –ó–ê–ù–Ø–¢–¨ –í–†–ï–ú–Ø.", true);
                });
            }

            // 5. –û–ß–ò–°–¢–ö–ê –°–û–°–¢–û–Ø–ù–ò–Ø UI
            currentVoiceChannel = null;
            voiceStatusPanel.classList.add('hidden');
            addSystemMessage(`–ì–û–õ–û–°–û–í–û–ô –£–ó–ï–õ –û–¢–ö–õ–Æ–ß–ï–ù.`);
            playTone(300, 0.2);
        }

        // --- WEB-RTC –°–ò–ì–ù–ê–õ–ò–ó–ê–¶–ò–Ø –ò –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–ï–°–°–ò–ï–ô ---

        function subscribeToVoiceSession(voiceId) {
            if (voiceSessionUnsubscribe) voiceSessionUnsubscribe();
            
            const q = voiceRef(voiceId);
            voiceSessionUnsubscribe = onSnapshot(q, (snapshot) => {
                const users = [];
                const currentPeers = new Set(Object.keys(peerConnections));
                const activePeers = new Set();
                
                snapshot.forEach(doc => {
                    const userData = doc.data();
                    if (userData.uid !== currentUser.uid) {
                        users.push(userData.username);
                        activePeers.add(userData.uid);
                        
                        if (!currentPeers.has(userData.uid)) {
                            createPeerConnection(userData.uid, true); 
                        }
                        
                        if (userData.isScreenSharing) {
                            ensureRemoteVideo(userData.uid, userData.username, 'screen');
                        } else {
                            removeRemoteVideo(userData.uid, 'screen');
                        }
                    }
                });

                currentPeers.forEach(uid => {
                    if (!activePeers.has(uid)) {
                        const pc = peerConnections[uid];
                        if (pc) {
                            pc.close();
                        }
                        delete peerConnections[uid];
                        if (signalUnsubscribes[uid]) signalUnsubscribes[uid]();
                        delete signalUnsubscribes[uid];
                        removeRemoteVideo(uid, 'audio');
                        removeRemoteVideo(uid, 'screen');
                    }
                });
                
                const usersHtml = users.map(u => `<div class="text-green-300">> ${u}</div>`).join('');
                const voiceLi = document.querySelector(`li[data-voice="${voiceId}"]`);
                if (voiceLi) {
                    voiceLi.querySelector('.voice-users').innerHTML = usersHtml;
                }
                
            }, (err) => console.error("–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å–µ—Å—Å–∏—é:", err));
        }

        function subscribeToSignaling() {
            const q = userSignalRef(currentUser.uid);
            
            if (signalUnsubscribes['local']) signalUnsubscribes['local']();

            signalUnsubscribes['local'] = onSnapshot(q, async (docSnap) => {
                if (!docSnap.exists() || docSnap.data().cleanup) return;
                
                const data = docSnap.data();

                if (data.offer && data.senderUid !== currentUser.uid) {
                    addSystemMessage(`–ü–†–ò–ù–Ø–¢–û –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï –û–¢ ${data.senderUsername}`);
                    await handleOffer(data.senderUid, data.offer, data.senderUsername);
                    
                } else if (data.answer && data.recipientUid === currentUser.uid) {
                    addSystemMessage(`–ü–†–ò–ù–Ø–¢ –û–¢–í–ï–¢ –û–¢ ${data.senderUsername}`);
                    await handleAnswer(data.senderUid, data.answer);
                    
                } else if (data.candidate && data.recipientUid === currentUser.uid) {
                    await handleCandidate(data.senderUid, data.candidate);
                }
            }, (err) => console.error("–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å–∏–≥–Ω–∞–ª—ã:", err));
        }

        async function createPeerConnection(targetUid, isInitiator) {
            const pc = new RTCPeerConnection(iceServers);
            peerConnections[targetUid] = pc;
            
            if (localStream) {
                // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ —Ç—Ä–µ–∫–∏ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞ (–∞—É–¥–∏–æ + –≤–æ–∑–º–æ–∂–Ω–æ –≤–∏–¥–µ–æ —ç–∫—Ä–∞–Ω–∞)
                localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
            }
            
            pc.ontrack = (event) => {
                const stream = event.streams[0];
                const track = event.track;
                const streamType = track.kind === 'video' ? 'screen' : 'audio';
                const targetUsername = targetUid; // –í—Ä–µ–º–µ–Ω–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º UID, –∏–º—è –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–æ –∏–∑ voiceSession

                if (streamType === 'audio') {
                    ensureRemoteVideo(targetUid, targetUsername, 'audio', stream); 
                } else if (streamType === 'screen') {
                    ensureRemoteVideo(targetUid, targetUsername, 'screen', stream);
                }
            };
            
            pc.onicecandidate = async (event) => {
                if (event.candidate) {
                    await sendSignal({
                        candidate: event.candidate.toJSON(),
                        senderUid: currentUser.uid,
                        senderUsername: currentUsername,
                        recipientUid: targetUid,
                        type: 'candidate'
                    }, targetUid);
                }
            };

            if (isInitiator) {
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                await sendSignal({
                    offer: pc.localDescription.toJSON(),
                    senderUid: currentUser.uid,
                    senderUsername: currentUsername,
                    recipientUid: targetUid,
                    type: 'offer'
                }, targetUid);
            }
        }

        async function handleOffer(senderUid, offer, senderUsername) {
            if (peerConnections[senderUid]) {
                peerConnections[senderUid].close();
            }
            
            const pc = new RTCPeerConnection(iceServers);
            peerConnections[senderUid] = pc;
            
            if (localStream) {
                localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
            }
            
            pc.ontrack = (event) => {
                const stream = event.streams[0];
                const track = event.track;
                const streamType = track.kind === 'video' ? 'screen' : 'audio';

                if (streamType === 'audio') {
                    ensureRemoteVideo(senderUid, senderUsername, 'audio', stream);
                } else if (streamType === 'screen') {
                    ensureRemoteVideo(senderUid, senderUsername, 'screen', stream);
                }
            };

            pc.onicecandidate = async (event) => {
                if (event.candidate) {
                    await sendSignal({
                        candidate: event.candidate.toJSON(),
                        senderUid: currentUser.uid,
                        senderUsername: currentUsername,
                        recipientUid: senderUid,
                        type: 'candidate'
                    }, senderUid);
                }
            };

            await pc.setRemoteDescription(new RTCSessionDescription(offer));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            
            await sendSignal({
                answer: pc.localDescription.toJSON(),
                senderUid: currentUser.uid,
                senderUsername: currentUsername,
                recipientUid: senderUid,
                type: 'answer'
            }, senderUid);
        }

        async function handleAnswer(senderUid, answer) {
            const pc = peerConnections[senderUid];
            if (pc && pc.signalingState !== 'stable') {
                await pc.setRemoteDescription(new RTCSessionDescription(answer));
            }
        }

        async function handleCandidate(senderUid, candidate) {
            const pc = peerConnections[senderUid];
            if (pc) {
                try {
                    await pc.addIceCandidate(new RTCIceCandidate(candidate));
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ICE-–∫–∞–Ω–¥–∏–¥–∞—Ç–∞:', e);
                }
            }
        }
        
        async function sendSignal(signalData, targetUid) {
            const recipientDoc = userSignalRef(targetUid);
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º setDoc –¥–ª—è –∑–∞–ø–∏—Å–∏ —Å–∏–≥–Ω–∞–ª–∞
                await setDoc(recipientDoc, signalData, { merge: true });
            } catch (e) {
                console.error(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–∏–≥–Ω–∞–ª–∞ –∫ ${targetUid}:`, e);
            }
        }

        // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ú–ò–ö–†–û–§–û–ù–û–ú –ò –≠–ö–†–ê–ù–û–ú ---

        window.toggleMic = function() {
            if (!localStream) return;
            isMicMuted = !isMicMuted;
            
            localStream.getAudioTracks().forEach(track => {
                track.enabled = !isMicMuted;
            });

            micToggleButton.textContent = isMicMuted ? 'üé§ MIC: OFF' : 'üé§ MIC: ON';
            addSystemMessage(isMicMuted ? '–ú–ò–ö–†–û–§–û–ù –í–´–ö–õ–Æ–ß–ï–ù.' : '–ú–ò–ö–†–û–§–û–ù –í–ö–õ–Æ–ß–ï–ù.');
            playTone(1000, 0.05);

            if (currentVoiceChannel) {
                updateDoc(doc(voiceRef(currentVoiceChannel), currentUser.uid), {
                    isMicMuted: isMicMuted
                });
            }
        }

        window.toggleScreenShare = async function() {
            if (screenShareStream) {
                // –ï—Å–ª–∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–∞, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
                screenShareStream.getTracks().forEach(track => track.stop());
                screenShareStream = null;
                screenShareButton.textContent = 'üñ•Ô∏è DEMO SCREEN';
                addSystemMessage('–î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –≠–ö–†–ê–ù–ê –ó–ê–í–ï–†–®–ï–ù–ê.');
                
                // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ –∞—É–¥–∏–æ —Ç—Ä–µ–∫ –¥–ª—è –≤—Å–µ—Ö PeerConnections
                if (localStream) {
                    localStream.getTracks().forEach(track => {
                        if (track.kind === 'audio') {
                             Object.values(peerConnections).forEach(pc => {
                                const sender = pc.getSenders().find(s => s.track && s.track.kind === 'audio');
                                if (sender) {
                                    sender.replaceTrack(track);
                                } else {
                                     pc.addTrack(track, localStream);
                                }
                             });
                        }
                    });
                }
            } else {
                // –ò–Ω–∞—á–µ, –∑–∞–ø—É—Å–∫–∞–µ–º –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é
                try {
                    screenShareStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
                    screenShareButton.textContent = 'üñ•Ô∏è DEMO: ACTIVE';
                    addSystemMessage('–ù–ê–ß–ê–¢–ê –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –≠–ö–†–ê–ù–ê.');
                    
                    const videoTrack = screenShareStream.getVideoTracks()[0];
                    const audioTrack = screenShareStream.getAudioTracks()[0];

                    Object.values(peerConnections).forEach(pc => {
                        // –ó–∞–º–µ–Ω—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –≤–∏–¥–µ–æ-—Ç—Ä–µ–∫ (–µ—Å–ª–∏ –æ–Ω –±—ã–ª) –Ω–∞ –Ω–æ–≤—ã–π —Ç—Ä–µ–∫ —ç–∫—Ä–∞–Ω–∞
                        let videoSender = pc.getSenders().find(s => s.track && s.track.kind === 'video');
                        if (videoSender) {
                            videoSender.replaceTrack(videoTrack);
                        } else {
                            // –ï—Å–ª–∏ –Ω–µ—Ç, –¥–æ–±–∞–≤–ª—è–µ–º –∫–∞–∫ –Ω–æ–≤—ã–π —Ç—Ä–µ–∫
                            pc.addTrack(videoTrack, screenShareStream);
                        }
                        
                        // –ï—Å–ª–∏ –≤ –ø–æ—Ç–æ–∫–µ –µ—Å—Ç—å –∞—É–¥–∏–æ, –∑–∞–º–µ–Ω—è–µ–º –∏–ª–∏ –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ
                        if (audioTrack) {
                            let audioSender = pc.getSenders().find(s => s.track && s.track.kind === 'audio');
                            if (audioSender) {
                                audioSender.replaceTrack(audioTrack);
                            } else {
                                pc.addTrack(audioTrack, screenShareStream);
                            }
                        }
                    });

                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ –±—Ä–∞—É–∑–µ—Ä–µ)
                    videoTrack.onended = () => {
                        if (screenShareStream) toggleScreenShare();
                    };

                } catch (err) {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞—Ö–≤–∞—Ç–∞ —ç–∫—Ä–∞–Ω–∞:", err);
                    addSystemMessage("–û–®–ò–ë–ö–ê: –ù–ï –£–î–ê–õ–û–°–¨ –ó–ê–•–í–ê–¢–ò–¢–¨ –≠–ö–†–ê–ù. –ü–†–û–í–ï–†–¨–¢–ï –†–ê–ó–†–ï–®–ï–ù–ò–Ø.", true);
                    screenShareStream = null;
                }
            }

            if (currentVoiceChannel) {
                updateDoc(doc(voiceRef(currentVoiceChannel), currentUser.uid), {
                    isScreenSharing: !!screenShareStream
                });
            }
        }

        // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –£–î–ê–õ–ï–ù–ù–´–ú –í–ò–î–ï–û (–î–í–ò–ñ–£–©–ï–ï–°–Ø –û–ö–ù–û) ---

        function ensureRemoteVideo(uid, username, streamType, stream = null) {
            const isScreen = streamType === 'screen';
            const id = `${uid}-${streamType}`;
            let videoElement = document.getElementById(id);

            if (isScreen) {
                if (!videoElement) {
                    const wrapper = document.createElement('div');
                    wrapper.id = id;
                    wrapper.className = 'draggable-window';
                    wrapper.style.left = `${Math.random() * 50 + 10}vw`; 
                    wrapper.style.top = `${Math.random() * 30 + 10}vh`;

                    wrapper.innerHTML = `
                        <div class="draggable-header" data-drag-id="${id}">
                            <span>DEMO | ${username}</span>
                            <span class="text-red-500 cursor-pointer" onclick="removeRemoteVideo('${uid}', 'screen')">[ X ]</span>
                        </div>
                        <video autoplay class="draggable-video"></video>
                    `;
                    mainContentArea.appendChild(wrapper);
                    videoElement = wrapper.querySelector('video');
                    setupDragging(wrapper);
                    addSystemMessage(`–ü–û–õ–£–ß–ï–ù –ü–û–¢–û–ö –≠–ö–†–ê–ù–ê –û–¢ ${username}.`);
                }

                if (stream) {
                    videoElement.srcObject = stream;
                }
            } else {
                if (!videoElement && stream) {
                    // –ê—É–¥–∏–æ–ø–æ—Ç–æ–∫ - –Ω–µ–≤–∏–¥–∏–º—ã–π —ç–ª–µ–º–µ–Ω—Ç
                    videoElement = document.createElement('audio'); // –ò–∑–º–µ–Ω–µ–Ω–æ –Ω–∞ audio
                    videoElement.id = id;
                    videoElement.autoplay = true;
                    videoElement.style.display = 'none';
                    videoElement.srcObject = stream;
                    document.body.appendChild(videoElement);
                    addSystemMessage(`–ü–û–õ–£–ß–ï–ù –ê–£–î–ò–û –ü–û–¢–û–ö –û–¢ ${username}.`);
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Ç–æ–∫, –µ—Å–ª–∏ –æ–Ω —É–∂–µ –µ—Å—Ç—å (–¥–ª—è –∞—É–¥–∏–æ —ç—Ç–æ –æ–±—ã—á–Ω–æ –Ω–µ –Ω—É–∂–Ω–æ, –Ω–æ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏)
                if (videoElement && stream) {
                    videoElement.srcObject = stream;
                }
            }
        }

        window.removeRemoteVideo = function(uid, streamType) {
            const id = `${uid}-${streamType}`;
            const element = document.getElementById(id);
            if (element) {
                if (streamType === 'screen') {
                    addSystemMessage(`–ü–û–¢–û–ö –≠–ö–†–ê–ù–ê –û–¢ ${uid} –ü–†–ï–†–í–ê–ù.`);
                } 
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ —Ç—Ä–µ–∫–∏ –≤ –ø–æ—Ç–æ–∫–µ (–µ—Å–ª–∏ —ç—Ç–æ –≤–∏–¥–µ–æ/–∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç)
                const stream = element.srcObject;
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }

                element.remove();
            }
        }

        // --- –õ–û–ì–ò–ö–ê –ü–ï–†–ï–¢–ê–°–ö–ò–í–ê–ù–ò–Ø (DRAG-AND-DROP) ---
        function setupDragging(element) {
            const header = element.querySelector('.draggable-header');
            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            let xOffset = 0;
            let yOffset = 0;

            // –ü–æ–ª—É—á–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —ç–ª–µ–º–µ–Ω—Ç–∞
            const style = window.getComputedStyle(element);
            const matrix = new DOMMatrixReadOnly(style.transform);
            xOffset = matrix.m41;
            yOffset = matrix.m42;
            
            header.addEventListener('mousedown', dragStart);
            document.addEventListener('mouseup', dragEnd);
            document.addEventListener('mousemove', drag);
            
            header.addEventListener('touchstart', dragStart);
            document.addEventListener('touchend', dragEnd);
            document.addEventListener('touchmove', drag);

            function dragStart(e) {
                if (e.button !== 0 && e.type !== 'touchstart') return;
                
                let clientX = e.clientX || e.touches[0].clientX;
                let clientY = e.clientY || e.touches[0].clientY;

                initialX = clientX - xOffset;
                initialY = clientY - yOffset;
                
                isDragging = true;
                element.classList.add('opacity-75');
                e.preventDefault();
            }

            function dragEnd(e) {
                if (isDragging) {
                    xOffset = currentX;
                    yOffset = currentY;
                }
                isDragging = false;
                element.classList.remove('opacity-75');
            }

            function drag(e) {
                if (!isDragging) return;

                let clientX = e.clientX || e.touches[0].clientX;
                let clientY = e.clientY || e.touches[0].clientY;

                currentX = clientX - initialX;
                currentY = clientY - initialY;

                // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ mainContentArea
                const parentRect = mainContentArea.getBoundingClientRect();
                const elementRect = element.getBoundingClientRect();

                let newLeft = currentX;
                let newTop = currentY;
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä–∞–Ω–∏—Ü (—Å–ª–µ–≤–∞ –∏ —Å–≤–µ—Ä—Ö—É)
                if (newLeft < 0) newLeft = 0;
                if (newTop < 0) newTop = 0;

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä–∞–Ω–∏—Ü (—Å–ø—Ä–∞–≤–∞ –∏ —Å–Ω–∏–∑—É)
                if (newLeft + elementRect.width > parentRect.width) {
                    newLeft = parentRect.width - elementRect.width;
                }
                if (newTop + elementRect.height > parentRect.height) {
                    newTop = parentRect.height - elementRect.height;
                }
                
                currentX = newLeft;
                currentY = newTop;
                
                element.style.transform = `translate3d(${currentX}px, ${currentY}px, 0)`;
            }
        }
        
        // --- UTILS (–ó–≤—É–∫) ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const ctx = new AudioContext();
        
        function playTone(freq, dur) {
            try {
                if(ctx.state === 'suspended') ctx.resume();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.type = 'square';
                osc.frequency.value = freq;
                gain.gain.value = 0.03;
                osc.start();
                osc.stop(ctx.currentTime + dur);
            } catch(e) {}
        }
    </script>
</body>
</html>
