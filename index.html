<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Простой Мессенджер (Firebase Firestore)</title>
    <!-- Загрузка Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Настройка шрифта Inter -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .scrollable {
            max-height: calc(100vh - 300px); /* Adjust height for mobile/desktop view */
            overflow-y: auto;
        }
        /* Стили для скроллбара */
        .scrollable::-webkit-scrollbar {
            width: 8px;
        }
        .scrollable::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
    </style>
</head>
<body class="h-screen flex antialiased text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 bg-white/70 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
            <p id="loading-message" class="mt-4 text-indigo-600 font-medium">Загрузка Firebase и Аутентификация...</p>
        </div>
    </div>

    <!-- Основной контейнер мессенджера -->
    <div id="app" class="flex flex-col md:flex-row w-full h-full hidden bg-white shadow-xl rounded-2xl md:p-4">
        
        <!-- Sidebar (Список друзей) -->
        <div class="w-full md:w-1/3 flex flex-col p-4 bg-gray-50 border-r border-gray-200 rounded-l-2xl">
            <div class="mb-4 pb-4 border-b border-gray-200">
                <h2 class="text-xl font-bold text-indigo-700">Мой ID</h2>
                <div id="user-id-display" class="break-all text-sm bg-indigo-100 p-2 rounded-lg mt-1 font-mono cursor-pointer" title="Нажмите, чтобы скопировать">
                    Ожидание аутентификации...
                </div>
            </div>

            <!-- Добавление друга -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-2">Добавить друга</h3>
                <div class="flex space-x-2">
                    <input type="text" id="friend-id-input" placeholder="Введите ID друга" class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                    <button id="add-friend-btn" class="bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 transition duration-150">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </button>
                </div>
                <p id="friend-status-message" class="text-sm mt-2"></p>
            </div>

            <!-- Список чатов/друзей -->
            <h3 class="text-lg font-semibold mb-3 text-indigo-700">Мои Друзья (<span id="friend-count">0</span>)</h3>
            <div id="friend-list" class="flex-grow scrollable space-y-2">
                <p class="text-gray-500 text-sm">Друзья будут отображаться здесь.</p>
            </div>
        </div>

        <!-- Main Chat Area (Область сообщений) -->
        <div class="w-full md:w-2/3 flex flex-col bg-white rounded-r-2xl">
            <div id="chat-header" class="p-4 border-b border-gray-200 bg-white shadow-sm flex-shrink-0">
                <h2 id="current-chat-name" class="text-xl font-bold text-gray-700">Выберите друга для начала чата</h2>
            </div>
            
            <!-- Сообщения -->
            <div id="messages" class="flex-grow p-4 space-y-4 overflow-y-auto scrollable">
                <p class="text-center text-gray-400 mt-20">Начните общение, выбрав друга из списка.</p>
            </div>
            
            <!-- Поле ввода сообщения -->
            <div id="message-input-container" class="p-4 border-t border-gray-200 bg-gray-50 flex-shrink-0 hidden">
                <div class="flex space-x-3">
                    <input type="text" id="message-input" placeholder="Напишите сообщение..." class="flex-grow p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500" disabled>
                    <button id="send-message-btn" class="bg-indigo-600 text-white p-3 rounded-xl hover:bg-indigo-700 transition duration-150 disabled:bg-indigo-300" disabled>
                        Отправить
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Modules -->
    <script type="module">
        // Импорт необходимых модулей Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            getDocs, 
            addDoc, 
            serverTimestamp,
            limit,
            // orderBy // Убран, так как требует создания индекса
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Установим уровень логирования для отладки
        setLogLevel('Debug'); 
        
        // =========================================================================================
        // --- !!! ОБЯЗАТЕЛЬНО ЗАМЕНИТЕ ЭТИ ЗНАЧЕНИЯ НА СВОЮ КОНФИГУРАЦИЮ FIRESTORE !!! ---
        // =========================================================================================
        const USER_FIREBASE_CONFIG = {
            apiKey: "AIzaSyDrib0Q4O1QJsYAFkSkIJCT1yX17NeTtFE", // <-- ВСТАВЬТЕ ВАШ API КЛЮЧ
            authDomain: "fir-l-f10e8.firebaseapp.com", // <-- ВСТАВЬТЕ ВАШ АДРЕС (Например, 'my-chat-app-123.firebaseapp.com')
            projectId: "fir-l-f10e8", // <-- ВСТАВЬТЕ ID ВАШЕГО ПРОЕКТА
            storageBucket: "fir-l-f10e8.firebasestorage.app",
            messagingSenderId: "382881410062",
            appId: "1:382881410062:web:ba5d005920e57f6b30a05f"
        };
        // Используйте фиксированный ID приложения для внешнего хостинга, чтобы данные не пересекались
        const EXTERNAL_APP_ID = "external-chat-app-id-12345"; 
        // =========================================================================================

        // --- Глобальные переменные из среды Canvas (с fallback) ---
        let app;
        let db;
        let auth;
        let userId = null;
        let currentFriendId = null;
        let currentChatSnapshotUnsubscribe = null;
        
        // Определяем переменные, используя данные Canvas (если есть) или Fallback (ваши ключи)
        const appId = typeof __app_id !== 'undefined' ? __app_id : EXTERNAL_APP_ID;
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : USER_FIREBASE_CONFIG;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Элементы DOM
        const appContainer = document.getElementById('app');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingMessage = document.getElementById('loading-message');
        const userIdDisplay = document.getElementById('user-id-display');
        const friendIdInput = document.getElementById('friend-id-input');
        const addFriendBtn = document.getElementById('add-friend-btn');
        const friendStatusMessage = document.getElementById('friend-status-message');
        const friendList = document.getElementById('friend-list');
        const messagesContainer = document.getElementById('messages');
        const chatHeader = document.getElementById('chat-header');
        const currentChatName = document.getElementById('current-chat-name');
        const messageInputContainer = document.getElementById('message-input-container');
        const messageInput = document.getElementById('message-input');
        const sendMessageBtn = document.getElementById('send-message-btn');

        // --- Вспомогательные функции для Firebase и Путей ---

        /**
         * Генерирует уникальный ID чата путем сортировки двух ID пользователей.
         * Это гарантирует, что чат между A и B будет иметь тот же ID, что и между B и A.
         * @param {string} id1 Первый ID пользователя.
         * @param {string} id2 Второй ID пользователя.
         * @returns {string} Уникальный отсортированный ID чата.
         */
        function getChatId(id1, id2) {
            return [id1, id2].sort().join('_');
        }

        /**
         * Возвращает путь к коллекции публичных данных.
         * @param {string} collectionName Имя коллекции.
         * @returns {string} Полный путь.
         */
        function getPublicCollectionPath(collectionName) {
            return `artifacts/${appId}/public/data/${collectionName}`;
        }

        /**
         * Возвращает путь к коллекции приватных данных пользователя.
         * @param {string} collectionName Имя коллекции.
         * @param {string} currentUserId ID текущего пользователя.
         * @returns {string} Полный путь.
         */
        function getPrivateCollectionPath(collectionName, currentUserId) {
            return `artifacts/${appId}/users/${currentUserId}/${collectionName}`;
        }

        // --- Инициализация и Аутентификация ---

        async function initializeFirebase() {
            // Проверка, что пользователь вставил свои настройки
            if (!firebaseConfig || firebaseConfig.apiKey === "YOUR_API_KEY") {
                console.error("Firebase config is missing!");
                loadingMessage.textContent = 'Ошибка: Необходимо вставить свой ключ API Firebase в код!';
                loadingOverlay.classList.remove('hidden');
                return;
            }

            try {
                // Инициализация
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Аутентификация
                if (initialAuthToken) {
                    // Используем для среды Canvas
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Используем для внешнего развертывания (анонимный вход)
                    await signInAnonymously(auth);
                }

                // Слушатель состояния аутентификации
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        
                        // Скрываем загрузочный экран и показываем приложение
                        loadingOverlay.classList.add('hidden');
                        appContainer.classList.remove('hidden');

                        // 1. Устанавливаем публичный профиль пользователя
                        setUserProfile(userId);
                        
                        // 2. Начинаем слушать список друзей
                        listenToFriendships(userId);

                    } else {
                        userIdDisplay.textContent = 'Не аутентифицирован';
                    }
                });
                
            } catch (error) {
                console.error("Ошибка при инициализации или аутентификации Firebase:", error);
                // Более информативное сообщение об ошибке на экране:
                loadingMessage.textContent = `Ошибка Firebase: ${error.message}. Проверьте консоль.`;
                loadingOverlay.classList.remove('hidden');
            }
        }

        // 1. Установка публичного профиля пользователя
        async function setUserProfile(uid) {
            const userDocRef = doc(db, getPublicCollectionPath('users'), uid);
            try {
                // Устанавливаем базовый профиль, если он не существует
                await setDoc(userDocRef, { 
                    username: `User_${uid.substring(0, 5)}`, 
                    lastActive: serverTimestamp() 
                }, { merge: true });
            } catch (e) {
                console.error("Ошибка установки профиля пользователя:", e);
                // ВАЖНО: Если тут ошибка, это 99% правила безопасности!
                console.error("ПРОВЕРЬТЕ ПРАВИЛА БЕЗОПАСНОСТИ FIRESTORE: Не удалось установить публичный профиль.");
            }
        }

        // 2. Слушатель списка друзей
        function listenToFriendships(currentUserId) {
            const friendshipsPath = getPrivateCollectionPath('friendships', currentUserId);
            const q = collection(db, friendshipsPath);

            onSnapshot(q, (snapshot) => {
                friendList.innerHTML = '';
                const friends = [];

                snapshot.forEach(doc => {
                    friends.push(doc.data());
                });

                document.getElementById('friend-count').textContent = friends.length;

                if (friends.length === 0) {
                    friendList.innerHTML = '<p class="text-gray-500 text-sm p-2">У вас пока нет друзей. Добавьте кого-нибудь по ID!</p>';
                    return;
                }

                friends.forEach(friend => {
                    const friendElement = createFriendElement(friend.friendId);
                    friendList.appendChild(friendElement);

                    // Если друг, которого мы сейчас добавляем, является текущим выбранным, обновим его активный статус
                    if (currentFriendId === friend.friendId) {
                        friendElement.classList.add('bg-indigo-100', 'border-indigo-400');
                    }
                });
            }, (error) => {
                console.error("Ошибка при получении списка друзей:", error);
                // ВАЖНО: Если тут ошибка, это 99% правила безопасности!
                console.error("ПРОВЕРЬТЕ ПРАВИЛА БЕЗОПАСНОСТИ FIRESTORE: Не удалось получить список друзей.");
                friendList.innerHTML = `<p class="text-red-500 text-sm p-2">Ошибка загрузки друзей: ${error.message}. Возможно, проблема с правилами безопасности.</p>`;
            });
        }

        /**
         * Создает элемент списка для друга.
         * @param {string} friendUid ID друга.
         * @returns {HTMLElement} Элемент друга.
         */
        function createFriendElement(friendUid) {
            const friendItem = document.createElement('div');
            friendItem.className = 'p-3 rounded-xl cursor-pointer hover:bg-indigo-50 border border-gray-200 transition duration-150 flex items-center justify-between';
            friendItem.dataset.id = friendUid;
            friendItem.innerHTML = `
                <div class="font-medium truncate">
                    Друг ID: <span class="text-indigo-600 font-mono">${friendUid.substring(0, 8)}...</span>
                </div>
                <div class="text-xs text-gray-500">
                    <span class="inline-block w-2 h-2 mr-1 bg-green-500 rounded-full"></span> Онлайн
                </div>
            `;
            friendItem.onclick = () => selectFriend(friendUid);
            return friendItem;
        }

        // --- Логика Добавления Друга ---

        addFriendBtn.addEventListener('click', async () => {
            const friendId = friendIdInput.value.trim();
            if (!friendId) {
                showMessage(friendStatusMessage, 'Пожалуйста, введите ID друга.', 'text-red-500');
                return;
            }
            if (friendId === userId) {
                showMessage(friendStatusMessage, 'Нельзя добавить самого себя!', 'text-yellow-600');
                return;
            }

            // 1. Проверим, существует ли пользователь с таким ID (проверяем публичный профиль)
            const friendUserDocRef = doc(db, getPublicCollectionPath('users'), friendId);
            // Используем getDoc для проверки существования документа
            try {
                const friendDocSnapshot = await getDoc(friendUserDocRef);

                if (!friendDocSnapshot.exists()) {
                    showMessage(friendStatusMessage, 'Пользователь с таким ID не найден.', 'text-red-500');
                    return;
                }
            } catch (e) {
                console.error("Ошибка при проверке профиля друга:", e);
                showMessage(friendStatusMessage, `Ошибка при проверке ID друга: ${e.message}`, 'text-red-500');
                return;
            }
            
            // 2. Добавляем в список друзей
            try {
                const friendshipDocRef = doc(db, getPrivateCollectionPath('friendships', userId), friendId);
                await setDoc(friendshipDocRef, {
                    friendId: friendId,
                    addedAt: serverTimestamp()
                });

                showMessage(friendStatusMessage, `Друг ID (${friendId.substring(0, 5)}...) успешно добавлен!`, 'text-green-600');
                friendIdInput.value = ''; // Очистить поле
            } catch (e) {
                console.error("Ошибка при добавлении друга:", e);
                console.error("ПРОВЕРЬТЕ ПРАВИЛА БЕЗОПАСНОСТИ FIRESTORE: Не удалось добавить друга.");
                showMessage(friendStatusMessage, `Ошибка при добавлении: ${e.message}`, 'text-red-500');
            }
        });

        /**
         * Отображает временное сообщение о статусе.
         * @param {HTMLElement} element Элемент для отображения сообщения.
         * @param {string} message Текст сообщения.
         * @param {string} className CSS класс для стиля (например, 'text-green-500').
         */
        function showMessage(element, message, className) {
            element.textContent = message;
            element.className = `text-sm mt-2 ${className}`;
            setTimeout(() => {
                element.textContent = '';
                element.className = 'text-sm mt-2';
            }, 3000);
        }

        // --- Логика Выбора Друга и Чата ---

        function selectFriend(friendUid) {
            // Отменить подписку на предыдущий чат
            if (currentChatSnapshotUnsubscribe) {
                currentChatSnapshotUnsubscribe();
            }

            currentFriendId = friendUid;
            const chatId = getChatId(userId, currentFriendId);
            
            // Обновление UI
            currentChatName.textContent = `Чат с ID: ${friendUid.substring(0, 8)}...`;
            messagesContainer.innerHTML = '';
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            messageInputContainer.classList.remove('hidden');
            messageInput.disabled = false;
            sendMessageBtn.disabled = false;
            messageInput.focus();

            // Сброс стилей для всех друзей и выделение выбранного
            document.querySelectorAll('#friend-list > div').forEach(el => {
                el.classList.remove('bg-indigo-100', 'border-indigo-400');
            });
            const selectedFriendEl = document.querySelector(`[data-id="${friendUid}"]`);
            if (selectedFriendEl) {
                selectedFriendEl.classList.add('bg-indigo-100', 'border-indigo-400');
            }

            // Начать слушать новый чат
            listenToChatMessages(chatId);
        }

        // --- Логика Сообщений (Real-time) ---

        function listenToChatMessages(chatId) {
            const messagesPath = getPublicCollectionPath('chats');
            // Запрос: фильтруем по chatId, ограничиваем 50 сообщениями.
            const q = query(
                collection(db, messagesPath),
                where('chatId', '==', chatId),
                limit(50) 
            );

            // Сохраняем функцию отписки для использования при смене чата
            currentChatSnapshotUnsubscribe = onSnapshot(q, (snapshot) => {
                let messages = [];
                snapshot.forEach(doc => {
                    messages.push({ id: doc.id, ...doc.data() });
                });

                // Сортировка в JS, так как orderBy() может требовать индекс
                messages.sort((a, b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0));

                messagesContainer.innerHTML = ''; // Очистить контейнер перед обновлением
                
                messages.forEach(msg => {
                    const isMyMessage = msg.senderId === userId;
                    const msgElement = createMessageElement(msg, isMyMessage);
                    messagesContainer.appendChild(msgElement);
                });

                // Прокрутка вниз
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

            }, (error) => {
                console.error("Ошибка при получении сообщений:", error);
                console.error("ПРОВЕРЬТЕ ПРАВИЛА БЕЗОПАСНОСТИ FIRESTORE: Не удалось получить сообщения.");
                messagesContainer.innerHTML = `<p class="text-red-500 text-sm p-2">Ошибка загрузки сообщений: ${error.message}. Возможно, проблема с правилами безопасности.</p>`;
            });
        }

        /**
         * Создает элемент DOM для одного сообщения.
         * @param {Object} message Объект сообщения.
         * @param {boolean} isMyMessage True, если сообщение от текущего пользователя.
         * @returns {HTMLElement} Элемент сообщения.
         */
        function createMessageElement(message, isMyMessage) {
            const time = message.timestamp ? new Date(message.timestamp.seconds * 1000).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }) : 'сейчас';
            const senderName = isMyMessage ? 'Вы' : `Друг ID (${message.senderId.substring(0, 4)}...)`;

            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isMyMessage ? 'justify-end' : 'justify-start'}`;
            
            messageDiv.innerHTML = `
                <div class="max-w-xs md:max-w-md lg:max-w-lg p-3 rounded-xl shadow-md ${isMyMessage ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-gray-200 text-gray-800 rounded-tl-none'}">
                    <div class="text-xs font-semibold mb-1 ${isMyMessage ? 'text-indigo-200' : 'text-gray-600'}">${senderName}</div>
                    <p class="whitespace-pre-wrap">${message.text}</p>
                    <span class="block text-right text-xs mt-1 ${isMyMessage ? 'text-indigo-300' : 'text-gray-500'}">${time}</span>
                </div>
            `;
            return messageDiv;
        }

        // --- Отправка Сообщения ---

        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !currentFriendId || !userId) return;

            const chatId = getChatId(userId, currentFriendId);
            const messagesPath = getPublicCollectionPath('chats');

            try {
                await addDoc(collection(db, messagesPath), {
                    chatId: chatId,
                    senderId: userId,
                    text: text,
                    timestamp: serverTimestamp()
                });
                messageInput.value = ''; // Очистка поля
                messagesContainer.scrollTop = messagesContainer.scrollHeight; // Прокрутка вниз
            } catch (e) {
                console.error("Ошибка при отправке сообщения:", e);
                console.error("ПРОВЕРЬТЕ ПРАВИЛА БЕЗОПАСНОСТИ FIRESTORE: Не удалось отправить сообщение.");
                // В реальном приложении здесь было бы уведомление
            }
        }

        sendMessageBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // --- Копирование ID пользователя ---
        userIdDisplay.addEventListener('click', () => {
            const textToCopy = userIdDisplay.textContent;
            if (textToCopy && textToCopy !== 'Ожидание аутентификации...') {
                // Использование устаревшего execCommand для совместимости с iFrame
                const tempInput = document.createElement('textarea');
                tempInput.value = textToCopy;
                document.body.appendChild(tempInput);
                tempInput.select();
                try {
                    document.execCommand('copy');
                    showMessage(userIdDisplay, 'ID скопирован!', 'text-green-600 font-bold');
                } catch (err) {
                    console.error('Не удалось скопировать текст: ', err);
                }
                document.body.removeChild(tempInput);
                
                // Сброс сообщения
                setTimeout(() => {
                    userIdDisplay.textContent = userId;
                    userIdDisplay.className = 'break-all text-sm bg-indigo-100 p-2 rounded-lg mt-1 font-mono cursor-pointer';
                }, 2000);
            }
        });

        // Запуск инициализации при загрузке страницы
        window.onload = initializeFirebase;
    </script>

</body>
</html>
