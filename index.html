<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SLAX_TERMINAL_V5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    
    <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º CDN –≤–µ—Ä—Å–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ –±—Ä–∞—É–∑–µ—Ä–µ –±–µ–∑ —Å–±–æ—Ä—â–∏–∫–∞ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, setDoc, doc, query, onSnapshot, serverTimestamp, getDocs, where, limit, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
        const firebaseConfig = {
            apiKey: "AIzaSyC5IfNWuv-8lR5PGvM-5zXxLap3EVa6rDk",
            authDomain: "myconsolechat.firebaseapp.com",
            projectId: "myconsolechat",
            storageBucket: "myconsolechat.firebasestorage.app",
            messagingSenderId: "686599654568",
            appId: "1:686599654568:web:2c190df85c4f7780ca069d",
            measurementId: "G-7B38TF6NH7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'slax-console-v1'; 

        // WebRTC Config: –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–µ–¥–æ—Å—Ç—É–ø–Ω—ã–µ Google STUN-—Å–µ—Ä–≤–µ—Ä—ã
        const iceServers = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
            ]
        };

        // --- –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Å–µ—Å—Å–∏–∏ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ ---
        let localSessionId = sessionStorage.getItem('slax_session_id');
        if (!localSessionId) {
            localSessionId = crypto.randomUUID();
            sessionStorage.setItem('slax_session_id', localSessionId);
        }
        
        // --- –°–û–°–¢–û–Ø–ù–ò–ï ---
        let currentUser = null; 
        let currentUsername = "GUEST"; 
        let authMode = 'login'; 
        let currentChannel = "main";
        let messagesUnsubscribe = null; 
        
        let localStream = null;         // –ü–æ—Ç–æ–∫ –¥–ª—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
        let screenStream = null;        // –ü–æ—Ç–æ–∫ –¥–ª—è —ç–∫—Ä–∞–Ω–∞
        let isSharingScreen = false;
        let screenSenders = {};         // { targetSessionId: RTCRtpSender –¥–ª—è –≤–∏–¥–µ–æ-—Ç—Ä–µ–∫–∞ —ç–∫—Ä–∞–Ω–∞ }

        let currentVoiceChannel = null;

        // WebRTC –°–æ—Å—Ç–æ—è–Ω–∏–µ
        const peerConnections = {}; // { targetSessionId: RTCPeerConnection }
        let voiceSessionUnsubscribe = null;
        let signalUnsubscribes = {}; // { targetSessionId: unsubscribeFunction }
        let isMicMuted = false;
        
        let isSidebarOpen = false;

        // --- DOM –≠–õ–ï–ú–ï–ù–¢–´ ---
        const loginScreen = document.getElementById('login-screen');
        const mainInterface = document.getElementById('main-interface');
        const usernameInput = document.getElementById('username-input');
        const pinInput = document.getElementById('pin-input');
        const authMainBtn = document.getElementById('auth-main-btn');
        const authSwitchBtn = document.getElementById('auth-switch-btn');
        const authModeTitle = document.getElementById('auth-mode-title');
        const loginError = document.getElementById('login-error');
        const chatContainer = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const displayUsername = document.getElementById('display-username');
        const displayUid = document.getElementById('display-uid');
        const voiceStatusPanel = document.getElementById('voice-status-panel');
        const currentVoiceName = document.getElementById('current-voice-name');
        const micToggleButton = document.getElementById('mic-toggle-btn');
        const screenToggleButton = document.getElementById('screen-toggle-btn');
        const notificationArea = document.getElementById('notification-area'); 
        const sidebar = document.getElementById('sidebar'); 
        const sidebarBackdrop = document.getElementById('sidebar-backdrop'); 
        const floatingVideosContainer = document.getElementById('floating-videos-container');


        // --- –õ–û–ì–ò–ö–ê –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–ò ---
        window.toggleSidebar = function() {
            isSidebarOpen = !isSidebarOpen;
            if (isSidebarOpen) {
                sidebar.classList.remove('-translate-x-full');
                sidebar.classList.add('translate-x-0');
                sidebarBackdrop.classList.remove('hidden');
            } else {
                sidebar.classList.remove('translate-x-0');
                sidebar.classList.add('-translate-x-full');
                sidebarBackdrop.classList.add('hidden');
            }
        }
        
        // --- –ß–ê–°–¢–¨ 1: –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ---
        async function initAuth() {
            try {
                await signInAnonymously(auth);
            } catch (e) {
                console.error("SLAX AUTH ERROR:", e);
                loginError.textContent = "–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –°–ë–û–ô –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò FIREBASE.";
            }
        }
        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                displayUid.textContent = `SID: ${localSessionId.slice(0, 8).toUpperCase()}`; 
                loginError.textContent = "–°–û–ï–î–ò–ù–ï–ù–ò–ï –£–°–¢–ê–ù–û–í–õ–ï–ù–û. –í–í–ï–î–ò–¢–ï –î–ê–ù–ù–´–ï.";
            }
        });

        authMainBtn.addEventListener('click', handleAuthAction);
        authSwitchBtn.addEventListener('click', toggleAuthMode);
        pinInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleAuthAction();
        });
        
        function toggleAuthMode() {
            authMode = authMode === 'login' ? 'register' : 'login';
            if (authMode === 'login') {
                authModeTitle.textContent = ">> LOG IN REQUIRED";
                authMainBtn.textContent = "[ CONNECT ]";
                authSwitchBtn.textContent = "[ SWITCH TO REGISTER ]";
            } else {
                authModeTitle.textContent = ">> REGISTER NEW USER";
                authMainBtn.textContent = "[ CREATE USER ]";
                authSwitchBtn.textContent = "[ SWITCH TO LOG IN ]";
            }
            loginError.textContent = "–í–í–ï–î–ò–¢–ï –î–ê–ù–ù–´–ï.";
            playTone(1500, 0.05);
        }

        function handleAuthAction() {
            if (authMode === 'login') {
                attemptLogin();
            } else {
                attemptRegistration();
            }
        }

        async function validateInput(name, pin) {
            if (!currentUser) {
                loginError.textContent = "–û–®–ò–ë–ö–ê: –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø FIREBASE –û–ñ–ò–î–ê–ï–¢–°–Ø.";
                return false;
            }
            if (!name || name.length < 3 || name.length > 12) {
                loginError.textContent = "–û–®–ò–ë–ö–ê: –ù–ò–ö–ù–ï–ô–ú –î–û–õ–ñ–ï–ù –ë–´–¢–¨ 3-12 –°–ò–ú–í–û–õ–û–í.";
                return false;
            }
            if (!pin || pin.length !== 4 || isNaN(pin)) {
                loginError.textContent = "–û–®–ò–ë–ö–ê: –ü–ò–ù –î–û–õ–ñ–ï–ù –ë–´–¢–¨ 4 –¶–ò–§–†–´.";
                return false;
            }
            return true;
        }

        async function attemptLogin() {
            const name = usernameInput.value.trim().toUpperCase();
            const pin = pinInput.value.trim();
            
            if (!await validateInput(name, pin)) return;

            loginError.textContent = "–ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø...";
            const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'app_users');
            const q = query(usersRef, where('username', '==', name), limit(1));
            
            try {
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    loginError.textContent = "–û–®–ò–ë–ö–ê: –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –ù–ï –ù–ê–ô–î–ï–ù. –ó–ê–†–ï–ì–ò–°–¢–†–ò–†–£–ô–¢–ï–°–¨.";
                    playTone(200, 0.3);
                    return;
                }
                
                const userData = snapshot.docs[0].data();
                if (userData.pin === pin) {
                    currentUsername = name;
                    grantAccess();
                } else {
                    loginError.textContent = "–û–®–ò–ë–ö–ê: –ü–ò–ù-–ö–û–î –ù–ï–í–ï–†–ï–ù.";
                    playTone(200, 0.3);
                }

            } catch (err) {
                console.error("DB Login Error:", err);
                loginError.textContent = "–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ë–î: –°–ú. –ö–û–ù–°–û–õ–¨.";
            }
        }

        async function attemptRegistration() {
            const name = usernameInput.value.trim().toUpperCase();
            const pin = pinInput.value.trim();
            
            if (!await validateInput(name, pin)) return;

            loginError.textContent = "–ü–û–ü–´–¢–ö–ê –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò...";
            const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'app_users');
            const q = query(usersRef, where('username', '==', name), limit(1));

            try {
                const snapshot = await getDocs(q);

                if (!snapshot.empty) {
                    loginError.textContent = "–û–®–ò–ë–ö–ê: –ù–ò–ö–ù–ï–ô–ú –ó–ê–ù–Ø–¢.";
                    playTone(200, 0.3);
                    return;
                }

                await setDoc(doc(usersRef, name), {
                    username: name,
                    pin: pin,
                    createdAt: serverTimestamp()
                });
                
                currentUsername = name;
                loginError.textContent = `–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ ${name} –£–°–ü–ï–®–ù–û –°–û–ó–î–ê–ù.`;
                grantAccess();

            } catch (err) {
                console.error("DB Registration Error:", err);
                loginError.textContent = "–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ë–î –ü–†–ò –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò.";
            }
        }

        function grantAccess() {
            displayUsername.textContent = currentUsername;
            loginScreen.classList.add('hidden');
            mainInterface.classList.remove('hidden');
            switchChannel(currentChannel); // –ò–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –æ–±–Ω–æ–≤–∏—Ç—å UI
            messageInput.focus();
            playTone(800, 0.1); 
        }

        // --- –ß–ê–°–¢–¨ 2: –¢–ï–ö–°–¢–û–í–´–ô –ß–ê–¢ –ò –ù–û–í–´–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ---
        window.switchChannel = function(channelName) {
            currentChannel = channelName;
            
            document.querySelectorAll('#text-channels li').forEach(li => {
                li.classList.remove('channel-active');
                if (li.dataset.channel === channelName) li.classList.add('channel-active');
            });
            document.getElementById('channel-title').textContent = `>> #${channelName.toUpperCase()}_HUB`;
            
            playTone(1200, 0.05);
            subscribeToMessages();
            
            if (isSidebarOpen && window.innerWidth < 768) {
                toggleSidebar();
            }
        }

        function subscribeToMessages() {
            if (messagesUnsubscribe) messagesUnsubscribe();

            const q = collection(db, 'artifacts', appId, 'public', 'data', 'messages');

            messagesUnsubscribe = onSnapshot(q, (snapshot) => {
                const allMessages = [];
                snapshot.forEach(doc => {
                    allMessages.push({ id: doc.id, ...doc.data() });
                });

                const channelMessages = allMessages
                    .filter(m => m.channel === currentChannel)
                    .sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));

                renderMessages(channelMessages);
            }, (error) => {
                console.error("SLAX DATA ERROR:", error);
                if (error.code === 'permission-denied') {
                    addSystemMessage("–û–®–ò–ë–ö–ê: –ù–ï–î–û–°–¢–ê–¢–û–ß–ù–û –ü–†–ê–í. –ü–†–û–í–ï–†–¨–¢–ï –ü–†–ê–í–ò–õ–ê FIRESTORE.", true);
                } else {
                    addSystemMessage("–û–®–ò–ë–ö–ê: –°–û–ï–î–ò–ù–ï–ù–ò–ï –ü–†–ï–†–í–ê–ù–û.", true);
                }
            });
        }

        function renderMessages(messages) {
            const staticMessages = Array.from(chatContainer.querySelectorAll('.system-msg'));
            chatContainer.innerHTML = '';
            staticMessages.forEach(msg => chatContainer.appendChild(msg));
            
            messages.forEach(msg => {
                const div = document.createElement('div');
                const date = msg.timestamp ? new Date(msg.timestamp.seconds * 1000) : new Date();
                const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                const isMe = msg.user === currentUsername;
                
                div.innerHTML = `
                    <div class="hover:bg-green-900/10 p-1 -mx-1 rounded">
                        <span class="timestamp font-mono text-green-700">[${timeStr}]</span>
                        <span class="${isMe ? 'text-green-300 font-bold' : 'text-green-500'}">&lt;${msg.user}&gt;</span>
                        <span class="text-green-100 whitespace-pre-wrap ml-2">${msg.text}</span>
                    </div>
                `;
                chatContainer.appendChild(div);
            });
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addSystemMessage(text, isError = false) {
            const notification = document.createElement('div');
            notification.className = `notification-item text-sm border-l-4 pl-2 ${isError ? 'text-red-300 border-red-500' : 'text-green-300 border-green-500'}`;
            notification.textContent = `>> –°–ò–°–¢–ï–ú–ê: ${text}`;
            
            notificationArea.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('fade-out');
                
                setTimeout(() => {
                    notification.remove();
                }, 200); 
            }, 2500); 
        }


        messageInput.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
                const text = messageInput.value.trim();
                if (!text) return;
                
                if (!currentUsername || currentUsername === 'GUEST') {
                    addSystemMessage("–û–®–ò–ë–ö–ê: –ù–ï –ê–í–¢–û–†–ò–ó–û–í–ê–ù. –¢–†–ï–ë–£–ï–¢–°–Ø –í–•–û–î.", true);
                    return;
                }

                messageInput.value = '';
                
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), {
                        text: text,
                        user: currentUsername,
                        uid: currentUser.uid,
                        channel: currentChannel,
                        timestamp: serverTimestamp()
                    });
                    playTone(600, 0.03);
                } catch (err) {
                    console.error("Send error", err);
                    addSystemMessage("–û–®–ò–ë–ö–ê –û–¢–ü–†–ê–í–ö–ò.", true);
                }
            }
        });


        // --- –ß–ê–°–¢–¨ 3: WEB-RTC / –ì–û–õ–û–°–û–í–û–ô –ß–ê–¢ –ò –≠–ö–†–ê–ù ---

        const voiceRef = (channel) => collection(db, 'artifacts', appId, 'public', 'data', 'voice_sessions', channel, 'users');
        
        // --- –ö–õ–Æ–ß–ï–í–û–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–¥–∫–æ–ª–ª–µ–∫—Ü–∏—é –¥–ª—è –≤—Ö–æ–¥—è—â–∏—Ö —Å–∏–≥–Ω–∞–ª–æ–≤ (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –Ω–∞ –∫–∞–∂–¥—ã–π —Å–∏–≥–Ω–∞–ª) ---
        const signalingCollectionRef = (sessionId) => collection(db, 'artifacts', appId, 'public', 'data', 'voice_signals', sessionId, 'incoming_signals'); 

        window.handleVoiceAction = function(voiceId) {
            if (currentVoiceChannel === voiceId) {
                leaveVoice();
            } else {
                joinVoice(voiceId);
            }
            if (isSidebarOpen && window.innerWidth < 768) {
                toggleSidebar();
            }
        };

        async function joinVoice(voiceId) {
            if (!currentUser) return;
            if (currentVoiceChannel) await leaveVoice();
            
            currentVoiceChannel = voiceId;
            voiceStatusPanel.classList.remove('hidden');
            currentVoiceName.textContent = voiceId.toUpperCase();

            addSystemMessage(`–ó–ê–•–í–ê–¢ –ú–ò–ö–†–û–§–û–ù–ê...`);
            try {
                // –ó–∞—Ö–≤–∞—Ç—ã–≤–∞–µ–º –¢–û–õ–¨–ö–û –∞—É–¥–∏–æ
                localStream = await navigator.mediaDevices.getUserMedia({ video: false, audio: true });
                micToggleButton.textContent = 'üé§ MIC: ON';
                isMicMuted = false;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –æ –Ω–∞—à–µ–º –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–∏
                await setDoc(doc(voiceRef(voiceId), localSessionId), {
                    username: currentUsername,
                    sessionId: localSessionId,
                    uid: currentUser.uid, 
                    joinedAt: serverTimestamp(),
                    isMicMuted: false
                });

                subscribeToVoiceSession(voiceId);
                subscribeToSignaling();
                
                addSystemMessage(`–ì–û–õ–û–°–û–í–û–ô –£–ó–ï–õ ${voiceId.toUpperCase()} –ê–ö–¢–ò–í–ï–ù.`);
                playTone(400, 0.1);
                setTimeout(() => playTone(600, 0.2), 150);

            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ GS:", err);
                addSystemMessage("–û–®–ò–ë–ö–ê: –ù–ï –£–î–ê–õ–û–°–¨ –ó–ê–•–í–ê–¢–ò–¢–¨ –ú–ò–ö–†–û–§–û–ù. –ü–†–û–í–ï–†–¨–¢–ï –†–ê–ó–†–ï–®–ï–ù–ò–Ø.", true);
                leaveVoice(); 
            }
        }
        
        window.leaveVoice = async function() {
            if (!currentVoiceChannel) {
                addSystemMessage(`–û–®–ò–ë–ö–ê: –í–´ –ù–ï –ü–û–î–ö–õ–Æ–ß–ï–ù–´ –ö –ì–û–õ–û–°–û–í–û–ú–£ –ö–ê–ù–ê–õ–£.`, true);
                return;
            }
            
            // –ï—Å–ª–∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ–º —ç–∫—Ä–∞–Ω, —Å–Ω–∞—á–∞–ª–∞ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
            if (isSharingScreen) {
                await stopScreenShare();
            }

            const channelToLeave = currentVoiceChannel; 
            
            // 1. –û–°–¢–ê–ù–û–í–ö–ê –õ–û–ö–ê–õ–¨–ù–û–ì–û –ê–£–î–ò–û –ü–û–¢–û–ö–ê
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }

            // 2. –ó–ê–ö–†–´–¢–ò–ï PEER CONNECTIONS –ò –£–î–ê–õ–ï–ù–ò–ï –ê–£–î–ò–û/–í–ò–î–ï–û –≠–õ–ï–ú–ï–ù–¢–û–í
            Object.keys(peerConnections).forEach(sessionId => {
                const pc = peerConnections[sessionId];
                if (pc) pc.close();
                removeMediaWindow(sessionId, true); // –£–¥–∞–ª—è–µ–º –∞—É–¥–∏–æ –∏ –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç—ã
                delete peerConnections[sessionId];
                delete screenSenders[sessionId];
            });

            // 3. –û–¢–ü–ò–°–ö–ê –û–¢ –í–°–ï–• LISTENER'–û–í
            if (voiceSessionUnsubscribe) {
                voiceSessionUnsubscribe();
                voiceSessionUnsubscribe = null;
            }
            
            for (const key in signalUnsubscribes) {
                if(signalUnsubscribes[key]) signalUnsubscribes[key]();
                delete signalUnsubscribes[key];
            }
            signalUnsubscribes = {}; 

            // 4. –£–î–ê–õ–ï–ù–ò–ï –°–ï–°–°–ò–ò –ò–ó FIRESTORE
            if (channelToLeave) {
                await deleteDoc(doc(voiceRef(channelToLeave), localSessionId)).catch(e => {
                    console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–µ—Å—Å–∏—é (–º–æ–∂–µ—Ç –±—ã—Ç—å —É–∂–µ —É–¥–∞–ª–µ–Ω–∞):", e);
                });
            }

            // 5. –û–ß–ò–°–¢–ö–ê –°–û–°–¢–û–Ø–ù–ò–Ø UI
            currentVoiceChannel = null;
            voiceStatusPanel.classList.add('hidden');
            addSystemMessage(`–ì–û–õ–û–°–û–í–û–ô –£–ó–ï–õ –û–¢–ö–õ–Æ–ß–ï–ù.`);
            playTone(300, 0.2);
        }
        
        window.addEventListener('beforeunload', async () => {
            if (currentVoiceChannel) {
                const voiceSessionDocRef = doc(voiceRef(currentVoiceChannel), localSessionId);
                try {
                     // –ò—Å–ø–æ–ª—å–∑—É–µ–º keepalive, —á—Ç–æ–±—ã –±—Ä–∞—É–∑–µ—Ä —É—Å–ø–µ–ª –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å
                     fetch(voiceSessionDocRef.path, { method: 'DELETE', keepalive: true });
                } catch(e) { /* –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ */ }
            }
        });


        // --- WEB-RTC –°–ò–ì–ù–ê–õ–ò–ó–ê–¶–ò–Ø –ò –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–ï–°–°–ò–ï–ô ---

        function subscribeToVoiceSession(voiceId) {
            if (voiceSessionUnsubscribe) voiceSessionUnsubscribe();
            
            const q = voiceRef(voiceId);
            voiceSessionUnsubscribe = onSnapshot(q, (snapshot) => {
                const users = [];
                const currentPeers = new Set(Object.keys(peerConnections));
                const activePeers = new Set();
                
                snapshot.forEach(doc => {
                    const userData = doc.data();
                    if (userData.sessionId !== localSessionId) { 
                        users.push({ username: userData.username, sessionId: userData.sessionId });
                        activePeers.add(userData.sessionId);
                        
                        const pc = peerConnections[userData.sessionId];

                        // –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê: –ï—Å–ª–∏ –Ω–µ—Ç PC –∏–ª–∏ –æ–Ω –∑–∞–∫—Ä—ã—Ç/–ø—Ä–æ–≤–∞–ª–∏–ª—Å—è
                        if (!pc || pc.connectionState === 'closed' || pc.connectionState === 'failed') {
                            const isInitiator = localSessionId < userData.sessionId;
                            createPeerConnection(userData.sessionId, isInitiator); 
                            addSystemMessage(`–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ ${userData.username} –ü–†–ò–°–û–ï–î–ò–ù–ò–õ–°–Ø. (Initiator: ${isInitiator ? 'Yes' : 'No'})`);
                        }
                    }
                });

                // –£–¥–∞–ª–µ–Ω–∏–µ –ø–∏—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã—à–ª–∏
                currentPeers.forEach(sessionId => {
                    if (!activePeers.has(sessionId)) {
                        const pc = peerConnections[sessionId];
                        if (pc) {
                            pc.close();
                        }
                        delete peerConnections[sessionId];
                        delete screenSenders[sessionId]; // –£–¥–∞–ª—è–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –¥–ª—è —ç—Ç–æ–≥–æ –ø–∏—Ä–∞
                        if (signalUnsubscribes[sessionId]) signalUnsubscribes[sessionId]();
                        delete signalUnsubscribes[sessionId];
                        removeMediaWindow(sessionId, true); // –£–¥–∞–ª—è–µ–º –∞—É–¥–∏–æ/–≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç
                        addSystemMessage(`–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ ${sessionId.slice(0, 8).toUpperCase()} –í–´–®–ï–õ.`);
                    }
                });
                
                const usersHtml = users.map(u => `<div class="text-green-300" data-session-id="${u.sessionId}">>> ${u.username}</div>`).join('');
                const voiceLi = document.querySelector(`li[data-voice="${voiceId}"]`);
                if (voiceLi) {
                    voiceLi.querySelector('.voice-users').innerHTML = usersHtml;
                    voiceLi.querySelector('.voice-count').textContent = users.length + 1; 
                }
                
            }, (err) => console.error("–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å–µ—Å—Å–∏—é:", err));
        }
        
        // --- –§–ò–ö–° –°–ü–ê–ú–ê: –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–æ–ª–ª–µ–∫—Ü–∏—é —Å–∏–≥–Ω–∞–ª–æ–≤ (—á–∏—Ç–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º) ---
        function subscribeToSignaling() {
            // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –ø–æ–¥–∫–æ–ª–ª–µ–∫—Ü–∏—é –≤—Ö–æ–¥—è—â–∏—Ö —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è –Ω–∞—à–µ–π —Å–µ—Å—Å–∏–∏
            const q = signalingCollectionRef(localSessionId);
            
            if (signalUnsubscribes['local']) signalUnsubscribes['local']();

            signalUnsubscribes['local'] = onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach(async (change) => {
                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤–Ω–æ–≤—å –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã
                    if (change.type !== 'added') return; 

                    const signalDoc = change.doc;
                    const data = signalDoc.data();
                    
                    if (data.senderSessionId === localSessionId) {
                        // –≠—Ç–æ –Ω–∞—à —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–∏–≥–Ω–∞–ª, –∫–æ—Ç–æ—Ä—ã–π –º—ã –≤–∏–¥–∏–º –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ (–∏–Ω–æ–≥–¥–∞ –±—ã–≤–∞–µ—Ç) - —É–¥–∞–ª—è–µ–º.
                        try { await deleteDoc(signalDoc.ref); } catch(e) { /* ignore */ }
                        return;
                    }

                    if (data.offer) {
                        addSystemMessage(`–ü–†–ò–ù–Ø–¢–û –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï –û–¢ ${data.senderUsername} - –û–ë–†–ê–ë–û–¢–ö–ê...`);
                        await handleOffer(data.senderSessionId, data.offer, data.senderUsername);
                        
                    } else if (data.answer) {
                        addSystemMessage(`–ü–†–ò–ù–Ø–¢ –û–¢–í–ï–¢ –û–¢ ${data.senderUsername} - –û–ë–†–ê–ë–û–¢–ö–ê...`);
                        await handleAnswer(data.senderSessionId, data.answer);
                        
                    } else if (data.candidate) {
                        await handleCandidate(data.senderSessionId, data.candidate);
                    }
                    
                    // –ö–õ–Æ–ß–ï–í–û–ô –§–ò–ö–°: –£–î–ê–õ–ò–¢–¨ –°–ò–ì–ù–ê–õ –ü–û–°–õ–ï –û–ë–†–ê–ë–û–¢–ö–ò (CONSUME)
                    try {
                        await deleteDoc(signalDoc.ref);
                    } catch (e) {
                        console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞ (–≤–æ–∑–º–æ–∂–Ω–æ, —É–∂–µ —É–¥–∞–ª–µ–Ω):", e);
                    }
                });
            }, (err) => console.error("–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å–∏–≥–Ω–∞–ª—ã:", err));
        }

        async function createPeerConnection(targetSessionId, isInitiator) {
            const pc = new RTCPeerConnection(iceServers);
            peerConnections[targetSessionId] = pc;
            
            // --- –î–û–ë–ê–í–õ–ï–ù–ò–ï –¢–†–ï–ö–û–í –ú–ò–ö–†–û–§–û–ù–ê ---
            if (localStream) {
                localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
            }

            // --- –î–û–ë–ê–í–õ–ï–ù–ò–ï –¢–†–ï–ö–û–í –≠–ö–†–ê–ù–ê (–ï–°–õ–ò –î–ï–ú–û–ù–°–¢–†–ò–†–£–ï–ú) ---
            if (screenStream && isSharingScreen) {
                const videoTrack = screenStream.getVideoTracks()[0];
                if (videoTrack) {
                    const sender = pc.addTrack(videoTrack, screenStream);
                    screenSenders[targetSessionId] = sender; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
                }
                screenStream.getAudioTracks().forEach(track => pc.addTrack(track, screenStream));
            }
            
            // --- –û–ë–†–ê–ë–û–¢–ö–ê –í–•–û–î–Ø–©–ï–ì–û –ü–û–¢–û–ö–ê ---
            pc.ontrack = (event) => {
                const stream = event.streams[0];
                const track = event.track;

                // –ù–∞—Ö–æ–¥–∏–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const voiceLi = document.querySelector(`li[data-voice="${currentVoiceChannel}"]`);
                const userDiv = voiceLi ? voiceLi.querySelector(`.voice-users div[data-session-id="${targetSessionId}"]`) : null;
                const targetUsername = userDiv ? userDiv.textContent.replace('>> ', '').trim() : targetSessionId.slice(0, 8).toUpperCase(); 

                if (track.kind === 'audio') {
                    ensureMediaWindow(targetSessionId, targetUsername, stream, 'audio');
                } else if (track.kind === 'video') {
                    ensureMediaWindow(targetSessionId, targetUsername, stream, 'video');
                }
            };

            // --- –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –ü–ï–†–ï–°–û–ì–õ–ê–°–û–í–ê–ù–ò–ï (negotiationneeded) ---
            pc.onnegotiationneeded = async () => {
                if (isInitiator) {
                    try {
                        addSystemMessage(`–ò–ù–ò–¶–ò–ê–¶–ò–Ø –ü–ï–†–ï–°–û–ì–õ–ê–°–û–í–ê–ù–ò–Ø...`);
                        const offer = await pc.createOffer();
                        await pc.setLocalDescription(offer);
                        await sendSignal({
                            offer: pc.localDescription.toJSON(),
                            senderSessionId: localSessionId,
                            senderUsername: currentUsername,
                            type: 'offer'
                        }, targetSessionId);
                    } catch (e) {
                        console.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è/–æ—Ç–ø—Ä–∞–≤–∫–∏ OFFER –≤ onnegotiationneeded:", e);
                    }
                }
            };
            
            // --- –û–ë–†–ê–ë–û–¢–ö–ê ICE-–ö–ê–ù–î–ò–î–ê–¢–û–í ---
            pc.onicecandidate = async (event) => {
                if (event.candidate) {
                    await sendSignal({
                        candidate: event.candidate.toJSON(),
                        senderSessionId: localSessionId,
                        senderUsername: currentUsername,
                        type: 'candidate'
                    }, targetSessionId);
                }
            };
            
            // --- –û–ë–†–ê–ë–û–¢–ö–ê –°–û–°–¢–û–Ø–ù–ò–ô (–î–õ–Ø –î–ï–ë–ê–ì–ê) ---
            pc.oniceconnectionstatechange = () => {
                if (pc.iceConnectionState === 'disconnected' || pc.iceConnectionState === 'failed') {
                    console.log(`ICE State for ${targetSessionId.slice(0, 4)}: ${pc.iceConnectionState}. –ü–æ–ø—ã—Ç–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è...`);
                }
            };
            
            // --- –ò–ù–ò–¶–ò–ò–†–û–í–ê–ù–ò–ï –°–û–ï–î–ò–ù–ï–ù–ò–Ø (OFFER) ---
            if (isInitiator) {
                try {
                    const offer = await pc.createOffer();
                    await pc.setLocalDescription(offer);
                    await sendSignal({
                        offer: pc.localDescription.toJSON(),
                        senderSessionId: localSessionId,
                        senderUsername: currentUsername,
                        type: 'offer'
                    }, targetSessionId);
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è/–æ—Ç–ø—Ä–∞–≤–∫–∏ OFFER:", e);
                }
            }
        }

        async function handleOffer(senderSessionId, offer, senderUsername) {
            let pc = peerConnections[senderSessionId];
            
            if (!pc) {
                // –ï—Å–ª–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω–æ, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ (Responder)
                createPeerConnection(senderSessionId, false);
                pc = peerConnections[senderSessionId];
            }

            if (!pc) return; 

            try {
                if (pc.signalingState !== 'stable') {
                    if (pc.signalingState === 'have-local-offer') {
                         await pc.setLocalDescription({ type: "rollback" });
                    } else if (pc.signalingState !== 'stable' && pc.signalingState !== 'have-remote-offer') {
                        console.warn("–ü–æ–ª—É—á–µ–Ω OFFER –≤ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏, –æ–∂–∏–¥–∞–Ω–∏–µ:", pc.signalingState);
                        return;
                    }
                }
                
                await pc.setRemoteDescription(new RTCSessionDescription(offer));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                
                await sendSignal({
                    answer: pc.localDescription.toJSON(),
                    senderSessionId: localSessionId,
                    senderUsername: currentUsername,
                    type: 'answer'
                }, senderSessionId);
                addSystemMessage(`–û–¢–ü–†–ê–í–õ–ï–ù –û–¢–í–ï–¢ ${senderUsername}.`);
            } catch (e) {
                console.error("–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –û–ë–†–ê–ë–û–¢–ö–ò OFFER:", e);
                addSystemMessage(`–û–®–ò–ë–ö–ê: –°–ë–û–ô –û–ë–†–ê–ë–û–¢–ö–ò –ü–†–ï–î–õ–û–ñ–ï–ù–ò–Ø –û–¢ ${senderUsername}.`, true);
            }
        }

        async function handleAnswer(senderSessionId, answer) {
            const pc = peerConnections[senderSessionId];
            if (!pc) {
                console.warn(`–ü–æ–ª—É—á–µ–Ω ANSWER, –Ω–æ PC –¥–ª—è ${senderSessionId} –Ω–µ –Ω–∞–π–¥–µ–Ω.`);
                return;
            }
            
            if (pc.signalingState === 'have-local-offer') {
                try {
                    await pc.setRemoteDescription(new RTCSessionDescription(answer));
                } catch (e) {
                    console.error("–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –û–ë–†–ê–ë–û–¢–ö–ò ANSWER:", e);
                    addSystemMessage(`–û–®–ò–ë–ö–ê: –°–ë–û–ô –û–ë–†–ê–ë–û–¢–ö–ò –û–¢–í–ï–¢–ê.`, true);
                }
            } else {
                console.warn(`–ü–æ–ª—É—á–µ–Ω ANSWER –≤ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏: ${pc.signalingState}. –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º.`);
            }
        }

        async function handleCandidate(senderSessionId, candidate) {
            const pc = peerConnections[senderSessionId];
            if (pc && pc.remoteDescription) {
                try {
                    await pc.addIceCandidate(new RTCIceCandidate(candidate));
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ICE-–∫–∞–Ω–¥–∏–¥–∞—Ç–∞ (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è):', e);
                }
            }
        }
        
        async function sendSignal(signalData, targetSessionId) {
            if (!targetSessionId || typeof targetSessionId !== 'string') {
                console.warn("Signal Warning: Invalid targetSessionId provided, skipping signal.", targetSessionId);
                return;
            }

            const recipientCollection = signalingCollectionRef(targetSessionId); 
            try {
                await addDoc(recipientCollection, signalData); 
            } catch (e) {
                console.error(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–∏–≥–Ω–∞–ª–∞ –∫ ${targetSessionId}:`, e);
            }
        }
        
        // --- –õ–û–ì–ò–ö–ê –ü–ï–†–ï–¢–ê–°–ö–ò–í–ê–ù–ò–Ø ---
        function makeDraggable(element) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            const dragHeader = element.querySelector('.drag-handle');
            
            if (dragHeader) {
                dragHeader.onmousedown = dragMouseDown;
            } else {
                element.onmousedown = dragMouseDown;
            }

            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                // get the mouse cursor position at startup:
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                // call a function whenever the cursor moves:
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                // calculate the new cursor position:
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                // set the element's new position:
                element.style.top = (element.offsetTop - pos2) + "px";
                element.style.left = (element.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                // stop moving when mouse button is released:
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –£–î–ê–õ–ï–ù–ù–´–ú –ê–£–î–ò–û/–í–ò–î–ï–û (–û–ë–ù–û–í–õ–ï–ù–ò–ï) ---
        
        /**
         * –°–æ–∑–¥–∞–µ—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–ª–∞–≤–∞—é—â–µ–µ –æ–∫–Ω–æ –¥–ª—è –∞—É–¥–∏–æ/–≤–∏–¥–µ–æ.
         * @param {string} sessionId - ID —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
         * @param {string} username - –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
         * @param {MediaStream} stream - –ú–µ–¥–∏–∞-–ø–æ—Ç–æ–∫.
         * @param {string} type - 'audio' –∏–ª–∏ 'video'.
         * @param {boolean} isLocal - –Ø–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ—Ç–æ–∫ –ª–æ–∫–∞–ª—å–Ω—ã–º (–¥–ª—è sharer'–∞).
         */
        function ensureMediaWindow(sessionId, username, stream, type, isLocal = false) {
            const windowId = `window-${sessionId}`;
            const mediaId = `${sessionId}-${type}`;
            let windowElement = document.getElementById(windowId);
            
            if (type === 'audio') {
                // –ê—É–¥–∏–æ –æ—Å—Ç–∞–µ—Ç—Å—è —Å–∫—Ä—ã—Ç—ã–º —ç–ª–µ–º–µ–Ω—Ç–æ–º –≤ —Ç–µ–ª–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
                let audioElement = document.getElementById(mediaId);
                if (!audioElement) {
                    audioElement = document.createElement('audio'); 
                    audioElement.id = mediaId;
                    audioElement.autoplay = true;
                    audioElement.style.display = 'none';
                    document.body.appendChild(audioElement);
                    if (!isLocal) addSystemMessage(`–ü–û–õ–£–ß–ï–ù –ê–£–î–ò–û –ü–û–¢–û–ö –û–¢ ${username}.`);
                }
                audioElement.srcObject = stream;
                return;
            }

            // --- –õ–û–ì–ò–ö–ê –î–õ–Ø –í–ò–î–ï–û (–≠–ö–†–ê–ù) ---
            
            if (!windowElement) {
                // 1. –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –æ–∫–Ω–∞
                windowElement = document.createElement('div');
                windowElement.id = windowId;
                windowElement.className = "floating-window fixed border-2 border-green-700 bg-black/95 shadow-[0_0_15px_rgba(0,255,0,0.5)] z-50 transition-transform duration-300 ease-in-out";
                
                // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º
                const numWindows = document.querySelectorAll('.floating-window').length;
                const offset = (numWindows % 4) * 30; // –°–¥–≤–∏–≥ –¥–ª—è –ª—É—á—à–µ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                windowElement.style.top = `${50 + offset}px`;
                windowElement.style.right = `${50 + offset}px`;

                // 2. –í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ: –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –≤–∏–¥–µ–æ
                const displayUsername = isLocal ? 'YOUR SCREEN' : `${username}'s SCREEN`;
                windowElement.innerHTML = `
                    <div class="drag-handle p-1.5 cursor-move bg-green-900/50 flex justify-between items-center text-xs font-bold border-b border-green-700">
                        <span class="text-green-300">${isLocal ? '>> ' : '<< '}${displayUsername}</span>
                        <button onclick="removeMediaWindow('${sessionId}', true)" class="text-red-500 hover:text-red-300 transition-colors">[ X ]</button>
                    </div>
                    <div class="video-content w-full h-full">
                        <video id="${mediaId}" autoplay playsinline class="w-full h-full object-contain"></video>
                    </div>
                `;
                
                floatingVideosContainer.appendChild(windowElement);
                makeDraggable(windowElement);
                if (!isLocal) addSystemMessage(`–ü–û–õ–£–ß–ï–ù –í–ò–î–ï–û –ü–û–¢–û–ö (–≠–ö–†–ê–ù) –û–¢ ${username}.`);
            }

            // 3. –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫ –∫ —ç–ª–µ–º–µ–Ω—Ç—É <video> –≤–Ω—É—Ç—Ä–∏ –æ–∫–Ω–∞
            const videoElement = windowElement.querySelector('video');
            if (videoElement) {
                videoElement.srcObject = stream;
                
                // –ï—Å–ª–∏ –ø–æ—Ç–æ–∫ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–µ–∫—Ä–∞—Ç–∏–ª –¥–µ–ª–∏—Ç—å—Å—è), —É–¥–∞–ª—è–µ–º –æ–∫–Ω–æ
                stream.getVideoTracks()[0].onended = () => {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ (—Ç.–∫. stopScreenShare() –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π)
                    if (!isLocal) removeMediaWindow(sessionId, true);
                };
            }
        }

        /**
         * –£–¥–∞–ª—è–µ—Ç –ø–ª–∞–≤–∞—é—â–µ–µ –æ–∫–Ω–æ (–∏–ª–∏ —Å–∫—Ä—ã—Ç—ã–π –∞—É–¥–∏–æ-—ç–ª–µ–º–µ–Ω—Ç).
         * @param {string} sessionId - ID —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
         * @param {boolean} isManualClose - –ó–∞–∫—Ä—ã—Ç–æ –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –≤—Ä—É—á–Ω—É—é (–∫–Ω–æ–ø–∫–∞ X).
         */
        window.removeMediaWindow = function(sessionId, isManualClose = false) {
            // 1. –£–¥–∞–ª–µ–Ω–∏–µ –∞—É–¥–∏–æ (—Å–∫—Ä—ã—Ç—ã–π —ç–ª–µ–º–µ–Ω—Ç)
            const audioId = `${sessionId}-audio`;
            const audioElement = document.getElementById(audioId);
            if (audioElement) {
                audioElement.remove();
            }
            
            // 2. –£–¥–∞–ª–µ–Ω–∏–µ –æ–∫–Ω–∞ (–≤–∏–¥–∏–º—ã–π —ç–ª–µ–º–µ–Ω—Ç)
            const windowId = `window-${sessionId}`;
            const windowElement = document.getElementById(windowId);
            if (windowElement) {
                windowElement.remove();
            }

            // 3. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–∫—Ä—ã–ª —Å–≤–æ–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ –≤—Ä—É—á–Ω—É—é, 
            // –Ω–æ –Ω–µ –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É STOP –≤ UI, –º—ã –¥–æ–ª–∂–Ω—ã –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å WebRTC –∏ –ø–æ—Ç–æ–∫.
            if (sessionId === localSessionId && isSharingScreen && isManualClose) {
                stopScreenShare(); 
            }
        }

        // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ú–ò–ö–†–û–§–û–ù–û–ú –ò –≠–ö–†–ê–ù–û–ú ---

        window.toggleMic = function() {
            if (!localStream) return;
            isMicMuted = !isMicMuted;
            
            localStream.getAudioTracks().forEach(track => {
                track.enabled = !isMicMuted;
            });

            micToggleButton.textContent = isMicMuted ? 'üé§ MIC: OFF' : 'üé§ MIC: ON';
            addSystemMessage(isMicMuted ? '–ú–ò–ö–†–û–§–û–ù –í–´–ö–õ–Æ–ß–ï–ù.' : '–ú–ò–ö–†–û–§–û–ù –í–ö–õ–Æ–ß–ï–ù.');
            playTone(1000, 0.05);

            if (currentVoiceChannel) {
                updateDoc(doc(voiceRef(currentVoiceChannel), localSessionId), {
                    isMicMuted: isMicMuted
                });
            }
        }
        
        window.toggleScreenShare = function() {
            if (isSharingScreen) {
                stopScreenShare();
            } else {
                startScreenShare();
            }
        }
        
        async function startScreenShare() {
            if (!currentVoiceChannel) {
                addSystemMessage("–û–®–ò–ë–ö–ê: –°–ù–ê–ß–ê–õ–ê –ü–û–î–ö–õ–Æ–ß–ò–¢–ï–°–¨ –ö –ì–û–õ–û–°–û–í–û–ú–£ –ö–ê–ù–ê–õ–£.", true);
                return;
            }
            if (isSharingScreen) return;

            addSystemMessage("–ó–ê–•–í–ê–¢ –≠–ö–†–ê–ù–ê...");
            try {
                // –ó–∞–ø—Ä–æ—Å –Ω–∞ –∑–∞—Ö–≤–∞—Ç —ç–∫—Ä–∞–Ω–∞ —Å –≤–∏–¥–µ–æ –∏ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∞—É–¥–∏–æ
                const stream = await navigator.mediaDevices.getDisplayMedia({ 
                    video: true, 
                    audio: true 
                });
                
                screenStream = stream;
                isSharingScreen = true;
                screenToggleButton.textContent = 'üñ•Ô∏è SCREEN: ON';
                screenToggleButton.classList.add('bg-green-600', 'hover:bg-green-700');
                screenToggleButton.classList.remove('bg-green-900/20', 'hover:bg-green-800');

                const videoTrack = screenStream.getVideoTracks()[0];
                const audioTrack = screenStream.getAudioTracks()[0];
                
                // 1. –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω –≤ –ø–ª–∞–≤–∞—é—â–µ–º –æ–∫–Ω–µ –¥–ª—è —Å–µ–±—è
                ensureMediaWindow(localSessionId, currentUsername, stream, 'video', true);
                
                // 2. –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–µ–∫–∏ –≤–æ –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ PeerConnections
                Object.keys(peerConnections).forEach(targetSessionId => {
                    const pc = peerConnections[targetSessionId];
                    // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–¥–µ–æ —Ç—Ä–µ–∫ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
                    if (videoTrack) {
                        const sender = pc.addTrack(videoTrack, screenStream);
                        screenSenders[targetSessionId] = sender;
                    }
                    // –î–æ–±–∞–≤–ª—è–µ–º –∞—É–¥–∏–æ —Ç—Ä–µ–∫ —ç–∫—Ä–∞–Ω–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                    if (audioTrack) {
                         pc.addTrack(audioTrack, screenStream);
                    }
                });
                
                // 3. –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ UI –±—Ä–∞—É–∑–µ—Ä–∞
                videoTrack.onended = stopScreenShare;

                addSystemMessage("–î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –≠–ö–†–ê–ù–ê –ù–ê–ß–ê–¢–ê.");
                playTone(1500, 0.1);

            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞—Ö–≤–∞—Ç–∞ —ç–∫—Ä–∞–Ω–∞:", e);
                addSystemMessage("–û–®–ò–ë–ö–ê: –ù–ï –£–î–ê–õ–û–°–¨ –ó–ê–•–í–ê–¢–ò–¢–¨ –≠–ö–†–ê–ù.", true);
                isSharingScreen = false;
                screenToggleButton.textContent = 'üñ•Ô∏è SCREEN: OFF';
                screenToggleButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                screenToggleButton.classList.add('bg-green-900/20', 'hover:bg-green-800');
            }
        }

        async function stopScreenShare() {
            if (!isSharingScreen || !screenStream) return;

            addSystemMessage("–û–°–¢–ê–ù–û–í–ö–ê –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–ò –≠–ö–†–ê–ù–ê...");
            
            // 1. –£–¥–∞–ª—è–µ–º —Ç—Ä–µ–∫–∏ –∏–∑ –≤—Å–µ—Ö PeerConnections
            Object.keys(peerConnections).forEach(targetSessionId => {
                const pc = peerConnections[targetSessionId];
                const videoSender = screenSenders[targetSessionId];
                
                // –£–¥–∞–ª—è–µ–º –≤–∏–¥–µ–æ —Ç—Ä–µ–∫
                if (videoSender) {
                    pc.removeTrack(videoSender);
                    delete screenSenders[targetSessionId];
                }
                
                // –£–¥–∞–ª—è–µ–º –∞—É–¥–∏–æ —Ç—Ä–µ–∫–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å–æ screenStream
                pc.getSenders().forEach(sender => {
                    if (sender.track && screenStream.getAudioTracks().includes(sender.track)) {
                         pc.removeTrack(sender);
                    }
                });
            });

            // 2. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏ –∏ —É–¥–∞–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            screenStream.getTracks().forEach(track => track.stop());
            screenStream = null;
            removeMediaWindow(localSessionId, false); // –£–¥–∞–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            isSharingScreen = false;

            // 3. –û–±–Ω–æ–≤–ª—è–µ–º UI
            screenToggleButton.textContent = 'üñ•Ô∏è SCREEN: OFF';
            screenToggleButton.classList.remove('bg-green-600', 'hover:bg-green-700');
            screenToggleButton.classList.add('bg-green-900/20', 'hover:bg-green-800');
            addSystemMessage("–î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –≠–ö–†–ê–ù–ê –û–°–¢–ê–ù–û–í–õ–ï–ù–ê.");
            playTone(300, 0.1);

            // 4. onnegotiationneeded –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω, —á—Ç–æ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ –Ω–æ–≤–æ–º—É Offer.
        }


        // --- UTILS (–ó–≤—É–∫) ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const ctx = new AudioContext();
        
        function playTone(freq, dur) {
            try {
                if(ctx.state === 'suspended') ctx.resume();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.type = 'square';
                osc.frequency.value = freq;
                gain.gain.value = 0.03;
                osc.start();
                osc.stop(ctx.currentTime + dur);
            } catch(e) {}
        }
    </script>

    <style>
        :root {
            --terminal-green: #0f0;
            --terminal-glow: #0f0;
            --terminal-bg: #050505;
            --scanline: rgba(0, 255, 0, 0.04);
            --header-bg: #111;
        }

        body {
            background-color: var(--terminal-bg);
            color: var(--terminal-green);
            font-family: 'VT323', monospace;
            overflow: hidden;
            text-shadow: 0 0 3px var(--terminal-glow);
            font-size: 1.1rem; 
        }

        @media (min-width: 768px) {
            body {
                font-size: 1.25rem; 
            }
        }

        .scanlines {
            position: fixed;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            background: linear-gradient(
                to bottom,
                var(--scanline) 50%,
                rgba(0, 0, 0, 0) 50%
            );
            background-size: 100% 4px;
            z-index: 50;
        }

        .crt-flicker {
            animation: flicker 0.15s infinite;
            opacity: 0.95;
        }

        @keyframes flicker {
            0% { opacity: 0.97; }
            50% { opacity: 0.94; }
            100% { opacity: 0.97; }
        }

        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track { background: #001100; }
        ::-webkit-scrollbar-thumb { background: #003300; border: 1px solid #0f0; }
        ::-webkit-scrollbar-thumb:hover { background: #0f0; }

        .channel-active {
            background-color: rgba(0, 255, 0, 0.2);
            border-left: 4px solid #0f0;
            padding-left: 8px !important;
        }
        
        input {
            background: transparent;
            border: none;
            color: inherit;
            outline: none;
            font-family: inherit;
            width: 100%;
        }

        .system-msg { color: #88aa88; font-style: italic; font-size: 0.9em; }
        .timestamp { opacity: 0.5; margin-right: 10px; font-size: 0.8em; }
        
        #notification-area {
            position: absolute;
            bottom: 6rem; /* –ù–∞–¥ –ø–æ–ª–µ–º –≤–≤–æ–¥–∞ */
            left: 24px;
            right: 24px;
            z-index: 900;
            pointer-events: none; 
        }
        .notification-item {
            background-color: rgba(0, 50, 0, 0.8);
            border: 1px solid var(--terminal-green);
            padding: 5px 10px;
            margin-bottom: 5px;
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
        }
        .notification-item.fade-out {
            opacity: 0;
            transform: translateY(-10px);
        }

        .slax-loader::before {
            content: '';
            animation: slaxLoad 2s infinite;
        }
        @keyframes slaxLoad {
            0% { content: 'SLAX_KERNEL...'; }
            25% { content: 'LOADING_MODULES...'; }
            50% { content: 'MOUNTING_DRIVES...'; }
            75% { content: 'ESTABLISHING_UPLINK...'; }
        }
        
        #sidebar {
            transition: transform 0.3s ease-in-out;
        }

        /* --- –°–¢–ò–õ–ò –ü–õ–ê–í–ê–Æ–©–ï–ì–û –û–ö–ù–ê –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–ò --- */
        .floating-window {
            /* –ë–∞–∑–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä */
            width: 280px;
            height: 180px; 
            /* –§–æ–Ω –∏ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å */
            background-color: #000000;
            opacity: 0.95;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
            /* –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç–∏ */
            min-width: 200px;
            min-height: 150px;
        }
        
        .floating-window .drag-handle {
            user-select: none;
            background-color: rgba(0, 50, 0, 0.8);
            cursor: move;
        }

        .floating-window video {
            width: 100%;
            height: 100%;
            display: block;
            background: black;
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col crt-flicker">
    <div class="scanlines"></div>

    <!-- –ö–û–ù–¢–ï–ô–ù–ï–† –î–õ–Ø –í–°–ï–• –ü–õ–ê–í–ê–Æ–©–ò–• –í–ò–î–ï–û (–≠–ö–†–ê–ù–û–í) -->
    <div id="floating-videos-container">
        <!-- –ü–ª–∞–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —Å—é–¥–∞ -->
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="absolute inset-0 flex flex-col items-center justify-center bg-black z-40">
        <pre class="text-xs sm:text-base leading-none mb-8 text-center text-green-500 font-bold">
  ____  _        _    __  __ 
 / ___|| |      / \   \ \/ / 
 \___ \| |     / _ \   \  /  
  ___) | |___ / ___ \  /  \  
 |____/|_____/_/   \_\/_/\_\ 
      OPERATING SYSTEM v5.0
        </pre>
        
        <div class="w-11/12 max-w-md p-6 border-2 border-green-800 bg-black/90 shadow-[0_0_20px_rgba(0,255,0,0.2)]">
            <p id="auth-mode-title" class="mb-2 text-green-400 font-bold text-center text-base sm:text-lg">>> LOG IN REQUIRED</p>
            <div class="h-px w-full bg-green-900 mb-4"></div>
            
            <div class="flex items-center mb-4 text-sm sm:text-base">
                <span class="mr-3 whitespace-nowrap">USER:</span>
                <input type="text" id="username-input" class="flex-1 border-b border-green-800 focus:border-green-500" placeholder="enter_callsign" autocomplete="off" maxlength="12">
            </div>
            
            <div class="flex items-center mb-4 text-sm sm:text-base">
                <span class="mr-3 whitespace-nowrap">PIN:</span>
                <input type="password" id="pin-input" class="flex-1 border-b border-green-800 focus:border-green-500" placeholder="enter_4_digit_pin" autocomplete="off" maxlength="4" pattern="\d*">
            </div>
            
            <p id="login-error" class="text-red-500 mt-2 text-xs sm:text-sm text-center">>> –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –°–ò–°–¢–ï–ú–´...</p>
            
            <button id="auth-main-btn" class="mt-6 border border-green-600 px-4 py-2 hover:bg-green-600 hover:text-black transition-all w-full text-center font-bold tracking-widest text-sm sm:text-base">
                [ CONNECT ]
            </button>
            
            <button id="auth-switch-btn" class="mt-3 text-xs opacity-70 hover:opacity-100 transition-opacity w-full text-center">
                [ SWITCH TO REGISTER ]
            </button>

            <div class="mt-4 text-[10px] sm:text-xs text-center opacity-50">
                SECURE CONNECTION: <span class="text-green-300">ENCRYPTED</span>
            </div>
        </div>
    </div>

    <!-- MAIN INTERFACE -->
    <div id="main-interface" class="hidden flex-1 flex h-full relative">
        
        <!-- SIDEBAR BACKDROP (–¢–û–õ–¨–ö–û –î–õ–Ø –ú–û–ë–ò–õ–¨–ù–´–•) -->
        <div id="sidebar-backdrop" onclick="toggleSidebar()" class="hidden md:hidden absolute inset-0 bg-black/50 z-20"></div>

        <!-- SIDEBAR -->
        <div id="sidebar" class="fixed w-64 md:w-72 h-full z-30 
                                  border-r-2 border-green-900 flex flex-col bg-black/95 
                                  -translate-x-full md:translate-x-0 transition-transform duration-300">
            <div class="p-3 border-b-2 border-green-900 bg-[#051105]">
                <div class="font-bold text-lg sm:text-xl tracking-wider">SLAX_OS</div>
                <div class="text-xs opacity-70 flex justify-between mt-1">
                    <span>NET: ONLINE</span>
                    <span>PING: 24ms</span>
                </div>
            </div>
            
            <!-- TEXT CHANNELS -->
            <div class="p-4 flex-1 overflow-y-auto text-sm sm:text-base">
                <div class="mb-8">
                    <h3 class="text-xs font-bold opacity-60 mb-3 tracking-widest border-b border-green-900/50 pb-1">TEXT_PROTOCOLS</h3>
                    <ul id="text-channels" class="space-y-1">
                        <li onclick="switchChannel('main')" class="cursor-pointer p-2 hover:bg-green-900/20 transition-all channel-active" data-channel="main"># MAIN_HUB</li>
                        <li onclick="switchChannel('offtopic')" class="cursor-pointer p-2 hover:bg-green-900/20 transition-all" data-channel="offtopic"># OFFTOPIC</li>
                        <li onclick="switchChannel('dev')" class="cursor-pointer p-2 hover:bg-green-900/20 transition-all" data-channel="dev"># DEV_LOGS</li>
                    </ul>
                </div>

                <!-- VOICE CHANNELS -->
                <div>
                    <h3 class="text-xs font-bold opacity-60 mb-3 tracking-widest border-b border-green-900/50 pb-1">VOICE_UPLINKS</h3>
                    <ul id="voice-channels" class="space-y-2">
                        <li onclick="handleVoiceAction('lobby')" class="cursor-pointer border border-green-900/50 p-2 hover:border-green-500 transition-all group" data-voice="lobby">
                            <div class="flex justify-between items-center">
                                <span>üîä LOBBY</span>
                                <span class="voice-count text-[10px] bg-green-900 px-1 text-black group-hover:bg-green-500">1</span>
                            </div>
                            <div class="voice-users mt-1 pl-2 text-xs opacity-80 border-l border-green-800 ml-1"></div>
                        </li>
                    </ul>
                    
                    <div id="voice-status-panel" class="hidden mt-6 bg-green-900/10 border border-green-500 p-3">
                        <div class="text-[10px] uppercase tracking-widest mb-1 opacity-70">–¢–µ–∫—É—â–∞—è –ß–∞—Å—Ç–æ—Ç–∞</div>
                        <div id="current-voice-name" class="font-bold text-lg mb-2"></div>
                        
                        <!-- –ú–∏–∫—Ä–æ—Ñ–æ–Ω –∏ –≠–∫—Ä–∞–Ω -->
                        <div class="flex space-x-2 mb-3">
                            <button id="mic-toggle-btn" onclick="toggleMic()" class="flex-1 bg-green-900/20 border border-green-800 text-green-400 hover:bg-green-800 hover:text-white transition-colors py-1 text-xs sm:text-sm uppercase">
                                üé§ MIC: ON
                            </button>
                            <button id="screen-toggle-btn" onclick="toggleScreenShare()" class="flex-1 bg-green-900/20 border border-green-800 text-green-400 hover:bg-green-800 hover:text-white transition-colors py-1 text-xs sm:text-sm uppercase">
                                üñ•Ô∏è SCREEN: OFF
                            </button>
                        </div>

                        <button onclick="leaveVoice()" class="w-full bg-red-900/20 border border-red-800 text-red-500 hover:bg-red-900 hover:text-white transition-colors py-1 text-sm uppercase">
                            [ –û–¢–ö–õ–Æ–ß–ò–¢–¨ ]
                        </button>
                    </div>
                </div>
            </div>

            <!-- USER INFO -->
            <div class="p-3 border-t-2 border-green-900 text-sm bg-black">
                <div class="flex items-center">
                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse mr-2"></div>
                    <div>
                        <div id="display-username" class="font-bold tracking-wider">UNKNOWN</div>
                        <div class="text-[10px] opacity-50 font-mono" id="display-uid">SID: ----</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MAIN CHAT AREA -->
        <div id="main-content-area" class="flex-1 flex flex-col relative bg-black md:ml-72 w-full">
            
            <!-- HEADER -->
            <div class="h-14 border-b border-green-900 flex items-center px-4 md:px-6 justify-between bg-[#050905]">
                <button onclick="toggleSidebar()" class="md:hidden text-green-400 text-lg mr-4">[ –ú–ï–ù–Æ ]</button>
                <span id="channel-title" class="text-lg sm:text-xl font-bold tracking-widest">>> #MAIN_HUB</span>
                <div class="flex items-center space-x-4 text-xs">
                    <span class="hidden md:inline slax-loader opacity-50"></span>
                    <span class="border border-green-700 px-2 py-0.5">REC ‚óè</span>
                </div>
            </div>
            
            <!-- MESSAGES -->
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 md:p-6 font-mono space-y-2 text-sm sm:text-base">
                <!-- –ù–∞—á–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ -->
                <div class="system-msg border-l-2 border-green-800 pl-2 my-1">>> –°–ò–°–¢–ï–ú–ê: SLAX KERNEL INITIALIZED...</div>
                <div class="system-msg border-l-2 border-green-800 pl-2 my-1">>> –°–ò–°–¢–ï–ú–ê: CONNECTING TO FIREBASE NODE [myconsolechat]...</div>
                <div class="system-msg border-l-2 border-green-800 pl-2 my-1">>> –°–ò–°–¢–ï–ú–ê: WAITING FOR INPUT...</div>
            </div>
            
            <!-- –í–†–ï–ú–ï–ù–ù–´–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø -->
            <div id="notification-area">
                <!-- –°—é–¥–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∏ —É–¥–∞–ª—è—Ç—å—Å—è —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è -->
            </div>

            <!-- INPUT AREA -->
            <div class="p-3 sm:p-4 bg-black border-t border-green-900">
                <div class="flex items-center bg-green-900/10 border border-green-800 p-2 focus-within:border-green-500 transition-colors">
                    <span class="mr-3 text-green-500 font-bold whitespace-nowrap text-sm sm:text-base">root@slax:~#</span>
                    <input type="text" id="message-input" placeholder="execute_command..." autocomplete="off" class="text-sm sm:text-base">
                </div>
                <div class="text-[10px] opacity-30 mt-1 text-right">SLAX_MESSENGER v5.0 // DO NOT DISTRIBUTE</div>
            </div>
        </div>
    </div>
</body>
</html>
