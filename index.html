<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Slax_</title>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
        import { getDatabase, ref, onValue, set, update, push, get } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js';

        // Your Firebase config (with explicit databaseURL to fix the warning)
        const firebaseConfig = {
            apiKey: "AIzaSyAHkdr6tAaUplSieZuK8r7bVu62tJPLjII",
            authDomain: "slax-chat.firebaseapp.com",
            databaseURL: "https://slax-chat-default-rtdb.firebaseio.com/",
            projectId: "slax-chat",
            storageBucket: "slax-chat.firebasestorage.app",
            messagingSenderId: "1045228942622",
            appId: "1:1045228942622:web:2b6e94819ea912edd0c50f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
    </script>
    <style>
        body {
            background-color: #222;
            color: #0f0;
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        #main {
            display: flex;
            height: calc(100% - 60px);
        }
        #sidebar {
            width: 30%;
            border-right: 1px solid #0f0;
            padding: 10px;
            overflow-y: auto;
        }
        #search {
            background: transparent;
            color: #0f0;
            border: none;
            width: 100%;
            font-size: 16px;
        }
        #chat {
            width: 70%;
            padding: 10px;
            overflow-y: auto;
        }
        #input-area {
            position: fixed;
            bottom: 0;
            left: 30%;
            width: 70%;
            background: #111;
            border-top: 1px solid #0f0;
            padding: 5px;
            display: flex;
            align-items: center;
        }
        #message-input {
            background: transparent;
            color: #0f0;
            border: none;
            flex: 1;
            font-size: 16px;
            outline: none;
        }
        .button {
            color: #0f0;
            background: transparent;
            border: 1px solid #0f0;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            margin: 0 5px;
            padding: 2px 6px;
        }
        .voice-recording {
            color: #f00;
        }
        .audio-player {
            display: inline-block;
            margin-left: 10px;
        }
        .call-controls {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }
        .call-notification {
            background: #333;
            padding: 10px;
            border: 1px solid #f00;
            margin: 5px 0;
        }
        .screen-video {
            width: 100%;
            max-width: 300px;
            margin: 5px 0;
        }
        .local-video {
            width: 100px;
            height: 75px;
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 20;
        }
        .auth-input {
            background: transparent;
            color: #0f0;
            border: none;
            display: block;
            margin: 5px 0;
            width: 100%;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div id="main">
        <div id="sidebar">
            <input id="search" placeholder="> search friends...">
            <div id="profile">
                > my profile <button id="logout" class="button">logout</button>
                <div id="my-id"></div>
            </div>
            <div id="pending-requests">
                > Pending requests:
                <div id="pending-list"></div>
            </div>
            <div id="friends-list">
                > no friends
            </div>
        </div>
        <div id="chat">
            > select friend start chatting...
        </div>
    </div>
    <div id="input-area">
        <input id="message-input" placeholder="> type message...">
        <button id="record-btn" class="button">mic</button>
        <button id="call-btn" class="button" style="display: none;">call</button>
        <span id="record-status"></span>
    </div>

    <script type="module">
        import { getDatabase, ref, onValue, set, update, push, get } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js';

        const db = getDatabase();
        let currentUser = localStorage.getItem('currentUser');
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let callStream = null;
        let screenStream = null;
        let screenVideo = null;
        let localVideo = null;
        let peerConnection = null;
        let dataChannel = null;
        let userData = {}; // Local cache
        let selectedFriend = null;
        let unsubscribeUser = null; // For cleaning up listeners

        // Inactivity check (local)
        const lastVisitKey = 'slax_lastVisit';
        let lastVisit = parseInt(localStorage.getItem(lastVisitKey)) || 0;
        const now = Date.now();
        const THREE_DAYS = 3 * 24 * 60 * 60 * 1000;
        if (currentUser && now - lastVisit > THREE_DAYS) {
            localStorage.removeItem('currentUser');
            currentUser = null;
        }
        localStorage.setItem(lastVisitKey, now.toString());

        function showLogin() {
            console.log('> Showing login screen');
            document.getElementById('chat').innerHTML = `
> Login to Slax_
<input id="username" class="auth-input" placeholder="> username">
<input id="password" type="password" class="auth-input" placeholder="> password">
<button id="auth-btn" class="button">login</button>
<div style="margin-top:10px;">
<button id="toggle-auth" class="button">register</button>
</div>
            `;
            let authMode = 'login';
            document.getElementById('auth-btn').onclick = async () => {
                const user = document.getElementById('username').value.trim();
                const pass = document.getElementById('password').value.trim();
                if (!user || !pass) return alert('> Enter username and password');
                const userRef = ref(db, `users/${user}`);
                const snapshot = await get(userRef);
                const userSnapData = snapshot.val();
                if (authMode === 'login') {
                    if (!userSnapData || userSnapData.password !== pass) return alert('> Invalid credentials');
                    localStorage.setItem('currentUser', user);
                    currentUser = user;
                    localStorage.setItem(lastVisitKey, now.toString());
                    console.log(`> Login successful for ${user}`);
                    initApp();
                } else {
                    if (userSnapData) return alert('> User exists');
                    await set(userRef, {
                        password: pass,
                        friends: [],
                        pendingRequests: [],
                        messages: {},
                        callStates: {}
                    });
                    localStorage.setItem('currentUser', user);
                    currentUser = user;
                    localStorage.setItem(lastVisitKey, now.toString());
                    console.log(`> Registration successful for ${user}`);
                    initApp();
                }
            };
            document.getElementById('toggle-auth').onclick = () => {
                authMode = authMode === 'login' ? 'register' : 'login';
                document.getElementById('auth-btn').textContent = authMode;
                document.getElementById('toggle-auth').textContent = authMode === 'login' ? 'register' : 'login';
            };
            document.getElementById('sidebar').style.display = 'none';
            document.getElementById('input-area').style.display = 'none';
        }

        function initApp() {
            console.log(`> Initializing app for ${currentUser}`);
            document.getElementById('sidebar').style.display = 'block';
            document.getElementById('input-area').style.display = 'flex';
            document.getElementById('my-id').innerText = `> ID: ${currentUser}`;
            document.getElementById('logout').onclick = () => {
                // Always show login on logout, regardless of state
                if (unsubscribeUser) unsubscribeUser();
                localStorage.removeItem('currentUser');
                currentUser = null;
                showLogin(); // Direct call to show login, no reload needed
            };

            const userRef = ref(db, `users/${currentUser}`);
            unsubscribeUser = onValue(userRef, (snapshot) => {
                userData = snapshot.val() || {};
                refreshAll();
            });

            refreshFriends();

            // Text message
            document.getElementById('message-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && selectedFriend) {
                    const msg = e.target.value.trim();
                    if (msg) {
                        sendMessage(msg, 'text');
                    }
                    e.target.value = '';
                }
            });

            // Voice recording
            const recordBtn = document.getElementById('record-btn');
            const recordStatus = document.getElementById('record-status');
            recordBtn.onclick = async () => {
                if (!selectedFriend) return alert('> Select a friend first');
                if (isRecording) {
                    stopRecording();
                } else {
                    startRecording();
                }
            };

            async function startRecording() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const reader = new FileReader();
                        reader.readAsDataURL(audioBlob);
                        reader.onloadend = () => {
                            const base64data = reader.result;
                            sendMessage(base64data, 'voice');
                        };
                        stream.getTracks().forEach(track => track.stop());
                    };

                    mediaRecorder.start();
                    isRecording = true;
                    recordBtn.classList.add('voice-recording');
                    recordBtn.textContent = 'stop';
                    recordStatus.textContent = '> recording...';
                } catch (err) {
                    alert('> Microphone access denied or not available');
                }
            }

            function stopRecording() {
                if (mediaRecorder && isRecording) {
                    mediaRecorder.stop();
                    isRecording = false;
                    recordBtn.classList.remove('voice-recording');
                    recordBtn.textContent = 'mic';
                    recordStatus.textContent = '';
                }
            }

            // Call button
            const callBtn = document.getElementById('call-btn');
            callBtn.onclick = async () => {
                if (!selectedFriend) return alert('> Select a friend first');
                const myCallStateRef = ref(db, `users/${currentUser}/callStates/${selectedFriend}`);
                const snapshot = await get(myCallStateRef);
                const myCallState = snapshot.val() || {status: 'ended'};
                if (myCallState.status === 'ended') {
                    const updates = {};
                    updates[`users/${currentUser}/callStates/${selectedFriend}`] = {status: 'calling', mic: true, screen: false};
                    updates[`users/${selectedFriend}/callStates/${currentUser}`] = {status: 'incoming', mic: false, screen: false};
                    update(ref(db), updates);
                    alert(`> Calling ${selectedFriend}...`);
                } else if (myCallState.status === 'active') {
                    endCall();
                }
            };

            function endCall() {
                if (selectedFriend) {
                    const updates = {};
                    updates[`users/${currentUser}/callStates/${selectedFriend}`] = {status: 'ended', mic: true, screen: false};
                    updates[`users/${selectedFriend}/callStates/${currentUser}`] = {status: 'ended', mic: false, screen: false};
                    update(ref(db), updates);
                    stopLocalStreams();
                    if (peerConnection) {
                        peerConnection.close();
                        peerConnection = null;
                    }
                    if (dataChannel) {
                        dataChannel.close();
                        dataChannel = null;
                    }
                    callBtn.textContent = 'call';
                    if (localVideo) {
                        localVideo.remove();
                        localVideo = null;
                    }
                    refreshChat();
                }
            }

            function stopLocalStreams() {
                if (callStream) {
                    callStream.getTracks().forEach(track => track.stop());
                    callStream = null;
                }
                if (screenStream) {
                    screenStream.getTracks().forEach(track => track.stop());
                    screenStream = null;
                }
                if (screenVideo) {
                    screenVideo.remove();
                    screenVideo = null;
                }
            }

            // Search friends
            document.getElementById('search').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const searchUser = e.target.value.trim();
                    get(ref(db, 'users')).then(snapshot => {
                        const allUsers = snapshot.val();
                        if (searchUser && searchUser !== currentUser && allUsers && allUsers[searchUser]) {
                            get(ref(db, `users/${currentUser}/friends`)).then(fSnap => {
                                const friends = fSnap.val() || [];
                                if (!friends.includes(searchUser)) {
                                    get(ref(db, `users/${currentUser}/pendingRequests`)).then(pSnap => {
                                        const pending = pSnap.val() || [];
                                        if (!pending.includes(searchUser)) {
                                            const updates = {};
                                            const friendPending = allUsers[searchUser].pendingRequests || [];
                                            updates[`users/${searchUser}/pendingRequests`] = [...friendPending, currentUser];
                                            update(ref(db), updates);
                                            alert(`> Friend request sent to ${searchUser}`);
                                        } else {
                                            alert('> Request pending');
                                        }
                                    });
                                } else {
                                    alert('> Already friends');
                                }
                            });
                        } else {
                            alert('> User not found');
                        }
                        e.target.value = '';
                    });
                }
            });
        }

        function sendMessage(content, type) {
            if (!selectedFriend) return;
            const messageObj = {
                from: currentUser,
                type: type,
                content: content,
                time: new Date().toISOString()
            };
            const updates = {};
            let myMsgs = userData.messages[selectedFriend] || [];
            myMsgs.push(messageObj);
            updates[`users/${currentUser}/messages/${selectedFriend}`] = myMsgs;

            let friendMsgs = userData.messages[currentUser] || [];
            friendMsgs.push(messageObj);
            updates[`users/${selectedFriend}/messages/${currentUser}`] = friendMsgs;

            update(ref(db), updates);
            refreshChat();
        }

        function refreshAll() {
            refreshFriends();
            if (selectedFriend) refreshChat();
        }

        function refreshFriends() {
            const fl = document.getElementById('friends-list');
            const friends = userData.friends || [];
            if (friends.length === 0) {
                fl.innerHTML = '> no friends';
            } else {
                fl.innerHTML = friends.map(f => `<div class="friend" data-user="${f}" style="cursor: pointer;">> ${f}</div>`).join('');
                document.querySelectorAll('.friend').forEach(el => {
                    el.onclick = () => {
                        selectedFriend = el.dataset.user;
                        document.getElementById('call-btn').style.display = 'block';
                        refreshChat();
                        document.getElementById('message-input').focus();
                    };
                });
            }

            const pl = document.getElementById('pending-list');
            const pending = userData.pendingRequests || [];
            if (pending.length === 0) {
                pl.innerHTML = '';
            } else {
                pl.innerHTML = pending.map(p => `
> ${p} <button class="button accept" data-user="${p}">accept</button>
